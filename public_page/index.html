<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ƒê·ªïi M·∫∑t AI - RoosterX Global Viet Nam</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
color: #333;
}

.app {
width: 100%;
padding: 10px;
}

.reset-btn {
background: rgba(255,255,255,0.2);
color: white;
border: 2px solid rgba(255,255,255,0.3);
padding: 8px 16px;
border-radius: 25px;
cursor: pointer;
font-size: 14px;
position: absolute;
top: 10px;
right: 10px;
}

.header {
text-align: center;
margin-bottom: 20px;
color: white;
}

.header h1 {
font-size: 2rem;
margin-bottom: 10px;
}

.header .subtitle {
font-size: 1rem;
opacity: 0.9;
}

.progress-steps {
display: flex;
justify-content: center;
margin: 15px 0;
gap: 8px;
}

.step {
display: flex;
align-items: center;
gap: 6px;
padding: 6px 12px;
border-radius: 15px;
font-size: 0.85rem;
}

.step.completed {
background: #28a745;
color: white;
}

.step.active {
background: #667eea;
color: white;
}

.step.pending {
background: #f8f9fa;
color: #666;
}

.step-icon {
width: 14px;
height: 14px;
border-radius: 50%;
background: currentColor;
display: flex;
align-items: center;
justify-content: center;
font-size: 9px;
font-weight: bold;
}

.comparison-grid {
display: grid;
grid-template-columns: 1fr 1fr;
grid-template-rows: auto auto;
gap: 15px;
margin-bottom: 20px;
}

.grid-item {
background: white;
border-radius: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
overflow: hidden;
}

.selfie-panel, .preset-panel {
grid-column: span 1;
}

.result-panel {
grid-column: span 2;
min-height: 400px;
}

.panel-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 12px 16px;
display: flex;
justify-content: space-between;
align-items: center;
}

.panel-title {
font-size: 1rem;
font-weight: 600;
}

.panel-status {
font-size: 0.8rem;
opacity: 0.8;
}

.preset-options {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
margin: 15px;
}

.preset-option {
padding: 20px 10px;
text-align: center;
border: 2px dashed #ddd;
border-radius: 8px;
cursor: pointer;
min-height: 120px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.preset-option:hover {
border-color: #667eea;
background: rgba(102, 126, 234, 0.05);
}

.upload-zone {
padding: 30px 15px;
text-align: center;
border: 2px dashed #ddd;
border-radius: 8px;
margin: 15px;
cursor: pointer;
min-height: 150px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.upload-zone:hover, .upload-zone.dragover {
border-color: #667eea;
background: rgba(102, 126, 234, 0.05);
}

.upload-icon {
font-size: 2rem;
margin-bottom: 10px;
opacity: 0.6;
}

.upload-text {
font-size: 0.9rem;
margin-bottom: 6px;
color: #666;
}

.upload-subtext {
font-size: 0.7rem;
color: #999;
}

.image-preview {
padding: 15px;
text-align: center;
}

.image-preview img {
max-width: 100%;
max-height: 250px;
border-radius: 8px;
object-fit: cover;
}

.collections-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
gap: 12px;
padding: 15px;
}

.collection-card {
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
cursor: pointer;
}

.collection-image {
width: 100%;
height: 120px;
object-fit: cover;
}

.collection-info {
padding: 15px;
}

.collection-name {
font-weight: 600;
margin-bottom: 5px;
font-size: 0.9rem;
}

.collection-count {
color: #666;
font-size: 0.8rem;
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.8);
z-index: 1000;
}

.modal.show {
display: flex;
justify-content: center;
align-items: center;
}

.modal-content {
background: white;
border-radius: 10px;
max-width: 95vw;
max-height: 95vh;
overflow: hidden;
width: 100%;
margin: 10px;
}

.modal-header {
padding: 15px;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
}

.modal-title {
font-size: 1.3rem;
font-weight: 600;
}

.modal-close {
background: none;
border: none;
font-size: 1.5rem;
cursor: pointer;
padding: 5px;
border-radius: 50%;
width: 30px;
height: 30px;
display: flex;
align-items: center;
justify-content: center;
}

.modal-close:hover {
background: #f5f5f5;
}

.modal-body {
padding: 15px;
max-height: 75vh;
overflow-y: auto;
}

.preset-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
gap: 12px;
}

.preset-item {
border-radius: 8px;
overflow: hidden;
cursor: pointer;
border: 3px solid transparent;
}

.preset-item.selected {
border-color: #667eea;
}

.preset-image {
width: 100%;
height: 120px;
object-fit: cover;
}

.generate-btn {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border: none;
padding: 12px 30px;
border-radius: 20px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
margin: 15px auto;
display: block;
}

.generate-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 2000;
}

.loading-overlay.show {
display: flex;
}

.loading-content {
background: white;
padding: 30px;
border-radius: 10px;
text-align: center;
}

.loading-spinner {
width: 40px;
height: 40px;
border: 3px solid #f3f3f3;
border-top: 3px solid #667eea;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 15px;
}

.history-section {
background: white;
border-radius: 10px;
padding: 20px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
margin-top: 20px;
}

.history-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}

.history-title {
font-size: 1.3rem;
font-weight: 600;
color: #333;
}

.history-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
gap: 12px;
}

.history-item {
border-radius: 8px;
overflow: hidden;
cursor: pointer;
position: relative;
}

.history-image {
width: 100%;
height: 120px;
object-fit: cover;
}

.history-overlay {
position: absolute;
bottom: 0;
left: 0;
right: 0;
background: linear-gradient(transparent, rgba(0,0,0,0.7));
color: white;
padding: 10px;
font-size: 0.8rem;
}

.preset-name-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.8);
z-index: 1000;
justify-content: center;
align-items: center;
}

.preset-name-modal.show {
display: flex;
}

.preset-name-content {
background: white;
border-radius: 10px;
padding: 30px;
max-width: 500px;
width: 90%;
position: relative;
}

.preset-name-input {
width: 100%;
padding: 10px;
border: 2px solid #ddd;
border-radius: 6px;
font-size: 1rem;
}

.preview-placeholder {
color: #999;
font-size: 0.85em;
padding: 20px;
border: 2px dashed #ddd;
border-radius: 8px;
margin-top: 10px;
text-align: center;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
.app {
padding: 5px;
}

.comparison-grid {
grid-template-columns: 1fr;
grid-template-rows: auto auto auto;
gap: 10px;
}

.selfie-panel, .preset-panel, .result-panel {
grid-column: span 1;
}

.header h1 {
font-size: 1.8rem;
}

.header {
margin-bottom: 15px;
}

.collections-grid, .preset-grid {
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 10px;
}

.preset-options {
grid-template-columns: 1fr;
gap: 8px;
}

.modal-content {
margin: 5px;
max-width: 98vw;
}

.progress-steps {
margin: 10px 0;
gap: 5px;
}

.step {
font-size: 0.8rem;
padding: 5px 10px;
}
}

/* Modern drag-and-drop file upload styles */
.file-upload-zone {
border: 2px dashed #ccc;
border-radius: 12px;
padding: 40px 20px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
background: #fafafa;
margin-bottom: 15px;
}

.file-upload-zone:hover {
border-color: #667eea;
background: #f0f8ff;
transform: translateY(-2px);
}

.file-upload-zone.dragover {
border-color: #667eea;
background: #e3f2fd;
transform: scale(1.02);
}

.upload-icon-large {
font-size: 48px;
margin-bottom: 15px;
opacity: 0.7;
}

.upload-text-large {
font-size: 18px;
font-weight: 600;
color: #333;
margin-bottom: 8px;
}

.upload-subtext-large {
font-size: 14px;
color: #666;
margin-bottom: 5px;
}

.upload-hint {
font-size: 12px;
color: #888;
font-style: italic;
}

/* File preview styles */
.file-preview-container {
background: #f8f9fa;
border-radius: 8px;
padding: 15px;
border: 1px solid #e9ecef;
}

.file-preview-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
font-size: 14px;
font-weight: 600;
}

.clear-files-btn {
background: none;
border: none;
color: #dc3545;
cursor: pointer;
font-size: 12px;
text-decoration: underline;
}

.clear-files-btn:hover {
color: #c82333;
}

.file-preview-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
gap: 10px;
max-height: 200px;
overflow-y: auto;
}

.file-preview-item {
position: relative;
border-radius: 6px;
overflow: hidden;
aspect-ratio: 1;
background: #fff;
border: 1px solid #ddd;
}

.file-preview-item img {
width: 100%;
height: 100%;
object-fit: cover;
}

.file-preview-item .remove-file {
position: absolute;
top: 2px;
right: 2px;
background: rgba(0, 0, 0, 0.7);
color: white;
border: none;
border-radius: 50%;
width: 20px;
height: 20px;
font-size: 12px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}

.file-preview-item .remove-file:hover {
background: rgba(220, 53, 69, 0.9);
}
</style>
</head>
<body>
<div class="app">
<div class="header">
<h1>üé≠ ƒê·ªïi M·∫∑t AI</h1>
<div class="subtitle">So s√°nh ·∫£nh g·ªëc v·ªõi k·∫øt qu·∫£ AI</div>
</div>


<div class="comparison-grid">
<div class="grid-item selfie-panel">
<div class="panel-header">
<div class="panel-title">üì∏ ·∫¢nh Selfie</div>
<div class="panel-status" id="selfie-status">Ch∆∞a ch·ªçn</div>
</div>
<div class="upload-zone" id="selfie-upload" onclick="triggerFileInput('selfie-input')">
<div class="upload-icon">üì∑</div>
<div class="upload-text">Nh·∫•n ƒë·ªÉ t·∫£i l√™n ho·∫∑c k√©o th·∫£</div>
<div class="upload-subtext">JPG, PNG, WebP t·ªëi ƒëa 10MB</div>
<input type="file" id="selfie-input" accept="image/*" style="display: none;">
</div>
<div class="preset-grid" id="selfies-grid" style="margin-top: 15px; display: none;">
<!-- Previously uploaded selfies will be shown here -->
</div>
<div class="image-preview" id="selfie-preview" style="display: none;"></div>
</div>

<div class="grid-item preset-panel">
<div class="panel-header">
<div class="panel-title">üé≠ ·∫¢nh Preset</div>
<div class="panel-status" id="preset-status">Ch∆∞a ch·ªçn</div>
</div>
<div class="preset-grid" id="presets-grid" style="margin-top: 15px;">
<!-- Presets will be shown here -->
</div>
<div class="image-preview" id="preset-preview" style="display: none;"></div>
</div>

<div class="grid-item result-panel">
<div class="panel-header">
<div class="panel-title">‚ú® K·∫øt Qu·∫£ ƒê·ªïi M·∫∑t</div>
<div class="panel-status" id="result-status">ƒêang ch·ªù t·∫°o</div>
</div>
<div class="image-preview" id="result-preview" style="display: none;">
<div style="padding: 60px; color: #999; font-style: italic;">
K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi t·∫°o
</div>
</div>
</div>
</div>

<button class="generate-btn" id="generate-btn" onclick="generateFaceSwap()" disabled>
üöÄ T·∫°o ƒê·ªïi M·∫∑t
</button>

<div class="history-section">
<div class="history-header">
<div class="history-title">üìö K·∫øt Qu·∫£ G·∫ßn ƒê√¢y</div>
<button class="reset-btn" style="position: static; margin: 0;" onclick="clearHistory()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
</div>
<div class="history-grid" id="history-grid">
<!-- History items will be populated here -->
</div>
</div>
</div>


<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
<div class="loading-content">
<div class="loading-spinner"></div>
<div id="loading-text">ƒêang x·ª≠ l√Ω ƒë·ªïi m·∫∑t...</div>
<div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
C√≥ th·ªÉ m·∫•t 10-30 gi√¢y
</div>
</div>
</div>

<script>
const WORKER_URL = 'https://ai-faceswap-backend.chungminhtu03.workers.dev';

let selectedPreset = null;
let selfieImageUrl = null;
let selectedSelfieId = null;
let presets = [];
let results = [];
let selfies = [];

// Helper function to safely extract image URL from images array
function getImageUrl(imageData) {
if (!imageData) return '';
let url = '';
if (typeof imageData === 'string') {
url = imageData;
} else if (typeof imageData === 'object' && imageData !== null) {
url = imageData.url || imageData.image_url || imageData.imageUrl || '';
} else {
url = String(imageData || '');
}

// Ensure it's a full URL - if it's a relative path, make it absolute
if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
// If it starts with /, it's a path on the worker
if (url.startsWith('/')) {
url = `${WORKER_URL}${url}`;
} else {
// Otherwise, assume it's an R2 path
url = `${WORKER_URL}/r2/${url}`;
}
}

return url;
}

// Global functions for HTML onclick handlers
function triggerFileInput(inputId) {
document.getElementById(inputId).click();
}

async function loadPresets() {
try {
console.log('Loading presets from:', `${WORKER_URL}/presets`);
const response = await fetch(`${WORKER_URL}/presets`);

if (!response.ok) {
throw new Error(`HTTP ${response.status}: ${response.statusText}`);
}

const data = await response.json();
console.log('Presets data:', data);
presets = data.preset_collections || [];
console.log(`Loaded ${presets.length} presets`);
renderPresetsGrid();
} catch (error) {
console.error('Error loading presets:', error);
renderPresetsGrid();
}
}

function renderPresetsGrid() {
const grid = document.getElementById('presets-grid');
if (!grid) return;

if (presets.length === 0) {
grid.innerHTML = '<div class="preview-placeholder">Ch∆∞a c√≥ ·∫£nh preset.</div>';
return;
}

const validPresets = presets.filter(preset => preset.images && preset.images.length > 0);

if (validPresets.length === 0) {
grid.innerHTML = '<div class="preview-placeholder">Ch∆∞a c√≥ ·∫£nh preset h·ª£p l·ªá.</div>';
return;
}

grid.innerHTML = validPresets.map(preset => {
let imageUrl = getImageUrl(preset.images[0]);
if (imageUrl && imageUrl.includes('/upload-proxy/')) {
imageUrl = imageUrl.replace('/upload-proxy/', '/r2/');
}

return `
<div class="preset-item ${selectedPreset?.id === preset.id ? 'selected' : ''}"
onclick="selectPreset('${preset.id}')"
title="${preset.name}">
<img src="${imageUrl}" alt="${preset.name}" class="preset-image"
onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ddd\' width=\'100\' height=\'100\'%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EL·ªói%3C/text%3E%3C/svg%3E';">
</div>
`;
}).join('');
}

function selectPreset(presetId) {
selectedPreset = presets.find(p => p.id === presetId);
if (!selectedPreset || !selectedPreset.images || selectedPreset.images.length === 0) {
alert('·∫¢nh preset n√†y kh√¥ng h·ª£p l·ªá');
return;
}

// Update grid selection
document.querySelectorAll('#presets-grid .preset-item').forEach(item => {
item.classList.remove('selected');
});
event.currentTarget.classList.add('selected');

// Show selected preset
const preview = document.getElementById('preset-preview');
if (preview) {
preview.style.display = 'block';
let imageUrl = getImageUrl(selectedPreset.images[0]);
if (imageUrl && imageUrl.includes('/upload-proxy/')) {
imageUrl = imageUrl.replace('/upload-proxy/', '/r2/');
}
preview.innerHTML = `<img src="${imageUrl}" alt="${selectedPreset.name}" style="max-width: 100%; max-height: 250px; border-radius: 8px; object-fit: cover;">`;
document.getElementById('preset-status').textContent = `‚úì ƒê√£ ch·ªçn: ${selectedPreset.name}`;
}

updateGenerateButton();
}

async function loadResults() {
try {
const response = await fetch(`${WORKER_URL}/results`);
const data = await response.json();
results = data.results || [];
renderHistory();
} catch (error) {
console.error('Error loading results:', error);
}
}

function renderHistory() {
const grid = document.getElementById('history-grid');
if (results.length === 0) {
grid.innerHTML = '<div class="preview-placeholder">Ch∆∞a c√≥ k·∫øt qu·∫£</div>';
return;
}

grid.innerHTML = results.map(result => {
const date = new Date(result.created_at).toLocaleDateString('vi-VN');
return `
<div class="history-item">
<img src="${result.result_url}" alt="K·∫øt qu·∫£" class="history-image">
<div class="history-overlay">
<div>${result.preset_name}</div>
<div>${date}</div>
</div>
</div>
`;
}).join('');
}

// Selfie upload
document.getElementById('selfie-input').addEventListener('change', async function(e) {
const file = e.target.files[0];
if (!file) return;

const preview = document.getElementById('selfie-preview');
const uploadZone = document.getElementById('selfie-upload');

uploadZone.style.display = 'none';
preview.style.display = 'block';
preview.innerHTML = `<img src="" alt="Selfie" style="max-width: 100%; max-height: 250px; border-radius: 8px; object-fit: cover;">`;

const reader = new FileReader();
reader.onload = function(e) {
preview.querySelector('img').src = e.target.result;
document.getElementById('selfie-status').textContent = 'ƒêang t·∫£i l√™n...';
};
reader.readAsDataURL(file);

try {
// Sanitize filename
const originalName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
const timestamp = Date.now();
const randomStr = Math.random().toString(36).substring(2, 15);
const extension = originalName.split('.').pop() || 'jpg';
const filename = `selfie-${timestamp}-${randomStr}.${extension}`;

const uploadUrlResponse = await fetch(`${WORKER_URL}/upload-url`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ filename, type: 'selfie' })
});

if (!uploadUrlResponse.ok) throw new Error('Kh√¥ng th·ªÉ l·∫•y URL upload');

const { uploadUrl, publicUrl } = await uploadUrlResponse.json();

const uploadResponse = await fetch(uploadUrl, {
method: 'PUT',
body: file,
headers: { 'Content-Type': file.type }
});

if (!uploadResponse.ok) throw new Error('Upload th·∫•t b·∫°i');

// Get response which may include selfieId
const uploadResult = await uploadResponse.json();
console.log('Upload response:', uploadResult);

// Construct the full URL for the uploaded selfie
// uploadUrl is like: https://...workers.dev/upload-proxy/selfie/filename.jpg
// We need: https://...workers.dev/r2/selfie/filename.jpg
let uploadedKey = uploadUrl.replace(/^https?:\/\/[^\/]+/, ''); // Remove domain, keep path
uploadedKey = uploadedKey.replace('/upload-proxy/', '/r2/'); // Convert to R2 path
selfieImageUrl = `${WORKER_URL}${uploadedKey}`;

// Store selfieId if returned from backend
if (uploadResult.selfieId) {
selectedSelfieId = uploadResult.selfieId;
}

console.log('Selfie uploaded successfully:', {
uploadUrl: uploadUrl,
constructedUrl: selfieImageUrl,
selfieId: selectedSelfieId,
key: uploadedKey
});

// Reload selfies list to include the new upload
await loadSelfies();

// Update UI after successful upload
document.getElementById('selfie-status').textContent = '‚úì ƒê√£ t·∫£i l√™n';
document.getElementById('selfies-grid').style.display = 'grid';
updateGenerateButton();

} catch (error) {
document.getElementById('selfie-status').textContent = `‚úó L·ªói: ${error.message}`;
}
});


// Generate face swap
function generateFaceSwap() {
if (!selectedPreset || !selfieImageUrl) {
alert('Vui l√≤ng ch·ªçn c·∫£ selfie v√† preset');
return;
}

const loading = document.getElementById('loading-overlay');
loading.classList.add('show');

generateFaceSwapLogic();
}

async function generateFaceSwapLogic() {
const loading = document.getElementById('loading-overlay');
try {
if (!selectedPreset || !selectedPreset.images || selectedPreset.images.length === 0) {
throw new Error('Preset kh√¥ng h·ª£p l·ªá');
}

if (!selfieImageUrl) {
throw new Error('Selfie ch∆∞a ƒë∆∞·ª£c t·∫£i l√™n');
}

const targetUrl = getImageUrl(selectedPreset.images[0]);

// Ensure both URLs are full URLs
const finalTargetUrl = targetUrl.startsWith('http') ? targetUrl : `${WORKER_URL}${targetUrl.startsWith('/') ? '' : '/'}${targetUrl}`;
const finalSourceUrl = selfieImageUrl.startsWith('http') ? selfieImageUrl : `${WORKER_URL}${selfieImageUrl.startsWith('/') ? '' : '/'}${selfieImageUrl}`;

const requestBody = {
target_url: finalTargetUrl,
source_url: finalSourceUrl
};

console.log('Generating face swap API call:', {
url: `${WORKER_URL}/faceswap`,
requestBody: requestBody,
preset_id: selectedPreset.id,
preset_name: selectedPreset.name
});

const response = await fetch(`${WORKER_URL}/faceswap`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(requestBody)
});

const data = await response.json();
console.log('Face swap response:', data);

if (!response.ok || !data.Success) {
throw new Error(data.Message || 'ƒê·ªïi m·∫∑t th·∫•t b·∫°i');
}

if (data.ResultImageUrl) {
const preview = document.getElementById('result-preview');
preview.style.display = 'block';
let resultUrl = data.ResultImageUrl;
// Transform URL if needed (upload-proxy to /r2/)
if (resultUrl.includes('/upload-proxy/')) {
resultUrl = resultUrl.replace('/upload-proxy/', '/r2/');
}
preview.innerHTML = `<img src="${resultUrl}" alt="K·∫øt qu·∫£" style="max-width: 100%; max-height: 400px; border-radius: 8px; object-fit: cover;">`;
document.getElementById('result-status').textContent = '‚úì Ho√†n th√†nh';
await loadResults();
} else {
throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ·∫£nh k·∫øt qu·∫£');
}
} catch (error) {
console.error('Face swap error:', error);
document.getElementById('result-status').textContent = `‚úó L·ªói: ${error.message}`;
alert(`L·ªói: ${error.message}`);
} finally {
loading.classList.remove('show');
}
}

function clearHistory() {
if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ k·∫øt qu·∫£?')) {
document.getElementById('history-grid').innerHTML = '<div class="preview-placeholder">Ch∆∞a c√≥ k·∫øt qu·∫£</div>';
}
}

async function loadResults() {
try {
const response = await fetch(`${WORKER_URL}/results`);
const data = await response.json();
results = data.results || [];
renderHistory();
} catch (error) {
console.error('Error loading results:', error);
}
}

function renderHistory() {
const grid = document.getElementById('history-grid');
if (results.length === 0) {
grid.innerHTML = '<div class="preview-placeholder">Ch∆∞a c√≥ k·∫øt qu·∫£</div>';
return;
}

grid.innerHTML = results.map(result => {
const date = new Date(result.created_at).toLocaleDateString('vi-VN');
return `
<div class="history-item">
<img src="${result.result_url}" alt="K·∫øt qu·∫£" class="history-image">
<div class="history-overlay">
<div>${result.preset_name}</div>
<div>${date}</div>
</div>
</div>
`;
}).join('');
}

// Utility functions
function updateGenerateButton() {
const isEnabled = !!(selectedPreset && selfieImageUrl);
console.log('Update generate button:', {
hasPreset: !!selectedPreset,
hasSelfieUrl: !!selfieImageUrl,
enabled: isEnabled
});
document.getElementById('generate-btn').disabled = !isEnabled;
}

// Load previously uploaded selfies from database
async function loadSelfies() {
try {
const response = await fetch(`${WORKER_URL}/selfies`);
const data = await response.json();
selfies = data.selfies || [];
console.log(`Loaded ${selfies.length} selfies`);
renderSelfiesGrid();
} catch (error) {
console.error('Error loading selfies:', error);
selfies = [];
renderSelfiesGrid();
}
}

function renderSelfiesGrid() {
const grid = document.getElementById('selfies-grid');
if (!grid) return;

if (selfies.length === 0) {
grid.style.display = 'none';
return;
}

grid.style.display = 'grid';
grid.innerHTML = selfies.map(selfie => {
let imageUrl = selfie.image_url;
if (imageUrl.includes('/upload-proxy/')) {
imageUrl = imageUrl.replace('/upload-proxy/', '/r2/');
}
if (!imageUrl.startsWith('http')) {
imageUrl = `${WORKER_URL}${imageUrl.startsWith('/') ? '' : '/'}${imageUrl}`;
}

return `
<div class="preset-item ${selectedSelfieId === selfie.id ? 'selected' : ''}"
onclick="selectSelfie('${selfie.id}')"
title="${selfie.filename}">
<img src="${imageUrl}" alt="${selfie.filename}" class="preset-image"
onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ddd\' width=\'100\' height=\'100\'%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EL·ªói%3C/text%3E%3C/svg%3E';">
</div>
`;
}).join('');
}

function selectSelfie(selfieId) {
const selfie = selfies.find(s => s.id === selfieId);
if (!selfie) return;

selectedSelfieId = selfieId;
selfieImageUrl = selfie.image_url;

// Ensure full URL for API calls
if (!selfieImageUrl.startsWith('http')) {
selfieImageUrl = `${WORKER_URL}${selfieImageUrl.startsWith('/') ? '' : '/'}${selfieImageUrl}`;
}

// Update grid selection
document.querySelectorAll('#selfies-grid .preset-item').forEach(item => {
item.classList.remove('selected');
});
event.currentTarget.classList.add('selected');

// Update preview
const preview = document.getElementById('selfie-preview');
const uploadZone = document.getElementById('selfie-upload');

if (preview && uploadZone) {
uploadZone.style.display = 'none';
preview.style.display = 'block';

let imageUrl = selfie.image_url;
if (imageUrl.includes('/upload-proxy/')) {
imageUrl = imageUrl.replace('/upload-proxy/', '/r2/');
}
if (!imageUrl.startsWith('http')) {
imageUrl = `${WORKER_URL}${imageUrl.startsWith('/') ? '' : '/'}${imageUrl}`;
}

preview.innerHTML = `<img src="${imageUrl}" alt="Selfie" style="max-width: 100%; max-height: 250px; border-radius: 8px; object-fit: cover;">`;
document.getElementById('selfie-status').textContent = '‚úì ƒê√£ ch·ªçn';
}

updateGenerateButton();
}

// Initialize
loadPresets();
loadResults();
loadSelfies();
</script>
</body>
</html>