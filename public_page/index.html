<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Swap AI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px; margin-bottom: 20px; }
        .header h1 { font-size: 2em; margin-bottom: 5px; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid .result { grid-column: 1 / -1; }

        .panel { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .panel h3 { color: #667eea; margin-bottom: 15px; font-size: 1.2em; }

        .upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 40px 20px; cursor: pointer; transition: all 0.3s; background: #fafafa; }
        .upload-area:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .file-input { display: none; }

        .preview { max-width: 100%; max-height: 200px; border-radius: 8px; display: none; margin: 10px 0; }
        .preview.show { display: block; }

        .placeholder { color: #999; font-size: 0.9em; }
        .placeholder .icon { font-size: 2em; margin-bottom: 10px; }

        .collections { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .collection-card { border: 2px solid #ddd; border-radius: 8px; padding: 10px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .collection-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .collection-card img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }
        .collection-card .name { font-weight: bold; margin: 5px 0; }
        .collection-card .count { color: #666; font-size: 0.8em; }

        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .modal-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .modal-image { border: 2px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.3s; }
        .modal-image:hover { border-color: #667eea; }
        .modal-image.selected { border-color: #764ba2; transform: scale(1.05); }
        .modal-image img { width: 100%; height: 100px; object-fit: cover; }

        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 10px 5px; transition: all 0.3s; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error { background: #fee; color: #c33; padding: 10px; border-radius: 8px; margin: 10px 0; display: none; }
        .error.show { display: block; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .grid .result { grid-column: 1; } .container { padding: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ­ Face Swap AI</h1>
            <div class="subtitle">Compare originals with results</div>
        </div>

        <div class="collections" id="collections"></div>

        <div class="grid">
            <div class="panel">
                <h3>ðŸ“¸ Selfie Selected</h3>
                <div class="placeholder" id="selfiePlaceholder">
                    <div class="icon">ðŸ“·</div>
                    <div>Upload a selfie to get started</div>
                </div>
                <img class="preview" id="selfiePreview" alt="Selected selfie">
                <div class="upload-area" id="selfieUpload">
                    <input type="file" class="file-input" id="selfieFile" accept="image/*">
                    Choose Selfie Image
                </div>
            </div>

            <div class="panel">
                <h3>ðŸŽ­ Preset Selected</h3>
                <div class="placeholder" id="presetPlaceholder">
                    <div class="icon">ðŸŽ­</div>
                    <div>Click a collection above to select an image</div>
                </div>
                <img class="preview" id="presetPreview" alt="Selected preset">
            </div>

            <div class="panel result">
                <h3>âœ¨ Face Swap Result</h3>
                <div class="placeholder" id="resultPlaceholder">
                    <div class="icon">ðŸŽ­</div>
                    <div>Select images above and click Generate</div>
                </div>
                <img class="preview" id="resultImage" alt="Face swap result">

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Generating face swap...</div>
                </div>

                <div class="error" id="error"></div>

                <button class="btn" id="generateBtn" disabled>Generate Face Swap</button>
                <button class="btn" id="resetBtn" style="display: none;">Reset</button>
            </div>
        </div>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select Image</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-images" id="modalImages"></div>
        </div>
    </div>

    <script>
        const API = 'https://ai-faceswap-backend.chungminhtu03.workers.dev';
        let preset = null, selfieUrl = null, collections = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadCollections();
            setupEvents();
        });

        function $(s) { return document.querySelector(s); }
        function $$(s) { return document.querySelectorAll(s); }

        function setupEvents() {
            $('#selfieUpload').onclick = () => $('#selfieFile').click();
            $('#selfieFile').onchange = handleSelfieUpload;
            $('#generateBtn').onclick = generateFaceSwap;
            $('#resetBtn').onclick = reset;

            // Drag & drop
            const upload = $('#selfieUpload');
            upload.ondragover = e => { e.preventDefault(); upload.classList.add('dragover'); };
            upload.ondragleave = () => upload.classList.remove('dragover');
            upload.ondrop = e => {
                e.preventDefault(); upload.classList.remove('dragover');
                $('#selfieFile').files = e.dataTransfer.files;
                handleSelfieUpload();
            };
        }

        async function loadCollections() {
            try {
                const res = await fetch(`${API}/presets`);
                const data = await res.json();
                collections = data.preset_collections || [];
                renderCollections();
            } catch (e) { console.error(e); }
        }

        function renderCollections() {
            const container = $('#collections');
            container.innerHTML = collections.length ?
                collections.map(c => `
                    <div class="collection-card" onclick="openCollection('${c.id}', '${c.name.replace(/'/g, "\\'")}')">
                        <img src="${c.images[0]?.image_url || ''}" alt="${c.name}" onerror="this.style.display='none'">
                        <div class="name">${c.name}</div>
                        <div class="count">${c.images.length} images</div>
                    </div>
                `).join('') :
                '<div style="text-align: center; color: #999; padding: 40px;">No collections available</div>';
        }

        function openCollection(id, name) {
            const c = collections.find(x => x.id === id);
            if (!c) return;

            $('#modalTitle').textContent = name;
            $('#modalImages').innerHTML = c.images.map(img => `
                <div class="modal-image" onclick="selectImage('${img.id}', '${img.image_url.replace(/'/g, "\\'")}', '${id}', '${name.replace(/'/g, "\\'")}')">
                    <img src="${img.image_url}" alt="Preset">
                </div>
            `).join('');
            $('#imageModal').classList.add('show');
        }

        function selectImage(id, url, collectionId, name) {
            preset = { id, imageUrl: url, collectionId, collectionName: name };
            $('#presetPreview').src = url;
            $('#presetPreview').classList.add('show');
            $('#presetPlaceholder').style.display = 'none';
            $('#imageModal').classList.remove('show');
            updateBtn();
        }

        function closeModal() { $('#imageModal').classList.remove('show'); }

        async function handleSelfieUpload() {
            const file = $('#selfieFile').files[0];
            if (!file) return;

            try {
                const filename = `selfie_${Date.now()}_${Math.random().toString(36).substring(2, 8)}.jpg`;
                const res = await fetch(`${API}/upload-url?filename=${filename}&type=selfie`);
                const uploadData = await res.json();
                await fetch(uploadData.uploadUrl, { method: 'PUT', body: file });

                selfieUrl = uploadData.publicUrl;
                const reader = new FileReader();
                reader.onload = e => {
                    $('#selfiePreview').src = e.target.result;
                    $('#selfiePreview').classList.add('show');
                    $('#selfiePlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
                updateBtn();
            } catch (e) { showError('Upload failed'); }
        }

        function updateBtn() { $('#generateBtn').disabled = !(preset && selfieUrl); }

        async function generateFaceSwap() {
            if (!preset || !selfieUrl) return;

            $('#loading').classList.add('show');
            $('#generateBtn').disabled = true;
            $('#resultPlaceholder').style.display = 'none';
            $('#error').classList.remove('show');

            try {
                const res = await fetch(`${API}/faceswap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_url: preset.imageUrl,
                        source_url: selfieUrl,
                        preset_image_id: preset.id,
                        preset_collection_id: preset.collectionId,
                        preset_name: preset.collectionName
                    })
                });
                const data = await res.json();

                if (data.Success || data.success) {
                    const url = data.ResultImageUrl || data.result_url || data.url;
                    $('#resultImage').src = url;
                    $('#resultImage').classList.add('show');
                    $('#resetBtn').style.display = 'inline-block';
                } else throw new Error(data.Message || 'Face swap failed');
            } catch (e) {
                showError(e.message || 'Face swap failed');
            } finally {
                $('#loading').classList.remove('show');
                $('#generateBtn').disabled = false;
            }
        }

        function reset() {
            preset = null; selfieUrl = null;
            $$('.preview').forEach(el => el.classList.remove('show'));
            $$('.placeholder').forEach(el => el.style.display = 'block');
            $('#resultPlaceholder').style.display = 'block';
            $('#resetBtn').style.display = 'none';
            $('#error').classList.remove('show');
            $('#selfieFile').value = '';
            updateBtn();
        }

        function showError(msg) {
            $('#error').textContent = msg;
            $('#error').classList.add('show');
        }
    </script>
</body>
</html>
