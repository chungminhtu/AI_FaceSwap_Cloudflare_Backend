<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=375, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Face Swap AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-secondary: #a78bfa;
            --accent-strong: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --shadow-soft: 0 4px 20px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 8px 30px rgba(15, 23, 42, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; 
            max-width: 100vw;
            margin: 0; 
            padding: 0; 
            overflow-x: hidden;
            position: relative;
            touch-action: pan-y pan-x;
            -ms-touch-action: pan-y pan-x;
            -webkit-tap-highlight-color: transparent;
        }
        html {
            transform: scale(1);
            transform-origin: top left;
        }
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: pan-y pan-x;
        }

        body {
            font-family: 'Lexend Deca', -apple-system, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 50%, #f1f5f9 100%);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
            touch-action: pan-y pan-x;
            -ms-touch-action: pan-y pan-x;
        }

        body.locked { overflow: hidden; }
        body.locked .main-container { filter: blur(14px); pointer-events: none; user-select: none; }

        /* Access Gate */
        .access-gate {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at top, rgba(15, 11, 46, 0.85), rgba(10, 7, 30, 0.92));
            backdrop-filter: blur(18px);
            transition: opacity 0.3s, visibility 0.3s;
        }
        .access-gate.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .gate-card {
            width: min(420px, 90vw); padding: 32px; border-radius: 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 25px 60px rgba(18, 0, 56, 0.45);
            backdrop-filter: blur(26px);
            display: flex; flex-direction: column; gap: 18px; text-align: center;
        }
        .gate-title { font-size: 14px; font-weight: 700; letter-spacing: 1.2px; color: #fff; }
        .gate-subtitle { font-size: 14px; color: rgba(255,255,255,0.65); }
        .gate-input {
            width: 100%; padding: 14px 16px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(8, 3, 24, 0.35); color: #fff;
            font-size: 14px; letter-spacing: 4px; text-align: center; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .gate-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(248, 35, 135, 0.25); }
        .gate-button {
            width: 100%; height: 44px; padding: 0 24px; border-radius: 12px;
            background: linear-gradient(120deg, var(--accent), var(--accent-secondary));
            color: #fff; font-size: 14px; font-weight: 600; border: none; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .gate-button:hover { transform: translateY(-1px); box-shadow: 0 12px 25px rgba(248, 35, 135, 0.35); }
        .gate-error { min-height: 18px; font-size: 14px; color: var(--danger); }

        /* Main Layout */
        .main-container {
            width: 100%; 
            max-width: 100vw;
            padding: 8px 20px 40px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border);
            overflow-x: hidden;
            position: relative;
        }

        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .app-header h1 { font-size: 14px; font-weight: 600; color: var(--text-primary); letter-spacing: 0.3px; }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        #profile-section { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; flex-wrap: wrap; }
        #profile-section span:first-child { white-space: nowrap; }

        /* Three Column Layout: Left Sidebar | Main Content | Log Panel */
        .app-layout {
            display: grid;
            grid-template-columns: 320px 1fr 600px;
            gap: 20px;
            min-height: calc(100vh - 120px);
            transition: all 0.3s;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
        }
        .app-layout.log-hidden { grid-template-columns: 320px 1fr 0; gap: 20px 0; }
        .app-layout.log-hidden .log-panel { opacity: 0; transform: translateX(20px); pointer-events: none; overflow: hidden; padding: 0; width: 0; }

        /* Left Sidebar - Galleries */
        .sidebar-column {
            display: flex; flex-direction: column; gap: 12px;
            max-height: calc(100vh - 120px); overflow-y: auto;
        }
        .sidebar-column::-webkit-scrollbar { width: 4px; }
        .sidebar-column::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

        .sidebar-section { border: 1px solid var(--border); background: var(--bg-secondary); }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-bottom: 1px solid var(--border);
            font-weight: 600; font-size: 14px; background: var(--bg-tertiary);
        }
        .gallery-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .sidebar-content { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-content.collapsed { display: none; }

        .sidebar-gallery {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .gallery-drop-zone {
            position: relative; border: 1px dashed var(--border); background: var(--bg-primary); padding: 8px;
        }
        .gallery-drop-zone.dragover { border-color: var(--accent); border-style: solid; background: var(--bg-tertiary); }

        /* Main Content Area */
        .main-content-area { display: flex; flex-direction: column; gap: 16px; }

        .preview-panel {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 12px;
        }
        .preview-left-column { display: contents; }
        .preview-card {
            display: flex; flex-direction: column; gap: 8px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            width: 100%; overflow: hidden;
        }
        .preview-card.preset-card { grid-column: 1; grid-row: 1; min-height: 320px; }
        .preview-card.selfie-card { grid-column: 1; grid-row: 2; min-height: 320px; }
        .preview-card.result-card { grid-column: 2; grid-row: 1 / -1; min-height: 660px; }
        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary);
        }
        .preview-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .preview-image {
            flex: 1; min-height: 200px; display: flex; align-items: center; justify-content: center;
            background: var(--bg-primary); overflow: hidden; padding: 8px;
            width: 100%; max-width: 100%; box-sizing: border-box;
            position: relative;
        }
        .preview-action-badge {
            position: absolute; bottom: 8px; left: 8px; z-index: 2;
            padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.2px;
            background: rgba(0, 0, 0, 0.8); color: #fff; backdrop-filter: blur(4px);
            pointer-events: none; white-space: nowrap; line-height: 1.2;
        }
        .preview-action-badge.action-4k { background: rgba(139, 92, 246, 0.9); color: #fff; }
        .preview-action-badge.action-faceswap { background: rgba(16, 185, 129, 0.9); color: #fff; }
        .preview-action-badge.action-wedding { background: rgba(236, 72, 153, 0.9); color: #fff; }
        .preview-action-badge.action-default { background: rgba(100, 116, 139, 0.9); color: #fff; }
        .preview-card.preset-card .preview-image {
            max-height: calc(320px - 50px);
        }
        .preview-card.selfie-card .preview-image {
            max-height: calc(320px - 50px);
        }
        .preview-card.result-card .preview-image { 
            min-height: 600px;
            max-height: calc(660px - 50px);
        }
        .preview-image img { 
            max-width: 100% !important; 
            max-height: 100% !important; 
            width: auto !important; 
            height: auto !important; 
            object-fit: contain !important; 
            display: block;
            margin: 0 auto;
        }
        .preview-empty { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--text-muted); text-align: center; }
        .preview-empty-icon { font-size: 32px; opacity: 0.5; }
        .preview-empty-text { font-size: 14px; }

        /* Action Panel */
        .action-panel {
            border: 1px solid var(--border); padding: 12px 16px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 12px; background: var(--bg-secondary);
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .action-btn {
            height: 36px; padding: 0 16px; font-size: 13px; font-weight: 600;
            border: none; background: var(--accent); color: #fff; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
            transition: all 0.2s; border-radius: 12px;
        }
        .action-btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
        .action-btn.primary { background: var(--accent-strong); }
        .action-btn.primary:hover:not(:disabled) { background: var(--accent); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn.loading::after {
            content: ''; width: 12px; height: 12px; margin-left: 6px;
            border: 2px solid transparent; border-top-color: #fff;
            border-radius: 50%; animation: spin 0.6s linear infinite;
        }

        .action-options { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            align-items: center; 
            width: 100%; 
            max-width: 100%;
            overflow-x: hidden;
        }
        .action-prompt {
            flex: 1; min-width: 180px; height: 36px; padding: 0 12px;
            border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px;
            border-radius: 12px;
        }
        .action-ratio { display: flex; gap: 6px; align-items: center; }
        .action-model { display: flex; gap: 6px; align-items: center; }
        .action-aging { display: flex; gap: 6px; align-items: center; }
        .action-aging input { width: 50px; height: 36px; padding: 0 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); text-align: center; font-size: 14px; border-radius: 12px; }

        /* History/Results Panel */
        .results-panel {
            border: 1px solid var(--border); padding: 12px; background: var(--bg-secondary);
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; font-weight: 600; margin-bottom: 12px;
        }
        .results-count { font-weight: 400; color: var(--text-muted); }
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;
            max-height: 300px; overflow-y: auto;
        }

        /* Log Panel - Right Sidebar */
        .log-panel {
            background: var(--bg-secondary); border: 1px solid var(--border);
            padding: 16px; display: flex; flex-direction: column;
            position: sticky; top: 20px; max-height: calc(100vh - 120px);
            overflow: hidden; transition: opacity 0.3s, transform 0.3s;
        }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 8px; }
        .log-title { font-size: 14px; font-weight: 600; color: var(--accent-strong); flex: 1; }
        .log-toggle-btn, .log-clear-btn {
            padding: 5px 12px; border: none; cursor: pointer;
            font-size: 13px; font-weight: 600; border-radius: 12px; transition: all 0.2s;
        }
        .log-toggle-btn { background: var(--accent); color: #fff; }
        .log-toggle-btn:hover { background: var(--accent-hover); }
        .log-clear-btn { background: var(--danger); color: #fff; }
        .log-clear-btn:hover { background: #dc2626; }

        .api-log-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .api-log-entry {
            border: 1px solid var(--border); padding: 8px; background: var(--bg-primary); font-size: 12px;
        }
        .api-log-entry.log-error { border-left: 3px solid var(--danger); }
        .api-log-entry.log-success { border-left: 3px solid var(--success); }
        .api-log-entry.log-info { border-left: 3px solid var(--accent); }
        .api-log-main { font-size: 12px; color: var(--text-primary); line-height: 1.4; }
        .api-log-method { font-weight: 600; color: var(--accent); }
        .api-log-url { color: var(--text-secondary); word-break: break-all; }
        .api-log-timing { color: #666; font-size: 11px; margin-left: 6px; }
        .api-log-payload { margin-top: 6px; font-size: 11px; background: rgba(0,0,0,0.03); padding: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .api-log-curl-wrapper { margin-top: 8px; position: relative; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; }
        .api-log-curl-pre { overflow-x: auto; font-size: 11px; white-space: pre-wrap; word-wrap: break-word; word-break: break-all; margin: 0; padding-right: 60px; }
        .api-log-copy-btn { position: absolute; top: 8px; right: 8px; background: var(--accent); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; opacity: 0.8; }
        .api-log-copy-btn:hover { opacity: 1; }

        /* Gallery Items */
        .gallery-item {
            aspect-ratio: 1; overflow: hidden; background: var(--bg-primary);
            border: 1px solid var(--border); cursor: pointer; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gallery-item.selected { border-color: var(--accent); border-width: 2px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .gallery-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-soft); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-action-badge {
            position: absolute; bottom: 4px; left: 4px; z-index: 2;
            padding: 1px 3px; border-radius: 2px; font-size: 8px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1px;
            background: rgba(0, 0, 0, 0.8); color: #fff; backdrop-filter: blur(4px);
            pointer-events: none; white-space: nowrap; line-height: 1.1;
        }
        .gallery-action-badge.action-4k { background: rgba(139, 92, 246, 0.9); color: #fff; }
        .gallery-action-badge.action-faceswap { background: rgba(16, 185, 129, 0.9); color: #fff; }
        .gallery-action-badge.action-wedding { background: rgba(236, 72, 153, 0.9); color: #fff; }
        .gallery-action-badge.action-default { background: rgba(100, 116, 139, 0.9); color: #fff; }
        .gallery-delete-btn {
            position: absolute; top: 4px; right: 4px; width: 22px; height: 22px;
            background: var(--danger); color: #fff; border: none; border-radius: 12px;
            font-size: 14px; font-weight: 700; cursor: pointer; opacity: 0;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .gallery-item:hover .gallery-delete-btn { opacity: 1; }
        .gallery-delete-btn:hover { background: #dc2626; }

        .gallery-upload-btn {
            width: 28px; height: 28px; border: none; background: var(--accent);
            color: #fff; cursor: pointer; font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; transition: all 0.2s;
        }
        .gallery-upload-btn:hover { background: var(--accent-hover); transform: scale(1.1); }


        /* Pagination */
        .pagination { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 12px; }
        .pagination-btn {
            width: 32px; height: 32px; padding: 0; background: var(--accent); border: none;
            color: #fff; font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; border-radius: 12px;
        }
        .pagination-btn:hover:not(:disabled) { background: var(--accent-hover); }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination-dots { display: flex; gap: 4px; }
        .pagination-dot { width: 8px; height: 8px; background: var(--border); cursor: pointer; border-radius: 12px; }
        .pagination-dot.active { background: var(--accent); }

        /* Delete button in preview */
        .delete-btn {
            width: 24px; height: 24px; background: var(--danger); color: #fff;
            border: none; border-radius: 12px; cursor: pointer;
            font-size: 16px; font-weight: 700;
        }
        .delete-btn:hover { background: #dc2626; }

        /* Lightbox */
        .lightbox {
            position: fixed; inset: 0; z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        .lightbox-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); cursor: pointer; }
        .lightbox-content { position: relative; max-width: 95%; max-height: 95%; z-index: 10001; display: flex; flex-direction: column; align-items: center; }
        .lightbox-single { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .lightbox-content img { max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; }
        .lightbox-info { margin-top: 16px; color: #fff; font-size: 14px; }
        .lightbox-actions {
            margin-top: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;
        }
        .lightbox-action-btn {
            padding: 10px 20px; background: rgba(139, 92, 246, 0.9); border: none; border-radius: 8px;
            color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .lightbox-action-btn:hover { background: rgba(139, 92, 246, 1); transform: translateY(-2px); }
        .lightbox-action-btn:active { transform: translateY(0); }
        .lightbox-action-btn.secondary { background: rgba(59, 130, 246, 0.9); }
        .lightbox-action-btn.secondary:hover { background: rgba(59, 130, 246, 1); }
        .lightbox-action-btn.danger { background: rgba(239, 68, 68, 0.9); }
        .lightbox-action-btn.danger:hover { background: rgba(239, 68, 68, 1); }
        .lightbox-close, .lightbox-nav {
            position: absolute; width: 40px; height: 40px;
            background: rgba(255,255,255,0.2); border: none; border-radius: 12px;
            color: #fff; font-size: 28px; cursor: pointer; z-index: 10002;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .lightbox-close { top: 20px; right: 20px; }
        .lightbox-close:hover, .lightbox-nav:hover { background: rgba(255,255,255,0.3); }
        .lightbox-nav { top: 50%; transform: translateY(-50%); }
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        .lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        
        /* Comparison Mode */
        .lightbox-comparison { width: 100%; max-width: 100%; }
        .comparison-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; color: #fff;
        }
        .comparison-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .comparison-grid {
            display: grid; gap: 16px; width: 100%;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            max-height: 75vh; overflow-y: auto; padding: 10px;
        }
        .comparison-grid.compare-2 { grid-template-columns: 1fr 1fr; }
        .comparison-grid.compare-3 { grid-template-columns: 1fr 1fr 1fr; }
        .comparison-item {
            position: relative; background: rgba(255,255,255,0.1);
            border-radius: 8px; padding: 10px; display: flex; flex-direction: column;
        }
        .comparison-item img {
            width: 100%; max-height: 60vh; object-fit: contain;
            border-radius: 4px; margin-bottom: 8px;
        }
        .comparison-item-label {
            color: #fff; font-size: 12px; text-align: center;
            margin-bottom: 8px; font-weight: 500;
        }
        .comparison-item-remove {
            position: absolute; top: 5px; right: 5px;
            width: 28px; height: 28px; background: rgba(239, 68, 68, 0.9);
            border: none; border-radius: 50%; color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; z-index: 10;
        }
        .comparison-item-remove:hover { background: rgba(239, 68, 68, 1); transform: scale(1.1); }
        .comparison-actions {
            margin-top: 20px; display: flex; justify-content: center;
        }
        @media (max-width: 768px) {
            .comparison-grid.compare-2,
            .comparison-grid.compare-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 10003;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8);
        }
        .modal-content {
            background: var(--bg-primary); border-radius: 12px;
            padding: 24px; max-width: 600px; width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px;
        }
        .modal-header h2 { margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .modal-close {
            width: 32px; height: 32px; background: rgba(239, 68, 68, 0.9);
            border: none; border-radius: 8px; color: #fff; font-size: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover { background: rgba(239, 68, 68, 1); transform: scale(1.1); }
        .modal-body { color: var(--text-primary); }
        .progress-bar {
            width: 100%; height: 8px; background: var(--bg-secondary);
            border-radius: 4px; overflow: hidden; margin-top: 8px;
        }
        .progress-fill {
            height: 100%; background: var(--accent); transition: width 0.3s;
            width: 0%;
        }
        .thumbnail-item {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 8px; padding: 8px; text-align: center;
        }
        .thumbnail-item img {
            width: 100%; height: 120px; object-fit: contain;
            border-radius: 4px; margin-bottom: 8px;
        }
        .thumbnail-item-info {
            font-size: 11px; color: var(--text-muted);
            word-break: break-word;
        }
        /* Main Tabs */
        .main-tabs {
            display: flex; gap: 8px; margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        .main-tab {
            padding: 12px 24px; background: none; border: none;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            color: var(--text-secondary); font-size: 15px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .main-tab:hover {
            color: var(--accent);
        }
        .main-tab.active {
            color: var(--accent); border-bottom-color: var(--accent);
        }
        .main-tab-content {
            display: none;
        }
        .main-tab-content.active {
            display: block;
        }
        
        /* Thumbnails Tab Container */
        .thumbnails-tab-container {
            display: flex; flex-direction: column; gap: 16px;
        }
        .thumbnails-tab-header {
            margin-bottom: 8px;
        }
        .thumbnails-tabs {
            display: flex; gap: 8px;
            border-bottom: 2px solid var(--border);
        }
        .thumbnail-subtab {
            padding: 10px 20px; background: none; border: none;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            color: var(--text-secondary); font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .thumbnail-subtab:hover {
            color: var(--accent);
        }
        .thumbnail-subtab.active {
            color: var(--accent); border-bottom-color: var(--accent);
        }
        .thumbnail-subtab-content {
            display: none;
        }
        .thumbnail-subtab-content.active {
            display: block;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(253, 251, 255, 0.92);
            backdrop-filter: blur(10px); display: flex; align-items: center;
            justify-content: center; z-index: 9999;
        }
        .loading-content { background: var(--bg-secondary); border: 1px solid var(--border); padding: 24px; text-align: center; min-width: 200px; border-radius: 12px; }
        .spinner { width: 36px; height: 36px; border: 3px solid rgba(139, 92, 246, 0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin: 0 auto 12px; }
        .loading-text { font-size: 14px; color: var(--accent); font-weight: 600; }
        .loading-subtext { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .loading-timer { font-size: 16px; color: var(--accent-strong); font-weight: 700; margin-top: 8px; font-family: monospace; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast {
            pointer-events: auto; min-width: 280px; max-width: 400px;
            padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease-out;
        }
        .toast.toast-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; border-left: 4px solid #34d399; }
        .toast.toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; border-left: 4px solid #f87171; }
        .toast.toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-left: 4px solid #60a5fa; }
        .toast-content { flex: 1; font-size: 14px; }
        .toast-close { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; padding: 0; opacity: 0.8; }
        .toast-close:hover { opacity: 1; }

        /* Status Message */
        .status-message {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; font-size: 14px; border-radius: 12px; z-index: 9999;
            display: flex; align-items: center; gap: 8px; animation: slideIn 0.2s ease;
        }
        .status-success { background: rgba(43, 201, 144, 0.95); color: #fff; }
        .status-error { background: rgba(255, 77, 109, 0.95); color: #fff; }
        .status-info { background: rgba(248, 35, 135, 0.95); color: #fff; }
        .status-close { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; margin-left: 8px; }

        /* Float Toggle */
        .log-toggle-float {
            position: fixed; right: 20px; bottom: 20px; width: 50px; height: 50px;
            background: linear-gradient(120deg, var(--accent), var(--accent-secondary));
            border: none; color: #fff; font-size: 20px; cursor: pointer; border-radius: 12px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .log-toggle-float:hover { transform: scale(1.1); }
        .app-layout.log-hidden .log-toggle-float { display: flex !important; }

        .file-input { display: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Responsive */
        @media (max-width: 1400px) {
            .app-layout { grid-template-columns: 280px 1fr 500px; }
        }
        @media (max-width: 1200px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar-column { max-height: none; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .preview-panel { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
            .preview-card.preset-card { grid-column: 1; grid-row: 1; }
            .preview-card.selfie-card { grid-column: 1; grid-row: 2; }
            .preview-card.result-card { grid-column: 2; grid-row: 1 / -1; }
            .log-panel { position: relative; top: 0; max-height: 400px; margin-top: 16px; }
            .log-toggle-float { display: none !important; }
        }
        @media (max-width: 768px) {
            html, body {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                position: relative;
                touch-action: pan-y pan-x;
                -ms-touch-action: pan-y pan-x;
                -webkit-overflow-scrolling: touch;
            }
            .main-container { 
                padding: 12px; 
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            .app-layout { 
                grid-template-columns: 1fr; 
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            .app-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .header-controls { width: 100%; gap: 6px; max-width: 100%; overflow-x: hidden; }
            #profile-section { 
                font-size: 11px; 
                padding: 4px 8px; 
                gap: 4px; 
                width: 100%; 
                max-width: 100%;
            }
            #profile-section span:first-child { display: none; }
            #profile-section #profile-id-input { 
                width: 80px; 
                height: 24px; 
                font-size: 11px; 
                padding: 2px 6px; 
            }
            #profile-section #switch-profile-btn { 
                padding: 2px 8px; 
                font-size: 11px; 
                height: 24px; 
                white-space: nowrap;
            }
            #profile-section #profile-status { font-size: 11px; }
            #profile-section #profile-id-display { font-size: 10px; }
            .sidebar-column { grid-template-columns: 1fr; }
            .preview-panel { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
            .preview-card.preset-card { grid-column: 1; grid-row: 1; min-height: 250px; }
            .preview-card.selfie-card { grid-column: 1; grid-row: 2; min-height: 250px; }
            .preview-card.result-card { grid-column: 1; grid-row: 3; min-height: 400px; }
            .preview-card.result-card .preview-image { min-height: 350px; }
            .action-panel { 
                flex-direction: column; 
                align-items: stretch; 
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                padding: 12px;
            }
            .action-buttons { 
                flex-direction: column; 
                width: 100%;
                max-width: 100%;
            }
            .action-btn { 
                width: 100%; 
                max-width: 100%;
                justify-content: center; 
            }
            .action-options {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                flex-direction: column;
                align-items: stretch;
            }
            .action-prompt {
                width: 100%;
                max-width: 100%;
                min-width: 100%;
            }
            .action-ratio, .action-model {
                width: 100%;
                max-width: 100%;
            }
            .action-ratio select, .action-model select {
                width: 100%;
                max-width: 100%;
                flex: 1;
            }
            .results-grid { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            }
            * {
                max-width: 100vw;
            }
            img, video, iframe {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div id="access-gate" class="access-gate">
        <div class="gate-card">
            <div class="gate-title">Restricted Workspace</div>
            <div class="gate-subtitle">Nh·∫≠p m√£ truy c·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</div>
            <input type="password" id="access-input" class="gate-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autocapitalize="off" spellcheck="false">
            <button id="access-submit" class="gate-button">Unlock</button>
            <div id="access-error" class="gate-error"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="app-header">
            <h1>ƒê·ªïi M·∫∑t AI (Face Swap AI)</h1>
            <div class="header-controls">
                <div id="profile-section">
                    <span style="color: var(--text-secondary);">H·ªì S∆° (Profile):</span>
                    <span id="profile-status" style="color: var(--text-muted);">ƒêang t·∫£i...</span>
                    <span id="profile-info" style="display: none;">
                        <span id="profile-id-display" style="font-family: monospace; color: var(--accent); font-size: 12px;"></span>
                    </span>
                    <input type="text" id="profile-id-input" placeholder="ID Profile" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; font-family: monospace; width: 100px; height: 26px;">
                    <button id="switch-profile-btn" onclick="switchProfile()" style="padding: 4px 12px; background: var(--accent); color: #fff; border: none; cursor: pointer; font-size: 12px; height: 26px; font-weight: 600; border-radius: 12px;">Chuy·ªÉn Profile</button>
                    <button id="edit-profile-btn" onclick="openProfileEditModal()" style="padding: 4px 12px; background: rgba(59, 130, 246, 0.9); color: #fff; border: none; cursor: pointer; font-size: 12px; height: 26px; font-weight: 600; border-radius: 12px; display: none;" title="Ch·ªânh S·ª≠a H·ªì S∆°">‚úèÔ∏è S·ª≠a</button>
                </div>
                <select class="action-select" id="api-provider" style="height: 26px; padding: 0 8px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 12px;">
                    <option value="google-nano-banana" selected>Google</option>
                    <option value="rapidapi">RapidAPI</option>
                </select>
                <button class="log-toggle-btn" onclick="window.open('docs/index.html', '_blank')" style="padding: 5px 12px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; border-radius: 12px; background: var(--accent); color: #fff; transition: all 0.2s;">üìñ API Docs</button>
                <button class="log-toggle-btn" onclick="showComparisonView()" id="comparison-view-btn" style="padding: 5px 12px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; border-radius: 12px; background: rgba(59, 130, 246, 0.9); color: #fff; transition: all 0.2s;" title="Xem So S√°nh">üîç So S√°nh (<span id="comparison-count">0</span>)</button>
                <button class="log-toggle-btn" onclick="toggleLogPanel()">Nh·∫≠t K√Ω (Log)</button>
            </div>
        </div>

        <div class="app-layout">
            <!-- Left Sidebar - Galleries -->
            <div class="sidebar-column">
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <div class="gallery-title-row">
                            <span>M·∫´u (Presets)</span>
                        </div>
                        <button class="gallery-upload-btn" onclick="document.getElementById('preset-input').click()">+</button>
                        <input type="file" class="file-input" id="preset-input" accept="image/*" multiple>
                    </div>
                    <div class="sidebar-content" id="preset-sidebar-content">
                        <div class="gallery-drop-zone" id="preset-drop-zone">
                            <div id="preset-gallery" class="sidebar-gallery"></div>
                        </div>
                        <div class="pagination" id="preset-pagination" style="display: none;">
                            <button class="pagination-btn" id="preset-prev" onclick="changePage('preset', -1)">‚óÄ</button>
                            <div class="pagination-dots" id="preset-dots"></div>
                            <button class="pagination-btn" id="preset-next" onclick="changePage('preset', 1)">‚ñ∂</button>
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <span>·∫¢nh T·ª± S∆∞·ªõng (Selfies)</span>
                        <button class="gallery-upload-btn" onclick="document.getElementById('selfie-input').click()">+</button>
                        <input type="file" class="file-input" id="selfie-input" accept="image/*" multiple>
                    </div>
                    <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color);">
                        <label for="selfie-action-select" style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Action:</label>
                        <select id="selfie-action-select" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-size: 13px;">
                            <option value="faceswap" selected>Faceswap (Max 8)</option>
                            <option value="wedding">Wedding (Max 2)</option>
                            <option value="4k">4K Upscale (Max 1)</option>
                            <option value="default">Default (Max 1)</option>
                        </select>
                    </div>
                    <div class="sidebar-content" id="selfie-sidebar-content">
                        <div class="gallery-drop-zone" id="selfie-drop-zone">
                            <div id="selfie-gallery" class="sidebar-gallery"></div>
                        </div>
                        <div class="pagination" id="selfie-pagination" style="display: none;">
                            <button class="pagination-btn" id="selfie-prev" onclick="changePage('selfie', -1)">‚óÄ</button>
                            <div class="pagination-dots" id="selfie-dots"></div>
                            <button class="pagination-btn" id="selfie-next" onclick="changePage('selfie', 1)">‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content-area">
                <!-- Main Tabs -->
                <div class="main-tabs">
                    <button class="main-tab active" onclick="switchMainTab('faceswap')" id="main-tab-faceswap">
                        ‚ú® ƒê·ªïi M·∫∑t (Face Swap)
                    </button>
                    <button class="main-tab" onclick="switchMainTab('thumbnails')" id="main-tab-thumbnails">
                        üñºÔ∏è Thumbnails
                    </button>
                </div>

                <!-- Face Swap Tab Content -->
                <div id="faceswap-tab-content" class="main-tab-content active">
                    <div class="preview-panel">
                        <div class="preview-card preset-card" id="preset-card">
                            <div class="preview-header">
                                <div class="preview-label">M·∫´u (Preset)</div>
                                <button class="delete-btn" onclick="clearSelection('preset', event)" style="display: none;" id="preset-clear-btn">√ó</button>
                            </div>
                            <div id="preset-preview" class="preview-image">
                                <div class="preview-empty">
                                    <div class="preview-empty-icon">üì∑</div>
                                    <div class="preview-empty-text">Ch·ªçn t·ª´ m·∫´u (Select from presets)</div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card selfie-card" id="selfie-card">
                            <div class="preview-header">
                                <div class="preview-label">·∫¢nh T·ª± S∆∞·ªõng (Selfie) - T·ªëi ƒëa 2 cho Wedding</div>
                                <button class="delete-btn" onclick="clearSelection('selfie', event)" style="display: none;" id="selfie-clear-btn">√ó</button>
                            </div>
                            <div id="selfie-preview" class="preview-image">
                                <div class="preview-empty">
                                    <div class="preview-empty-icon">üì∑</div>
                                    <div class="preview-empty-text">Ch·ªçn t·ª´ ·∫£nh t·ª± s∆∞·ªõng (Select from selfies)</div>
                                </div>
                            </div>
                        </div>
                    <div class="preview-card result-card" id="result-card">
                        <div class="preview-header">
                            <div class="preview-label">K·∫øt Qu·∫£ (Result)</div>
                        </div>
                        <div id="result-preview" class="preview-image">
                            <div class="preview-empty">
                                <div class="preview-empty-icon">‚ú®</div>
                                <div class="preview-empty-text">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y (Result will appear here)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-panel">
                    <div class="action-buttons">
                        <button class="action-btn primary" id="generate-btn" disabled onclick="generateFaceSwap()">
                            <span>‚ú®</span><span>ƒê·ªïi M·∫∑t (Face Swap)</span>
                        </button>
                        <button class="action-btn primary" id="merge-btn" disabled onclick="generateBackground()">
                            <span>üñºÔ∏è</span><span>T·∫°o N·ªÅn (AI Background)</span>
                        </button>
                        <button class="action-btn" id="enhance-btn" disabled onclick="runEnhance()">üîç N√¢ng C·∫•p (Enhance)</button>
                        <button class="action-btn" id="beauty-btn" disabled onclick="runBeauty()">‚ú® L√†m ƒê·∫πp (Beauty)</button>
                        <button class="action-btn" id="filter-btn" disabled onclick="runFilter()">üé® B·ªô L·ªçc (Filter)</button>
                        <button class="action-btn" id="upscale4k-btn" disabled onclick="runUpscale4k()">üìê N√¢ng C·∫•p 4K (4K Upscale)</button>
                        <button class="action-btn" id="restore-btn" disabled onclick="runRestore()">üîÑ Kh√¥i Ph·ª•c (Restore)</button>
                        <div class="action-aging">
                            <input type="number" id="aging-years" value="20" min="5" max="60" step="5">
                            <button class="action-btn" id="aging-btn" disabled onclick="runAging()">‚è≥ L√£o H√≥a (Age)</button>
                        </div>
                    </div>
                    <div class="action-options">
                        <input type="text" id="additional-prompt" class="action-prompt" placeholder="G·ª£i √Ω (t√πy ch·ªçn) / T·∫°o n·ªÅn t·ª´ text (Custom Background Prompt)">
                        <div class="action-ratio">
                            <label style="font-size: 13px; color: var(--text-secondary); margin-right: 6px;">T·ª∑ L·ªá (Ratio):</label>
                            <select id="aspect-ratio" style="height: 36px; padding: 0 12px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 13px; border-radius: 12px; cursor: pointer;">
                                <option value="original" selected>Original (T·ª´ ·∫£nh selfie)</option>
                                <option value="1:1">1:1 (Square)</option>
                                <option value="3:2">3:2 (Landscape)</option>
                                <option value="2:3">2:3 (Portrait)</option>
                                <option value="3:4">3:4 (Portrait)</option>
                                <option value="4:3">4:3 (Landscape)</option>
                                <option value="4:5">4:5 (Portrait)</option>
                                <option value="5:4">5:4 (Landscape)</option>
                                <option value="9:16">9:16 (Vertical)</option>
                                <option value="16:9">16:9 (Widescreen)</option>
                                <option value="21:9">21:9 (Ultrawide)</option>
                            </select>
                        </div>
                        <div class="action-model" style="display: flex; gap: 6px; align-items: center;">
                            <label style="font-size: 13px; color: var(--text-secondary); margin-right: 6px; white-space: nowrap; font-weight: 600;">Model (Nano Banana):</label>
                            <select id="gemini-model" style="height: 36px; padding: 0 12px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 13px; border-radius: 12px; cursor: pointer; min-width: 150px; font-weight: 500;">
                                <option value="2.5" selected>2.5 Flash</option>
                                <option value="3p">3 Pro</option>
                                <option value="3f">3 Flash</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="results-panel">
                    <div class="results-header">
                        <span>L·ªãch S·ª≠ (History)</span>
                        <span class="results-count" id="results-count">(0)</span>
                    </div>
                    <div id="results-gallery" class="results-grid"></div>
                    <div class="pagination" id="results-pagination" style="display: none;">
                        <button class="pagination-btn" id="results-prev" onclick="changePage('results', -1)">‚óÄ</button>
                        <div class="pagination-dots" id="results-dots"></div>
                        <button class="pagination-btn" id="results-next" onclick="changePage('results', 1)">‚ñ∂</button>
                    </div>
                </div>
                </div>

                <!-- Thumbnails Tab Content -->
                <div id="thumbnails-tab-content" class="main-tab-content" style="display: none;">
                    <div class="thumbnails-tab-container">
                        <div class="thumbnails-tab-header">
                            <div class="thumbnails-tabs">
                                <button class="thumbnail-subtab active" onclick="switchThumbnailSubTab('upload')" id="thumbnail-subtab-upload">
                                    üì§ T·∫£i L√™n
                                </button>
                                <button class="thumbnail-subtab" onclick="switchThumbnailSubTab('view')" id="thumbnail-subtab-view">
                                    üëÅÔ∏è Xem Thumbnails
                                </button>
                            </div>
                        </div>
                        
                        <div id="thumbnails-upload-section" class="thumbnail-subtab-content active">
                            <div class="thumbnail-upload-section" style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                                <h3 style="margin-top: 0;">T·∫£i L√™n Th∆∞ M·ª•c</h3>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                                    K√©o th·∫£ th∆∞ m·ª•c ho·∫∑c file zip v√†o ƒë√¢y, ho·∫∑c ch·ªçn th∆∞ m·ª•c. T√™n file ph·∫£i theo ƒë·ªãnh d·∫°ng:<br>
                                    <code>[type]_[sub_category]_[gender]_[position].[webp|json]</code><br>
                                    V√≠ d·ª•: <code>face-swap_wedding_both_1.webp</code> ho·∫∑c <code>packs_autumn_male_1.json</code><br>
                                    Zip file s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông gi·∫£i n√©n v√† t·∫£i l√™n.
                                </p>
                                <div id="thumbnail-drop-zone" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; background: var(--bg-primary); transition: all 0.2s; margin-bottom: 16px;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">K√©o th·∫£ file zip v√†o ƒë√¢y</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">H·ªó tr·ª£ nhi·ªÅu file zip (WebP, JSON Lottie)</div>
                                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                        <button class="action-btn" onclick="event.stopPropagation(); $('thumbnail-zip-input').click();" style="padding: 8px 16px; font-size: 13px;">
                                            üì¶ Ch·ªçn File Zip
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="thumbnail-zip-input" accept=".zip" multiple style="display: none;" onchange="handleThumbnailZipSelect(event)">
                                <div id="thumbnail-upload-progress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="thumbnail-progress-fill"></div>
                                    </div>
                                    <div id="thumbnail-upload-status" style="margin-top: 8px; font-size: 12px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="thumbnails-view-section" class="thumbnail-subtab-content" style="display: none;">
                            <div class="thumbnail-list-section" style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h3 style="margin: 0;">Danh S√°ch Thumbnails</h3>
                                    <button class="action-btn" onclick="loadThumbnails()" style="padding: 6px 12px; font-size: 12px;">
                                        üîÑ L√†m M·ªõi
                                    </button>
                                </div>
                                <div id="thumbnail-list" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Panel - Right Sidebar -->
            <div class="log-panel">
                <div class="log-header">
                    <div class="log-title">üìã Nh·∫≠t K√Ω API</div>
                    <button class="log-clear-btn" onclick="clearApiLogs()">X√≥a</button>
                    <button class="log-toggle-btn" onclick="toggleLogPanel()" title="·∫®n">‚óÄ</button>
                </div>
                <div class="api-log-list" id="api-log-list"></div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" style="display: none;">
        <div class="lightbox-overlay" onclick="closeLightbox()"></div>
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <button class="lightbox-nav lightbox-prev" onclick="lightboxNavigate(-1)">‚Äπ</button>
        <button class="lightbox-nav lightbox-next" onclick="lightboxNavigate(1)">‚Ä∫</button>
        <div class="lightbox-content" id="lightbox-content">
            <div class="lightbox-single" id="lightbox-single">
                <img id="lightbox-image" src="" alt="">
                <div class="lightbox-info"><span id="lightbox-counter"></span></div>
                <div class="lightbox-actions" id="lightbox-actions" style="display: none;">
                    <button class="lightbox-action-btn" onclick="selectAsPreset()">
                        <span>üì∏</span>
                        <span>Ch·ªçn l√†m M·∫´u</span>
                    </button>
                    <button class="lightbox-action-btn secondary" onclick="selectAsSelfie()">
                        <span>üë§</span>
                        <span>Ch·ªçn l√†m Selfie</span>
                    </button>
                    <button class="lightbox-action-btn" onclick="addToComparison()" id="add-to-comparison-btn">
                        <span>‚ûï</span>
                        <span>Th√™m v√†o So S√°nh</span>
                    </button>
                </div>
            </div>
            <div class="lightbox-comparison" id="lightbox-comparison" style="display: none;">
                <div class="comparison-header">
                    <h3>So S√°nh H√¨nh ·∫¢nh</h3>
                    <button class="lightbox-action-btn danger" onclick="clearComparison()">
                        <span>üóëÔ∏è</span>
                        <span>X√≥a T·∫•t C·∫£</span>
                    </button>
                </div>
                <div class="comparison-grid" id="comparison-grid"></div>
                <div class="comparison-actions">
                    <button class="lightbox-action-btn" onclick="switchToSingleView()">
                        <span>‚Üê</span>
                        <span>Quay L·∫°i Xem ƒê∆°n</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="modal-overlay" style="display: none;" onclick="if(event.target.id === 'profile-edit-modal') closeProfileEditModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>‚úèÔ∏è Ch·ªânh S·ª≠a H·ªì S∆°</h2>
                <button class="modal-close" onclick="closeProfileEditModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="profile-edit-form" onsubmit="saveProfileEdit(event)">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary); font-weight: 500;">T√™n (Name):</label>
                        <input type="text" id="profile-edit-name" placeholder="Nh·∫≠p t√™n" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary); font-weight: 500;">Email:</label>
                        <input type="email" id="profile-edit-email" placeholder="email@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary); font-weight: 500;">URL Avatar:</label>
                        <input type="url" id="profile-edit-avatar" placeholder="https://example.com/avatar.jpg" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary); font-weight: 500;">Preferences (JSON):</label>
                        <textarea id="profile-edit-preferences" placeholder='{"theme":"dark","language":"vi"}' rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; font-family: monospace; resize: vertical;"></textarea>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">C√≥ th·ªÉ ƒë·ªÉ tr·ªëng ho·∫∑c nh·∫≠p JSON h·ª£p l·ªá</div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" onclick="closeProfileEditModal()" style="padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 14px; font-weight: 500;">H·ªßy</button>
                        <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent); color: #fff; cursor: pointer; font-size: 14px; font-weight: 600;">üíæ L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu</div>
            <div class="loading-subtext">Vui l√≤ng ch·ªù...</div>
            <div class="loading-timer" id="loading-timer">0.0s</div>
        </div>
    </div>

    <button class="log-toggle-float" id="log-toggle-float" onclick="toggleLogPanel()" title="Hi·ªán Nh·∫≠t K√Ω">üìã</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Config - Backend URL injected during deployment from deployments-secrets.json
        let WORKER_URL = 'https://api.d.shotpix.app'; // Injected during deployment - DO NOT MODIFY MANUALLY
        // Mobile API Key for authentication (set when ENABLE_MOBILE_API_KEY_AUTH is enabled in backend)
        let MOBILE_API_KEY = 'MNfs5qUDz5jjmyZjjMC5zUgIVjpTBuZehq2_fDg9cYk'; // Injected during deployment - DO NOT MODIFY MANUALLY
        const ITEMS_PER_PAGE = 12;
        const ACCESS_CODE = '123456';
        const MAX_LOG_ENTRIES = 30;
        
        // Helper function to build headers object with API key for authenticated requests
        // Returns a new headers object (does not modify anything)
        function buildHeaders(customHeaders = {}) {
            const headers = { ...customHeaders };
            if (MOBILE_API_KEY) {
                headers['X-API-Key'] = MOBILE_API_KEY;
            }
            return headers;
        }
        
        // Vertex AI Configuration
        // Note: Vertex AI region is configured via GOOGLE_VERTEX_LOCATION environment variable
        // Supported regions: us-central1 (default), us-east1, us-west1, europe-west1, asia-southeast1, etc.
        // Set GOOGLE_VERTEX_LOCATION in Cloudflare Workers environment variables or deployment config

        // DOM Elements
        const $ = id => document.getElementById(id);
        const presetInput = $('preset-input'), presetPreview = $('preset-preview'), presetGallery = $('preset-gallery');
        const selfieInput = $('selfie-input'), selfiePreview = $('selfie-preview'), selfieGallery = $('selfie-gallery');
        const resultsGallery = $('results-gallery'), generateBtn = $('generate-btn'), mergeBtn = $('merge-btn');
        const apiLogList = $('api-log-list'), additionalPromptInput = $('additional-prompt');
        const accessGate = $('access-gate'), accessInput = $('access-input'), accessSubmit = $('access-submit'), accessError = $('access-error');

        // Gallery Configuration
        const galleries = {
            preset: {
                key: 'preset', responseKey: 'presets', endpoints: { list: '/presets', delete: '/presets' },
                logName: 'Th∆∞ Vi·ªán M·∫´u', labels: { selectSuccess: 'ƒê√£ ch·ªçn m·∫´u th√†nh c√¥ng', deleteSuccess: 'ƒê√£ x√≥a m·∫´u th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·∫´u n√†y kh√¥ng?' },
                elements: { input: presetInput, preview: presetPreview, gallery: presetGallery, pagination: $('preset-pagination'), prevBtn: $('preset-prev'), nextBtn: $('preset-next') },
                state: { items: [], selected: null, page: 1 }
            },
            selfie: {
                key: 'selfie', responseKey: 'selfies', endpoints: { list: '/selfies', delete: '/selfies' },
                logName: 'Th∆∞ Vi·ªán Selfie', labels: { selectSuccess: 'ƒê√£ ch·ªçn selfie th√†nh c√¥ng', deleteSuccess: 'ƒê√£ x√≥a selfie th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a selfie n√†y kh√¥ng?' },
                elements: { input: selfieInput, preview: selfiePreview, gallery: selfieGallery, pagination: $('selfie-pagination'), prevBtn: $('selfie-prev'), nextBtn: $('selfie-next') },
                state: { items: [], selected: [], page: 1 }
            },
            results: {
                key: 'results', responseKey: 'results', endpoints: { list: '/results', delete: '/results' },
                logName: 'K·∫øt Qu·∫£ ƒê·ªïi M·∫∑t', labels: { deleteSuccess: 'ƒê√£ x√≥a k·∫øt qu·∫£ th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y kh√¥ng?' },
                elements: { gallery: resultsGallery, pagination: $('results-pagination'), prevBtn: $('results-prev'), nextBtn: $('results-next') },
                state: { items: [], selected: null, page: 1 }
            }
        };

        // Profile Manager
        window.profileManager = {
            currentProfile: null,
            async initializeProfile() {
                const statusDiv = $('profile-status');
                statusDiv.textContent = 'ƒêang t·∫£i...';
                try {
                    let profileId = localStorage.getItem('userProfileId');
                    if (profileId) {
                        const startTime = Date.now();
                        const profileUrl = `${WORKER_URL}/profiles/${profileId}`;
                        const response = await fetch(profileUrl, { headers: buildHeaders() });
                        const duration = Date.now() - startTime;
                        if (response.ok) {
                const data = await response.json();
                logApiCall({ label: 'L·∫•y H·ªì S∆°', method: 'GET', url: `/profiles/${profileId}`, fullUrl: profileUrl, status: 'success', duration });
                this.currentProfile = data.data || data;
                            this.updateProfileDisplay();
                            await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                            updateGenerateButton();
                            updateImageOperationButtons();
                            return this.currentProfile;
                        }
                        localStorage.removeItem('userProfileId');
                    }
                    const profile = await this.createProfile();
                    localStorage.setItem('userProfileId', profile.id);
                    this.currentProfile = profile;
                    this.updateProfileDisplay();
                    await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                    updateGenerateButton();
                    updateImageOperationButtons();
                    return profile;
                } catch (error) {
                    console.error('Profile init failed:', error);
                    statusDiv.textContent = '‚úó L·ªói';
                    statusDiv.style.color = 'var(--danger)';
                }
            },
            async createProfile() {
                const startTime = Date.now();
                const createProfileUrl = `${WORKER_URL}/profiles`;
                // Get or generate device_id
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('deviceId', deviceId);
                }
                const requestBody = { device_id: deviceId };
                const response = await fetch(createProfileUrl, { method: 'POST', headers: buildHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(requestBody) });
                const duration = Date.now() - startTime;
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫°o h·ªì s∆°');
                const data = await response.json();
                logApiCall({ label: 'T·∫°o H·ªì S∆°', method: 'POST', url: '/profiles', fullUrl: createProfileUrl, status: 'success', payload: data, duration, headers: { 'Content-Type': 'application/json' }, body: requestBody });
                return data.data || data;
            },
            updateProfileDisplay() {
                const statusDiv = $('profile-status'), infoDiv = $('profile-info'), idSpan = $('profile-id-display');
                const editBtn = $('edit-profile-btn');
                if (!this.currentProfile) { statusDiv.textContent = 'Ch∆∞a c√≥ h·ªì s∆°'; if (editBtn) editBtn.style.display = 'none'; return; }
                statusDiv.textContent = '‚úì S·∫µn s√†ng';
                statusDiv.style.color = 'var(--success)';
                if (idSpan) idSpan.textContent = this.currentProfile.id;
                if (infoDiv) infoDiv.style.display = 'inline';
                if (editBtn) editBtn.style.display = 'inline-block';
            },
            async updateProfile(updates) {
                if (!this.currentProfile?.id) throw new Error('Kh√¥ng c√≥ h·ªì s∆° ƒë·ªÉ c·∫≠p nh·∫≠t');
                const startTime = Date.now();
                const updateUrl = `${WORKER_URL}/profiles/${this.currentProfile.id}`;
                const response = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify(updates)
                });
                const duration = Date.now() - startTime;
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                logApiCall({
                    label: 'C·∫≠p Nh·∫≠t H·ªì S∆°',
                    method: 'PUT',
                    url: `/profiles/${this.currentProfile.id}`,
                    fullUrl: updateUrl,
                    status: 'success',
                    payload: data,
                    duration,
                    headers: { 'Content-Type': 'application/json' },
                    body: updates
                });
                this.currentProfile = data.data || data;
                this.updateProfileDisplay();
                return this.currentProfile;
            },
            async switchToProfile(profileId) {
                if (!profileId?.trim()) { showStatusMessage('Vui l√≤ng nh·∫≠p ID h·ªì s∆°', 'error'); return; }
                const statusDiv = $('profile-status');
                statusDiv.textContent = 'ƒêang chuy·ªÉn...';
                showLoading('ƒêang chuy·ªÉn h·ªì s∆°...');
                try {
                    const startTime = Date.now();
                    const getProfileUrl = `${WORKER_URL}/profiles/${profileId.trim()}`;
                    const response = await fetch(getProfileUrl, { headers: buildHeaders() });
                    const duration = Date.now() - startTime;
                    if (!response.ok) throw new Error(response.status === 404 ? 'Kh√¥ng t√¨m th·∫•y h·ªì s∆°' : `HTTP ${response.status}`);
                    const data = await response.json();
                    logApiCall({ label: 'L·∫•y H·ªì S∆°', method: 'GET', url: `/profiles/${profileId.trim()}`, fullUrl: getProfileUrl, status: 'success', duration });
                    this.currentProfile = data.data || data;
                    localStorage.setItem('userProfileId', this.currentProfile.id);
                    this.updateProfileDisplay();
                    await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                    updateResultsCount();
                    updateGenerateButton();
                    updateImageOperationButtons();
                    showStatusMessage('ƒê√£ chuy·ªÉn h·ªì s∆° th√†nh c√¥ng', 'success');
                } catch (error) {
                    statusDiv.textContent = '‚úó L·ªói';
                    statusDiv.style.color = 'var(--danger)';
                    showStatusMessage(`Chuy·ªÉn h·ªì s∆° th·∫•t b·∫°i: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
        };

        function switchProfile() {
            const input = $('profile-id-input');
            if (input?.value.trim()) {
                window.profileManager.switchToProfile(input.value.trim());
                input.value = '';
            }
        }

        function openProfileEditModal() {
            const profile = window.profileManager?.currentProfile;
            if (!profile) {
                showStatusMessage('Kh√¥ng c√≥ h·ªì s∆° ƒë·ªÉ ch·ªânh s·ª≠a', 'error');
                return;
            }
            const modal = $('profile-edit-modal');
            const nameInput = $('profile-edit-name');
            const emailInput = $('profile-edit-email');
            const avatarInput = $('profile-edit-avatar');
            const preferencesInput = $('profile-edit-preferences');
            
            if (nameInput) nameInput.value = profile.name || '';
            if (emailInput) emailInput.value = profile.email || '';
            if (avatarInput) avatarInput.value = profile.avatar_url || '';
            if (preferencesInput) {
                try {
                    const prefs = typeof profile.preferences === 'string' 
                        ? JSON.parse(profile.preferences) 
                        : profile.preferences;
                    preferencesInput.value = prefs ? JSON.stringify(prefs, null, 2) : '';
                } catch (e) {
                    preferencesInput.value = profile.preferences || '';
                }
            }
            
            if (modal) modal.style.display = 'flex';
        }

        function closeProfileEditModal() {
            const modal = $('profile-edit-modal');
            if (modal) modal.style.display = 'none';
        }

        async function saveProfileEdit(event) {
            event.preventDefault();
            const profile = window.profileManager?.currentProfile;
            if (!profile?.id) {
                showStatusMessage('Kh√¥ng c√≥ h·ªì s∆° ƒë·ªÉ c·∫≠p nh·∫≠t', 'error');
                return;
            }

            const nameInput = $('profile-edit-name');
            const emailInput = $('profile-edit-email');
            const avatarInput = $('profile-edit-avatar');
            const preferencesInput = $('profile-edit-preferences');

            const updates = {};
            if (nameInput?.value.trim()) updates.name = nameInput.value.trim();
            if (emailInput?.value.trim()) updates.email = emailInput.value.trim();
            if (avatarInput?.value.trim()) updates.avatar_url = avatarInput.value.trim();
            
            if (preferencesInput?.value.trim()) {
                try {
                    const prefs = JSON.parse(preferencesInput.value.trim());
                    updates.preferences = prefs;
                } catch (e) {
                    showStatusMessage('Preferences ph·∫£i l√† JSON h·ª£p l·ªá', 'error');
                    return;
                }
            }

            showLoading('ƒêang c·∫≠p nh·∫≠t h·ªì s∆°...');
            try {
                await window.profileManager.updateProfile(updates);
                closeProfileEditModal();
                showStatusMessage('ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng', 'success');
            } catch (error) {
                showStatusMessage(`C·∫≠p nh·∫≠t h·ªì s∆° th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Access Gate
        function unlockInterface() {
            document.body.classList.remove('locked');
            accessGate?.classList.add('hidden');
        }

        function handleAccessAttempt() {
            if (accessInput?.value.trim() === ACCESS_CODE) {
                sessionStorage.setItem('faceswap:authorized', 'true');
                if (accessError) accessError.textContent = '';
                unlockInterface();
            } else {
                if (accessError) accessError.textContent = 'M√£ sai, vui l√≤ng th·ª≠ l·∫°i';
                if (accessInput) { accessInput.value = ''; accessInput.focus(); }
            }
        }

        function initAccessGate() {
            if (sessionStorage.getItem('faceswap:authorized') === 'true') { unlockInterface(); return; }
            document.body.classList.add('locked');
            accessGate?.classList.remove('hidden');
            accessSubmit?.addEventListener('click', handleAccessAttempt);
            accessInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAccessAttempt(); } });
            setTimeout(() => accessInput?.focus(), 50);
        }

        // Loading Timer
        let loadingTimerInterval = null;
        let loadingStartTime = null;

        function startLoadingTimer() {
            loadingStartTime = Date.now();
            const timerEl = $('loading-timer');
            if (!timerEl) return;
            
            if (loadingTimerInterval) clearInterval(loadingTimerInterval);
            loadingTimerInterval = setInterval(() => {
                if (!loadingStartTime) return;
                const elapsed = ((Date.now() - loadingStartTime) / 1000).toFixed(1);
                if (timerEl) timerEl.textContent = `${elapsed}s`;
            }, 100);
        }

        function stopLoadingTimer() {
            if (loadingTimerInterval) {
                clearInterval(loadingTimerInterval);
                loadingTimerInterval = null;
            }
            const timerEl = $('loading-timer');
            if (timerEl) timerEl.textContent = '0.0s';
            loadingStartTime = null;
        }

        // Logging
        function generateCurlCommand(method, fullUrl, headers, body) {
            let curl = `curl -X ${method}`;
            
            if (headers) {
                Object.entries(headers).forEach(([key, value]) => {
                    // Skip Content-Type for FormData as curl will set it automatically
                    if (body instanceof FormData && key.toLowerCase() === 'content-type') {
                        return;
                    }
                    curl += ` \\\n  -H "${key}: ${value}"`;
                });
            }
            
            curl += ` \\\n  "${fullUrl}"`;
            
            if (body && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                if (body instanceof FormData) {
                    // Extract actual values from FormData
                    const formEntries = [];
                    for (const [key, value] of body.entries()) {
                        if (value instanceof File) {
                            formEntries.push({ key, value: `@${value.name}`, isFile: true });
                        } else {
                            formEntries.push({ key, value: String(value), isFile: false });
                        }
                    }
                    
                    // Generate curl command with actual FormData values
                    formEntries.forEach(({ key, value, isFile }) => {
                        if (isFile) {
                            curl += ` \\\n  -F "${key}=${value}"`;
                        } else {
                            curl += ` \\\n  -F "${key}=${value}"`;
                        }
                    });
                } else if (typeof body === 'string') {
                    try {
                        const parsed = JSON.parse(body);
                        curl += ` \\\n  -d '${JSON.stringify(parsed, null, 2).replace(/'/g, "'\\''")}'`;
                    } catch {
                        curl += ` \\\n  -d '${body.replace(/'/g, "'\\''")}'`;
                    }
                } else if (body && typeof body === 'object') {
                    curl += ` \\\n  -d '${JSON.stringify(body, null, 2).replace(/'/g, "'\\''")}'`;
                }
            }
            
            return curl;
        }

        function logApiCall({ label, method, url, status = 'info', payload, duration, headers, body, fullUrl }) {
            if (!apiLogList || !['POST', 'PUT', 'DELETE', 'GET'].includes((method || '').toUpperCase())) return;
            
            const entry = document.createElement('div');
            entry.className = `api-log-entry log-${status}`;
            const durationText = duration ? formatDuration(duration) : '';
            const durationHtml = durationText ? `<span class="api-log-timing">‚è±Ô∏è ${durationText}</span>` : '';
            
            const displayUrl = fullUrl || (url.startsWith('http') ? url : `${WORKER_URL}${url.startsWith('/') ? url : '/' + url}`);
            // Extract just the path without query params
            let displayPath = url;
            if (fullUrl) {
                try {
                    const urlObj = new URL(fullUrl);
                    displayPath = urlObj.pathname;
                } catch (e) {
                    // If URL parsing fails, try to remove query string manually
                    displayPath = url.split('?')[0];
                }
            } else {
                displayPath = url.split('?')[0];
            }
            
            const statusText = status === 'success' ? 'SUCCESS' : status === 'error' ? 'ERROR' : status.toUpperCase();
            const statusColor = status === 'success' ? 'var(--success)' : status === 'error' ? 'var(--danger)' : 'var(--text-secondary)';
            
            let htmlParts = [
                `<span class="api-log-method">${method}</span> <span class="api-log-url">${displayPath}</span> <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>${durationHtml}`
            ];
            
            // Only show response payload for non-GET requests
            if (payload && method.toUpperCase() !== 'GET') {
                htmlParts.push(`<div style="margin-top: 6px; font-size: 11px; background: rgba(0,0,0,0.03); padding: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><strong>Response:</strong><pre style="margin: 0; padding: 0;">${escapeHtml(JSON.stringify(payload, null, 2))}</pre></div>`);
            }
            
            if (method && displayUrl) {
                const curlCommand = generateCurlCommand(method, displayUrl, headers, body);
                const curlEscaped = escapeHtml(curlCommand);
                htmlParts.push(`<div style="margin-top: 8px; position: relative; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px;">
                    <button class="api-log-copy-btn" data-curl="${curlEscaped.replace(/"/g, '&quot;')}">Copy</button>
                    <pre style="overflow-x: auto; font-size: 11px; white-space: pre-wrap; word-wrap: break-word; word-break: break-all; margin: 0; padding-right: 60px;">${curlEscaped}</pre>
                </div>`);
            }
            
            entry.innerHTML = htmlParts.join('');
            
            // Attach copy button handler after DOM is created
            const copyBtn = entry.querySelector('.api-log-copy-btn');
            if (copyBtn) {
                const curlText = copyBtn.getAttribute('data-curl');
                copyBtn.onclick = function() {
                    navigator.clipboard.writeText(curlText).then(() => {
                        copyBtn.textContent = 'Copied!';
                        copyBtn.style.background = 'var(--success)';
                        setTimeout(() => {
                            copyBtn.textContent = 'Copy';
                            copyBtn.style.background = 'var(--accent)';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        copyBtn.textContent = 'Error';
                        setTimeout(() => {
                            copyBtn.textContent = 'Copy';
                        }, 2000);
                    });
                };
            }
            
            apiLogList.prepend(entry);
            while (apiLogList.childElementCount > MAX_LOG_ENTRIES) apiLogList.removeChild(apiLogList.lastElementChild);
        }

        function formatDuration(ms) {
            const seconds = (ms / 1000).toFixed(1);
            return `${seconds}s`;
        }

        function clearApiLogs() { if (apiLogList) apiLogList.innerHTML = ''; }

        function toggleLogPanel() {
            const appLayout = document.querySelector('.app-layout');
            const logPanel = document.querySelector('.log-panel');
            const isHidden = appLayout?.classList.contains('log-hidden');
            if (isHidden) {
                appLayout.classList.remove('log-hidden');
                if (logPanel) { logPanel.style.display = 'flex'; setTimeout(() => { logPanel.style.opacity = '1'; logPanel.style.transform = 'translateX(0)'; }, 10); }
            } else {
                if (logPanel) { logPanel.style.opacity = '0'; logPanel.style.transform = 'translateX(20px)'; }
                setTimeout(() => appLayout?.classList.add('log-hidden'), 300);
            }
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Gallery Functions
        const loadingGalleries = new Set();
        async function loadGallery(type) {
            const config = galleries[type];
            const loadKey = type;

            // Prevent duplicate simultaneous calls - check and add atomically
            if (loadingGalleries.has(loadKey)) {
                return;
            }
            loadingGalleries.add(loadKey);
            
            let startTime = null;
            let errorLogged = false;
            const params = new URLSearchParams();
            try {
                if ((type === 'selfie' || type === 'results') && !window.profileManager?.currentProfile) {
                    config.state.items = []; config.state.page = 1; renderGallery(type);
                    loadingGalleries.delete(loadKey);
                    return;
                }
                let url = `${WORKER_URL}${config.endpoints.list}`;
                if ((type === 'selfie' || type === 'results') && window.profileManager.currentProfile) {
                    const profileId = window.profileManager.currentProfile.id;
                    params.append('profile_id', profileId);
                }
                // Gender filter removed - metadata is in R2 path, not DB
                if (params.toString()) url += `?${params.toString()}`;
                startTime = Date.now();
                const response = await fetch(url, { headers: buildHeaders() });
                const duration = Date.now() - startTime;
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    errorLogged = true;
                    logApiCall({ label: `T·∫£i ${config.logName}`, method: 'GET', url: `${config.endpoints.list}${params.toString() ? '?' + params.toString() : ''}`, fullUrl: url, status: 'error', duration, payload: errorData });
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const items = data[config.responseKey] || data.data?.[config.responseKey] || [];
                
                // Only log success if we actually got data or it's a valid empty response
                const status = (response.ok && data !== null && typeof data === 'object') ? 'success' : 'error';
                logApiCall({ label: `T·∫£i ${config.logName}`, method: 'GET', url: `${config.endpoints.list}${params.toString() ? '?' + params.toString() : ''}`, fullUrl: url, status, duration, payload: data });
                
                // Normalize field names: map selfie_url/preset_url/result_url to image_url for backward compatibility
                config.state.items = items.map((item) => {
                    const normalized = {
                        ...item,
                        image_url: item.selfie_url || item.preset_url || item.result_url || item.image_url
                    };
                    // Ensure result_url is preserved for results type
                    if (type === 'results' && item.result_url && !normalized.result_url) {
                        normalized.result_url = item.result_url;
                    }
                    return normalized;
                });
                config.state.page = 1;
                renderGallery(type);
            } catch (error) {
                // Only log error if it wasn't already logged (e.g., network errors, JSON parse errors)
                if (!errorLogged) {
                    const duration = startTime ? Date.now() - startTime : 0;
                    const errorUrl = `${WORKER_URL}${config.endpoints.list}${params.toString() ? '?' + params.toString() : ''}`;
                    logApiCall({ label: `T·∫£i ${config.logName}`, method: 'GET', url: config.endpoints.list, fullUrl: errorUrl, status: 'error', duration });
                }
                config.state.items = []; config.state.page = 1; renderGallery(type);
            } finally {
                loadingGalleries.delete(loadKey);
            }
        }

        function renderGallery(type) {
            const config = galleries[type];
            const { items, page, selected } = config.state;
            const { gallery, pagination, prevBtn, nextBtn } = config.elements;
            if (!gallery) return;

            if (!items.length) {
                gallery.style.display = 'none';
                if (pagination) pagination.style.display = 'none';
                if (type === 'results') {
                    gallery.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o</div>';
                    gallery.style.display = 'block';
                }
                return;
            }

            gallery.style.display = 'grid';
            if (pagination) pagination.style.display = 'flex';

            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            config.state.page = Math.min(page, Math.max(1, totalPages));
            const startIndex = (config.state.page - 1) * ITEMS_PER_PAGE;
            const pageItems = items.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            if (type === 'results') {
                gallery.innerHTML = pageItems.map((item, index) => {
                    const globalIndex = startIndex + index;
                    const imageUrl = item.result_url || item.image_url || '';
                    return `<div class="gallery-item" data-item-id="${item.id}" draggable="true" ondragstart="handleResultDrag(event, '${item.id.replace(/'/g, "\\'")}', '${imageUrl.replace(/'/g, "\\'")}')">
                        <img src="${imageUrl}" alt="" loading="lazy" onclick="openLightbox(${globalIndex}); displayResultInPreview('${imageUrl.replace(/'/g, "\\'")}');" draggable="false">
                        <button class="gallery-delete-btn" onclick="deleteItem('${type}', '${item.id}', event)">√ó</button>
                    </div>`;
                }).join('');
            } else {
                gallery.innerHTML = pageItems.map(item => {
                    const isSelected = type === 'selfie' && Array.isArray(selected) 
                        ? selected.some(s => s.id === item.id)
                        : selected?.id === item.id;
                    // Add action badge for selfies
                    const actionBadge = type === 'selfie' && item.action 
                        ? `<span class="gallery-action-badge action-${item.action.toLowerCase()}">${item.action.toLowerCase() === '4k' ? '4K' : item.action}</span>`
                        : '';
                    return `<div class="gallery-item ${isSelected ? 'selected' : ''}" onclick="handleSelect('${type}', '${item.id}', event)" data-item-id="${item.id}">
                        <img src="${item.image_url}" alt="" loading="lazy">
                        ${actionBadge}
                        <button class="gallery-delete-btn" onclick="deleteItem('${type}', '${item.id}', event)">√ó</button>
                    </div>`;
                }).join('');
            }

            if (prevBtn) prevBtn.disabled = config.state.page === 1;
            if (nextBtn) nextBtn.disabled = config.state.page === totalPages;

            const dotsContainer = $(type + '-dots');
            if (dotsContainer && totalPages > 1) {
                dotsContainer.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'pagination-dot' + (i === config.state.page ? ' active' : '');
                    dot.onclick = () => { config.state.page = i; renderGallery(type); };
                    dotsContainer.appendChild(dot);
                }
            }

            if (type === 'results') updateResultsCount();
        }

        function changePage(type, delta) {
            const config = galleries[type];
            const totalPages = Math.ceil(config.state.items.length / ITEMS_PER_PAGE) || 1;
            const newPage = config.state.page + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                config.state.page = newPage;
                renderGallery(type);
            }
        }

        function handleSelect(type, itemId, event) {
            event?.stopPropagation();
            const config = galleries[type];
            const item = config.state.items.find(e => e.id === itemId);
            if (item) setSelectedItem(type, item, { showMessage: true });
        }

        function setSelectedItem(type, item, options = {}) {
            const config = galleries[type];
            if (type === 'selfie') {
                // Support multiple selfie selection (up to 2 for wedding faceswap)
                const selected = config.state.selected || [];
                const itemIndex = selected.findIndex(s => s.id === item.id);
                if (itemIndex >= 0) {
                    // Deselect if already selected
                    selected.splice(itemIndex, 1);
                } else {
                    // Add to selection (max 2)
                    if (selected.length < 2) {
                        selected.push(item);
                    } else {
                        // Replace the first one if already at max
                        selected[0] = item;
                    }
                }
                config.state.selected = selected;
            } else {
                config.state.selected = item || null;
            }
            updatePreview(type);
            renderGallery(type);
            updateGenerateButton();
            updateImageOperationButtons();
            
            // Clear result preview when preset or selfie is selected
            if ((type === 'preset' || type === 'selfie') && item) {
                clearResultPreview();
            }
            
            if (options.showMessage && item) showStatusMessage(config.labels.selectSuccess, 'success');
        }

        function clearResultPreview() {
            const resultPreview = $('result-preview');
            if (resultPreview) {
                resultPreview.innerHTML = `<div class="preview-empty">
                    <div class="preview-empty-icon">‚ú®</div>
                    <div class="preview-empty-text">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y (Result will appear here)</div>
                </div>`;
            }
        }

        function updatePreview(type) {
            const config = galleries[type];
            const { selected } = config.state;
            const preview = config.elements.preview;
            if (!preview) return;

            const clearBtn = $(type + '-clear-btn');
            
            // Update selfie preview label with action type
            if (type === 'selfie') {
                const labelEl = document.querySelector('#selfie-card .preview-label');
                if (labelEl) {
                    if (Array.isArray(selected) && selected.length > 0) {
                        const actions = selected.map(s => {
                            const action = s.action?.toLowerCase() || 'faceswap';
                            if (action === '4k') return '4K';
                            if (action === 'faceswap') return 'Faceswap';
                            if (action === 'wedding') return 'Wedding';
                            return 'Default';
                        });
                        const uniqueActions = [...new Set(actions)];
                        const actionText = uniqueActions.length === 1 
                            ? uniqueActions[0] 
                            : uniqueActions.join(', ');
                        const maxText = selected[0]?.action?.toLowerCase() === 'wedding' 
                            ? ' - T·ªëi ƒëa 2 cho Wedding'
                            : selected[0]?.action?.toLowerCase() === 'faceswap'
                            ? ' - T·ªëi ƒëa 8 cho Faceswap'
                            : selected[0]?.action?.toLowerCase() === '4k'
                            ? ' - T·ªëi ƒëa 1 cho 4K'
                            : ' - T·ªëi ƒëa 1';
                        labelEl.textContent = `·∫¢nh T·ª± S∆∞·ªõng (Selfie) - ${actionText}${maxText}`;
                    } else if (selected && !Array.isArray(selected)) {
                        const action = selected.action?.toLowerCase() || 'faceswap';
                        let actionText = 'Faceswap';
                        let maxText = ' - T·ªëi ƒëa 8 cho Faceswap';
                        if (action === '4k') {
                            actionText = '4K';
                            maxText = ' - T·ªëi ƒëa 1 cho 4K';
                        } else if (action === 'faceswap') {
                            actionText = 'Faceswap';
                            maxText = ' - T·ªëi ƒëa 8 cho Faceswap';
                        } else if (action === 'wedding') {
                            actionText = 'Wedding';
                            maxText = ' - T·ªëi ƒëa 2 cho Wedding';
                        } else {
                            actionText = 'Default';
                            maxText = ' - T·ªëi ƒëa 1';
                        }
                        labelEl.textContent = `·∫¢nh T·ª± S∆∞·ªõng (Selfie) - ${actionText}${maxText}`;
                    } else {
                        labelEl.textContent = '·∫¢nh T·ª± S∆∞·ªõng (Selfie) - T·ªëi ƒëa 2 cho Wedding';
                    }
                }
            }
            
            if (type === 'selfie' && Array.isArray(selected)) {
                // Handle multiple selfie selection
                if (selected.length === 0) {
                    preview.innerHTML = `<div class="preview-empty"><div class="preview-empty-icon">üì∑</div><div class="preview-empty-text">Ch·ªçn t·ª´ ·∫£nh t·ª± s∆∞·ªõng (Select from selfies)</div></div>`;
                    if (clearBtn) clearBtn.style.display = 'none';
                    return;
                }
                // Display both selfies side by side
                const imagesHtml = selected.map((item, index) => {
                    const imageUrl = item.image_url || item.result_url || '';
                    const action = item.action?.toLowerCase() || 'faceswap';
                    const actionBadge = `<span class="preview-action-badge action-${action}">${action === '4k' ? '4K' : action}</span>`;
                    return `<div style="flex: 1; padding: 4px; position: relative;"><img src="${imageUrl}" alt="Selfie ${index + 1}" style="width: 100%; height: 100%; object-fit: contain; cursor: pointer; border: 2px solid #4CAF50; border-radius: 4px;" onclick="openPreviewLightbox('selfie', ${index})">${actionBadge}</div>`;
                }).join('');
                preview.innerHTML = `<div style="display: flex; gap: 8px; height: 100%;">${imagesHtml}</div>`;
                if (clearBtn) clearBtn.style.display = 'block';
                return;
            }
            
            if (!selected) {
                const emptyText = type === 'preset' ? 'Ch·ªçn t·ª´ m·∫´u (Select from presets)' : type === 'selfie' ? 'Ch·ªçn t·ª´ ·∫£nh t·ª± s∆∞·ªõng (Select from selfies)' : 'K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y (Result will appear here)';
                preview.innerHTML = `<div class="preview-empty"><div class="preview-empty-icon">${type === 'result' ? '‚ú®' : 'üì∑'}</div><div class="preview-empty-text">${emptyText}</div></div>`;
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }
            const imageUrl = selected.image_url || selected.result_url || '';
            const action = selected.action?.toLowerCase() || 'faceswap';
            const actionBadge = type === 'selfie' && selected.action 
                ? `<span class="preview-action-badge action-${action}">${action === '4k' ? '4K' : action}</span>`
                : '';
            preview.innerHTML = `<div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"><img src="${imageUrl}" alt="" style="cursor: pointer; max-width: 100%; max-height: 100%; object-fit: contain;" onclick="openPreviewLightbox('${type}')">${actionBadge}</div>`;
            if (clearBtn) clearBtn.style.display = 'block';
        }

        function updateGenerateButton() {
            const hasPreset = !!galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            const hasSelfie = selfieSelected && (Array.isArray(selfieSelected) ? selfieSelected.length > 0 : !!selfieSelected);
            const additionalPromptInput = document.getElementById('additional-prompt');
            const hasCustomPrompt = additionalPromptInput && additionalPromptInput.value.trim() !== '';
            
            if (generateBtn) generateBtn.disabled = !(hasPreset && hasSelfie);
            // Enable merge button if: (preset AND selfie) OR (custom_prompt AND selfie)
            if (mergeBtn) mergeBtn.disabled = !((hasPreset || hasCustomPrompt) && hasSelfie);
        }

        function updateImageOperationButtons() {
            const selfieSelected = galleries.selfie.state.selected;
            const hasSelfie = selfieSelected && (Array.isArray(selfieSelected) ? selfieSelected.length > 0 : !!selfieSelected);
            const hasProfile = !!window.profileManager?.currentProfile;
            const shouldDisable = !(hasSelfie && hasProfile);
            
            const enhanceBtn = $('enhance-btn');
            const beautyBtn = $('beauty-btn');
            const filterBtn = $('filter-btn');
            const upscaleBtn = $('upscale4k-btn');
            const restoreBtn = $('restore-btn');
            const agingBtn = $('aging-btn');
            
            if (enhanceBtn) enhanceBtn.disabled = shouldDisable;
            if (beautyBtn) beautyBtn.disabled = shouldDisable;
            if (filterBtn) {
                const presetSelected = galleries.preset.state.selected;
                const hasPreset = !!presetSelected;
                filterBtn.disabled = !(hasSelfie && hasPreset && hasProfile);
            }
            if (upscaleBtn) upscaleBtn.disabled = shouldDisable;
            if (restoreBtn) restoreBtn.disabled = shouldDisable;
            if (agingBtn) agingBtn.disabled = shouldDisable;
        }

        function updateResultsCount() {
            const countEl = $('results-count');
            if (countEl) countEl.textContent = `(${galleries.results?.state?.items?.length || 0})`;
        }

        function clearSelection(type, event) {
            event?.stopPropagation();
            const config = galleries[type];
            config.state.selected = type === 'selfie' ? [] : null;
            updatePreview(type);
            renderGallery(type);
            updateGenerateButton();
            updateImageOperationButtons();
        }

        async function deleteItem(type, itemId, event) {
            event?.stopPropagation();
            const config = galleries[type];
            if (!confirm(config.labels.confirmDelete)) return;

            try {
                const startTime = Date.now();
                const deleteUrl = `${WORKER_URL}${config.endpoints.delete}/${itemId}`;
                const response = await fetch(deleteUrl, { method: 'DELETE', headers: buildHeaders() });
                const data = await response.json();
                const duration = Date.now() - startTime;
                logApiCall({ label: `X√≥a ${config.logName}`, method: 'DELETE', url: `${config.endpoints.delete}/${itemId}`, fullUrl: deleteUrl, status: response.ok ? 'success' : 'error', payload: data, duration });
                if (!response.ok) throw new Error(data.message || 'X√≥a th·∫•t b·∫°i');

                config.state.items = config.state.items.filter(item => item.id !== itemId);
                const totalPages = Math.ceil(config.state.items.length / ITEMS_PER_PAGE) || 1;
                config.state.page = Math.min(config.state.page, totalPages);
                if (type === 'selfie' && Array.isArray(config.state.selected)) {
                    config.state.selected = config.state.selected.filter(item => item.id !== itemId);
                } else if (config.state.selected?.id === itemId) {
                    config.state.selected = null;
                }
                updatePreview(type);
                renderGallery(type);
                updateGenerateButton();
                updateImageOperationButtons();
                showStatusMessage(config.labels.deleteSuccess, 'success');
            } catch (error) {
                showStatusMessage('X√≥a th·∫•t b·∫°i', 'error');
            }
        }

        // Upload
        presetInput?.addEventListener('change', async e => {
            const files = Array.from(e.target.files || []);
            if (files.length > 0) await handleMultipleImageUpload(files, 'preset');
            e.target.value = '';
        });

        selfieInput?.addEventListener('change', async e => {
            const files = Array.from(e.target.files || []);
            if (files.length > 0) await handleMultipleImageUpload(files, 'selfie');
            e.target.value = '';
        });

        window.handleResultDrag = function(event, itemId, imageUrl) {
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: 'result', itemId, imageUrl }));
            event.dataTransfer.effectAllowed = 'copy';
        };

        async function handleResultDrop(data, type) {
            if (!data.imageUrl) {
                showStatusMessage('Kh√¥ng t√¨m th·∫•y URL h√¨nh ·∫£nh', 'error');
                return;
            }
            await uploadImageFromUrl(data.imageUrl, type);
        }

        window.handleResultDrop = handleResultDrop;

        function setupDragDrop(type) {
            const dropZone = $(type + '-drop-zone');
            if (!dropZone) return;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
            dropZone.addEventListener('drop', async e => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');
                
                const dragData = e.dataTransfer.getData('text/plain');
                if (dragData) {
                    try {
                        const data = JSON.parse(dragData);
                        if (data.type === 'result') {
                            await handleResultDrop(data, type);
                            return;
                        }
                    } catch (err) {
                        console.error('Error parsing drag data:', err);
                    }
                }
                
                const files = Array.from(e.dataTransfer.files).filter(f => f?.type.match('image/(jpeg|jpg|png|webp)'));
                if (files.length > 0) await handleMultipleImageUpload(files, type);
            }, false);
        }

        async function handleMultipleImageUpload(files, type) {
            const config = galleries[type];
            if (!window.profileManager.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫£i l√™n h√¨nh ·∫£nh.', 'error'); return; }
            
            // Validate all files
            const validFiles = files.filter(file => {
                if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                    showStatusMessage(`Lo·∫°i t·ªáp kh√¥ng h·ª£p l·ªá: ${file.name}. Vui l√≤ng t·∫£i l√™n JPG, PNG ho·∫∑c WebP.`, 'error');
                    return false;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showStatusMessage(`T·ªáp v∆∞·ª£t qu√° gi·ªõi h·∫°n 10MB: ${file.name}. Vui l√≤ng ch·ªçn t·ªáp nh·ªè h∆°n.`, 'error');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            const dropZone = $(type + '-drop-zone');
            dropZone?.classList.add('loading');
            showLoading(`ƒêang t·∫£i l√™n ${validFiles.length} ${type === 'preset' ? 'm·∫´u' : 'selfie'}...`);

            try {
                const formData = new FormData();
                // Append all files with 'files' key (backend expects 'files' for multiple)
                for (const file of validFiles) {
                    formData.append('files', file);
                }
                formData.append('type', type);
                formData.append('profile_id', window.profileManager.currentProfile.id);
                
                if (type === 'preset') {
                    formData.append('enableVertexPrompt', 'true');
                } else if (type === 'selfie') {
                    const actionSelect = document.getElementById('selfie-action-select');
                    const action = actionSelect?.value || 'faceswap';
                    formData.append('action', action);
                }

                const uploadUrl = `${WORKER_URL}/upload-url`;
                const startTime = Date.now();
                const response = await fetch(uploadUrl, { method: 'POST', headers: buildHeaders(), body: formData });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label: `T·∫£i L√™n ${config.logName} (${validFiles.length} files)`, method: 'POST', url: '/upload-url', fullUrl: uploadUrl, status: response.ok ? 'success' : 'error', payload: data, duration, body: formData });
                if (!response.ok || data.status !== 'success') {
                    const errorMsg = data.message || 'T·∫£i l√™n th·∫•t b·∫°i';
                    const error = new Error(errorMsg);
                    if (data.debug) {
                        error.debug = data.debug;
                    }
                    throw error;
                }

                // Process all results from data.data.results
                const results = data.data?.results || [];
                const successfulResults = results.filter(r => r.id && r.url) || [];
                const failedResults = results.filter(r => !r.id || !r.url) || [];

                if (successfulResults.length > 0) {
                    const newImages = successfulResults.map(result => ({
                        id: result.id,
                        image_url: result.url,
                        created_at: new Date().toISOString()
                    }));

                    // Add all new images to gallery
                    config.state.items = [...newImages, ...config.state.items.filter(e => !newImages.some(ni => ni.id === e.id))];
                    config.state.page = 1;
                    await loadGallery(type);
                    
                    // Select the first uploaded image
                    if (newImages.length > 0) {
                        setSelectedItem(type, newImages[0]);
                    }

                    const successMsg = successfulResults.length === validFiles.length 
                        ? `T·∫£i l√™n th√†nh c√¥ng ${successfulResults.length} h√¨nh ·∫£nh`
                        : `T·∫£i l√™n th√†nh c√¥ng ${successfulResults.length}/${validFiles.length} h√¨nh ·∫£nh`;
                    showStatusMessage(successMsg, 'success');
                }

                if (failedResults.length > 0) {
                    const errorMsg = `Th·∫•t b·∫°i: ${failedResults.length} h√¨nh ·∫£nh kh√¥ng th·ªÉ t·∫£i l√™n`;
                    showStatusMessage(errorMsg, 'error');
                }
            } catch (error) {
                showStatusMessage(`T·∫£i l√™n th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                dropZone?.classList.remove('loading');
                hideLoading();
            }
        }

        // Keep backward compatibility
        async function handleImageUpload(file, type) {
            await handleMultipleImageUpload([file], type);
        }

        // Face Swap & Operations
        async function generateFaceSwap() {
            const presetSelected = galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            const selfieArray = Array.isArray(selfieSelected) ? selfieSelected : (selfieSelected ? [selfieSelected] : []);
            if (!presetSelected || selfieArray.length === 0) { showStatusMessage('Vui l√≤ng ch·ªçn c·∫£ m·∫´u v√† √≠t nh·∫•t m·ªôt selfie tr∆∞·ªõc khi t·∫°o ƒë·ªïi m·∫∑t.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫°o ƒë·ªïi m·∫∑t.', 'error'); return; }

            generateBtn.disabled = true;
            generateBtn.classList.add('loading');
            showLoading('ƒêang t·∫°o ƒë·ªïi m·∫∑t...');

            try {
                const aspectRatioSelect = document.getElementById('aspect-ratio');
                if (!aspectRatioSelect) {
                    console.error('[Frontend] Aspect ratio select element not found!');
                }
                const selectedAspectRatio = aspectRatioSelect?.value || localStorage.getItem('faceswap:aspectRatio') || '3:4';
                console.log('[Frontend] Aspect ratio select value:', aspectRatioSelect?.value);
                console.log('[Frontend] Selected aspect ratio:', selectedAspectRatio);
                const usePresetUrl = !presetSelected.id || presetSelected.id?.startsWith('result-preset-');
                
                // Build selfie arrays (support multiple selfies for wedding faceswap)
                const selfieIds = [];
                const selfieUrls = [];
                for (const selfie of selfieArray) {
                    const useSelfieUrl = !selfie.id || selfie.id?.startsWith('result-selfie-');
                    if (useSelfieUrl) {
                        selfieUrls.push(selfie.image_url);
                    } else {
                        selfieIds.push(selfie.id);
                    }
                }
                
                const modelSelect = document.getElementById('gemini-model');
                const selectedModel = modelSelect?.value || localStorage.getItem('faceswap:model') || '2.5';
                
                const requestBody = {
                    ...(usePresetUrl 
                        ? { preset_image_url: presetSelected.image_url }
                        : { preset_image_id: presetSelected.id }
                    ),
                    profile_id: window.profileManager.currentProfile.id,
                    additional_prompt: additionalPromptInput?.value.trim() || '',
                    aspect_ratio: selectedAspectRatio,
                    model: selectedModel
                };
                
                if (selfieUrls.length > 0) {
                    requestBody.selfie_image_urls = selfieUrls;
                }
                if (selfieIds.length > 0) {
                    requestBody.selfie_ids = selfieIds;
                }
                console.log('[Frontend] Full request body:', JSON.stringify(requestBody, null, 2));
                console.log('[Frontend] Sending request with aspect_ratio:', requestBody.aspect_ratio);

                const faceswapUrl = `${WORKER_URL}/faceswap`;
                const startTime = Date.now();
                const response = await fetch(faceswapUrl, { method: 'POST', headers: buildHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(requestBody) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label: 'T·∫°o ƒê·ªïi M·∫∑t', method: 'POST', url: '/faceswap', fullUrl: faceswapUrl, status: response.ok ? 'success' : 'error', payload: data, duration, headers: { 'Content-Type': 'application/json' }, body: requestBody });
                if (!response.ok || !data.data?.resultImageUrl) throw new Error(data.message || 'ƒê·ªïi m·∫∑t th·∫•t b·∫°i');

                // Reload results from server to ensure we have the saved result with correct profile_id
                console.log('[FaceSwap] Face swap successful, reloading results gallery');
                await loadGallery('results');
                
                // Find the newly created result in the loaded items
                const loadedResults = galleries.results.state.items;
                const newResult = loadedResults.find(r => r.result_url === data.data.resultImageUrl) || 
                                 { id: data.data.id || `result-${Date.now()}`, result_url: data.data.resultImageUrl, image_url: data.data.resultImageUrl, created_at: new Date().toISOString() };
                
                displayResultInPreview(newResult.image_url);
                updateResultsCount();
                showStatusMessage('T·∫°o ƒë·ªïi m·∫∑t th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatusMessage(`T·∫°o ƒë·ªïi m·∫∑t th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('loading');
                hideLoading();
                updateGenerateButton();
                updateImageOperationButtons();
            }
        }

        async function generateBackground() {
            const presetSelected = galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            const selfieArray = Array.isArray(selfieSelected) ? selfieSelected : (selfieSelected ? [selfieSelected] : []);
            const additionalPromptInput = document.getElementById('additional-prompt');
            const customPrompt = additionalPromptInput?.value.trim() || '';
            
            if (!presetSelected && !customPrompt) { 
                showStatusMessage('Vui l√≤ng ch·ªçn m·∫´u (preset) ho·∫∑c nh·∫≠p prompt t√πy ch·ªânh ƒë·ªÉ t·∫°o n·ªÅn AI.', 'error'); 
                return; 
            }
            if (presetSelected && customPrompt) {
                // When both preset and custom prompt are provided, use custom prompt as additional_prompt for merge
                // This allows users to use custom prompt as additional instructions when preset is selected
            }
            if (selfieArray.length === 0) { showStatusMessage('Vui l√≤ng ch·ªçn selfie tr∆∞·ªõc khi t·∫°o n·ªÅn AI.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫°o n·ªÅn AI.', 'error'); return; }

            const selectedSelfie = selfieArray[0];

            showLoading('ƒêang t·∫°o n·ªÅn AI...');

            try {
                const aspectRatioSelect = document.getElementById('aspect-ratio');
                const selectedAspectRatio = aspectRatioSelect?.value || localStorage.getItem('faceswap:aspectRatio') || '3:4';
                const modelSelect = document.getElementById('gemini-model');
                const selectedModel = modelSelect?.value || localStorage.getItem('faceswap:model') || '2.5';
                const useSelfieUrl = !selectedSelfie.id || selectedSelfie.id?.startsWith('result-selfie-');
                
                const requestBody = {
                    ...(customPrompt && !presetSelected
                        ? { custom_prompt: customPrompt }
                        : (() => {
                            if (!presetSelected) return {};
                            const usePresetUrl = !presetSelected.id || presetSelected.id?.startsWith('result-preset-');
                            return usePresetUrl 
                                ? { preset_image_url: presetSelected.image_url }
                                : { preset_image_id: presetSelected.id };
                        })()
                    ),
                    ...(useSelfieUrl 
                        ? { selfie_image_url: selectedSelfie.image_url }
                        : { selfie_id: selectedSelfie.id }
                    ),
                    profile_id: window.profileManager.currentProfile.id,
                    ...(presetSelected && customPrompt ? { additional_prompt: customPrompt } : {}),
                    aspect_ratio: selectedAspectRatio,
                    model: selectedModel
                };

                const backgroundUrl = `${WORKER_URL}/background`;
                const startTime = Date.now();
                const response = await fetch(backgroundUrl, { method: 'POST', headers: buildHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(requestBody) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label: 'N·ªÅn AI', method: 'POST', url: '/background', fullUrl: backgroundUrl, status: response.ok ? 'success' : 'error', payload: data, duration, headers: { 'Content-Type': 'application/json' }, body: requestBody });
                if (!response.ok || !data.data?.resultImageUrl) throw new Error(data.message || 'T·∫°o n·ªÅn AI th·∫•t b·∫°i');

                await loadGallery('results');
                
                const loadedResults = galleries.results.state.items;
                const newResult = loadedResults.find(r => r.result_url === data.data.resultImageUrl) || 
                                 { id: data.data.id || `result-${Date.now()}`, result_url: data.data.resultImageUrl, image_url: data.data.resultImageUrl, created_at: new Date().toISOString() };
                
                displayResultInPreview(newResult.image_url);
                updateResultsCount();
                showStatusMessage('T·∫°o n·ªÅn AI th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatusMessage(`T·∫°o n·ªÅn AI th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function runImageOperation(label, endpoint, extra = {}) {
            const selfieSelected = galleries.selfie.state.selected;
            const selfieArray = Array.isArray(selfieSelected) ? selfieSelected : (selfieSelected ? [selfieSelected] : []);
            if (selfieArray.length === 0) { showStatusMessage('Ch·ªçn selfie ƒë·ªÉ ch·∫°y API.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('H·ªì s∆° ch∆∞a s·∫µn s√†ng.', 'error'); return; }

            // Use the first selfie for image operations
            const selectedSelfie = selfieArray[0];

            showLoading(label);
            try {
                const aspectRatioSelect = document.getElementById('aspect-ratio');
                const selectedAspectRatio = aspectRatioSelect?.value || localStorage.getItem('faceswap:aspectRatio') || 'original';
                const modelSelect = document.getElementById('gemini-model');
                const selectedModel = modelSelect?.value || localStorage.getItem('faceswap:model') || '2.5';
                console.log(`[${label}] Aspect ratio select value:`, aspectRatioSelect?.value);
                console.log(`[${label}] Selected aspect ratio:`, selectedAspectRatio);
                console.log(`[${label}] Selected model:`, selectedModel);

                const payload = {
                    image_url: selectedSelfie.image_url,
                    profile_id: window.profileManager.currentProfile.id,
                    aspect_ratio: selectedAspectRatio === 'original' ? 'original' : selectedAspectRatio,
                    model: selectedModel,
                    ...extra
                };
                console.log(`[${label}] Full request body:`, JSON.stringify(payload, null, 2));
                console.log(`[${label}] Sending request with aspect_ratio:`, payload.aspect_ratio);
                
                const startTime = Date.now();
                const operationUrl = `${WORKER_URL}/${endpoint}`;
                const response = await fetch(operationUrl, { method: 'POST', headers: buildHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(payload) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label, method: 'POST', url: `/${endpoint}`, fullUrl: operationUrl, status: response.ok ? 'success' : 'error', payload: data, duration, headers: { 'Content-Type': 'application/json' }, body: payload });
                if (!response.ok || !data?.data?.resultImageUrl) throw new Error(data.message || `${label} th·∫•t b·∫°i`);

                displayResultInPreview(data.data.resultImageUrl);
                showStatusMessage(`${label} th√†nh c√¥ng`, 'success');
                await loadGallery('results');
                updateResultsCount();
            } catch (error) {
                showStatusMessage(`${label} th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function runEnhance() { runImageOperation('N√¢ng C·∫•p (Enhance)', 'enhance'); }
        function runBeauty() { runImageOperation('L√†m ƒê·∫πp (Beauty)', 'beauty'); }
        function runUpscale4k() {
            const selfieSelected = galleries.selfie.state.selected;
            const selfieArray = Array.isArray(selfieSelected) ? selfieSelected : (selfieSelected ? [selfieSelected] : []);
            if (selfieArray.length === 0) {
                showStatusMessage('Ch·ªçn selfie ƒë·ªÉ ch·∫°y API.', 'error');
                return;
            }
            const selectedSelfie = selfieArray[0];
            // Validate that the selected selfie has action="4k" or "4K"
            const selfieAction = selectedSelfie.action?.toLowerCase();
            if (!selfieAction || selfieAction !== '4k') {
                showStatusMessage('Ch·ªâ c√≥ th·ªÉ s·ª≠ d·ª•ng selfie v·ªõi action="4k" cho 4K Upscale. Vui l√≤ng upload selfie m·ªõi v·ªõi action="4k" (ch·ªçn "4K Upscale (Max 1)" trong dropdown Action khi upload) ho·∫∑c ch·ªçn selfie kh√°c c√≥ action="4k".', 'error');
                return;
            }
            runImageOperation('N√¢ng C·∫•p 4K (4K Upscale)', 'upscaler4k');
        }
        function runRestore() { runImageOperation('Kh√¥i Ph·ª•c (Restore)', 'restore'); }
        function runAging() { runImageOperation('L√£o H√≥a (Aging)', 'aging', { age_years: parseInt($('aging-years')?.value || '20', 10) }); }
        
        async function runFilter() {
            const presetSelected = galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            const selfieArray = Array.isArray(selfieSelected) ? selfieSelected : (selfieSelected ? [selfieSelected] : []);
            
            if (!presetSelected) { showStatusMessage('Vui l√≤ng ch·ªçn m·∫´u (preset) tr∆∞·ªõc khi √°p d·ª•ng b·ªô l·ªçc.', 'error'); return; }
            if (selfieArray.length === 0) { showStatusMessage('Vui l√≤ng ch·ªçn selfie tr∆∞·ªõc khi √°p d·ª•ng b·ªô l·ªçc.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi √°p d·ª•ng b·ªô l·ªçc.', 'error'); return; }

            const selectedSelfie = selfieArray[0];

            showLoading('ƒêang √°p d·ª•ng b·ªô l·ªçc...');

            try {
                const aspectRatioSelect = document.getElementById('aspect-ratio');
                const selectedAspectRatio = aspectRatioSelect?.value || localStorage.getItem('faceswap:aspectRatio') || '3:4';
                const modelSelect = document.getElementById('gemini-model');
                const selectedModel = modelSelect?.value || localStorage.getItem('faceswap:model') || '2.5';
                const usePresetUrl = !presetSelected.id || presetSelected.id?.startsWith('result-preset-');
                const useSelfieUrl = !selectedSelfie.id || selectedSelfie.id?.startsWith('result-selfie-');
                const additionalPromptInput = document.getElementById('additional-prompt');
                const requestBody = {
                    ...(usePresetUrl 
                        ? { preset_image_url: presetSelected.image_url }
                        : { preset_image_id: presetSelected.id }
                    ),
                    ...(useSelfieUrl 
                        ? { selfie_image_url: selectedSelfie.image_url }
                        : { selfie_id: selectedSelfie.id }
                    ),
                    profile_id: window.profileManager.currentProfile.id,
                    additional_prompt: additionalPromptInput?.value.trim() || '',
                    aspect_ratio: selectedAspectRatio,
                    model: selectedModel
                };

                const filterUrl = `${WORKER_URL}/filter`;
                const startTime = Date.now();
                const response = await fetch(filterUrl, { method: 'POST', headers: buildHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(requestBody) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label: 'B·ªô L·ªçc (Filter)', method: 'POST', url: '/filter', fullUrl: filterUrl, status: response.ok ? 'success' : 'error', payload: data, duration, headers: { 'Content-Type': 'application/json' }, body: requestBody });
                if (!response.ok || !data.data?.resultImageUrl) throw new Error(data.message || '√Åp d·ª•ng b·ªô l·ªçc th·∫•t b·∫°i');

                await loadGallery('results');
                
                const loadedResults = galleries.results.state.items;
                const newResult = loadedResults.find(r => r.result_url === data.data.resultImageUrl) || 
                                 { id: data.data.id || `result-${Date.now()}`, result_url: data.data.resultImageUrl, image_url: data.data.resultImageUrl, created_at: new Date().toISOString() };
                
                displayResultInPreview(newResult.image_url);
                updateResultsCount();
                showStatusMessage('√Åp d·ª•ng b·ªô l·ªçc th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatusMessage(`√Åp d·ª•ng b·ªô l·ªçc th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                hideLoading();
                updateImageOperationButtons();
            }
        }

        function displayResultInPreview(imageUrl) {
            const resultPreview = $('result-preview');
            if (resultPreview && imageUrl) {
                resultPreview.innerHTML = `<img src="${imageUrl}" alt="Result" style="cursor: pointer;" onclick="openPreviewLightbox('result')">`;
            }
        }

        // Lightbox
        let lightboxCurrentIndex = -1, lightboxItems = [];
        let lightboxKeyboardHandler = null;
        let lightboxMode = 'gallery'; // 'gallery' for results gallery, 'preview' for preset/selfie/result preview
        let comparisonItems = [];
        const COMPARISON_STORAGE_KEY = 'faceswap_comparison_items';
        
        // Load comparison from localStorage
        function loadComparisonFromStorage() {
            try {
                const stored = localStorage.getItem(COMPARISON_STORAGE_KEY);
                if (stored) {
                    comparisonItems = JSON.parse(stored);
                } else {
                    comparisonItems = [];
                }
            } catch (e) {
                comparisonItems = [];
            }
        }
        
        // Save comparison to localStorage
        function saveComparisonToStorage() {
            try {
                localStorage.setItem(COMPARISON_STORAGE_KEY, JSON.stringify(comparisonItems));
                updateComparisonButton();
            } catch (e) {
                console.error('Failed to save comparison to storage:', e);
            }
        }
        
        // Update comparison button count
        function updateComparisonButton() {
            const btn = $('comparison-count');
            if (btn) {
                btn.textContent = comparisonItems.length;
            }
        }
        
        // Initialize comparison on page load
        loadComparisonFromStorage();
        updateComparisonButton();

        function openLightbox(index) {
            lightboxMode = 'gallery';
            lightboxItems = galleries.results.state.items;
            if (index >= 0 && index < lightboxItems.length) {
                lightboxCurrentIndex = index;
                updateLightbox();
                setupLightboxKeyboard();
            }
        }

        function openPreviewLightbox(startType, selfieIndex) {
            lightboxMode = 'preview';
            lightboxItems = [];
            
            const presetSelected = galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            const resultPreview = $('result-preview');
            const resultImg = resultPreview?.querySelector('img');
            const resultUrl = resultImg?.src;
            
            if (presetSelected) {
                lightboxItems.push({
                    type: 'preset',
                    image_url: presetSelected.image_url,
                    label: 'M·∫´u (Preset)'
                });
            }
            if (selfieSelected) {
                if (Array.isArray(selfieSelected)) {
                    // Add all selected selfies
                    selfieSelected.forEach((selfie, index) => {
                        lightboxItems.push({
                            type: 'selfie',
                            image_url: selfie.image_url,
                            label: `·∫¢nh T·ª± S∆∞·ªõng ${index + 1} (Selfie ${index + 1})`
                        });
                    });
                } else {
                    lightboxItems.push({
                        type: 'selfie',
                        image_url: selfieSelected.image_url,
                        label: '·∫¢nh T·ª± S∆∞·ªõng (Selfie)'
                    });
                }
            }
            if (resultUrl && resultUrl !== '' && !resultUrl.includes('data:image/svg') && resultUrl !== window.location.href) {
                lightboxItems.push({
                    type: 'result',
                    image_url: resultUrl,
                    label: 'K·∫øt Qu·∫£ (Result)'
                });
            }
            
            if (lightboxItems.length === 0) return;
            
            // If selfieIndex is provided and we have multiple selfies, start at that selfie
            if (startType === 'selfie' && typeof selfieIndex === 'number' && Array.isArray(selfieSelected)) {
                const presetOffset = presetSelected ? 1 : 0;
                lightboxCurrentIndex = presetOffset + selfieIndex;
            } else {
                const startIndex = lightboxItems.findIndex(item => item.type === startType);
                lightboxCurrentIndex = startIndex >= 0 ? startIndex : 0;
            }
            updateLightbox();
            setupLightboxKeyboard();
        }

        function closeLightbox() {
            $('lightbox').style.display = 'none';
            lightboxCurrentIndex = -1;
            lightboxItems = [];
            lightboxMode = 'gallery';
            removeLightboxKeyboard();
            // Reset to single view when closing
            const comparisonContainer = $('lightbox-comparison');
            const singleView = $('lightbox-single');
            if (comparisonContainer && singleView) {
                comparisonContainer.style.display = 'none';
                singleView.style.display = 'flex';
            }
        }

        function lightboxNavigate(delta) {
            if (lightboxItems.length) {
                lightboxCurrentIndex = (lightboxCurrentIndex + delta + lightboxItems.length) % lightboxItems.length;
                updateLightbox();
            }
        }

        function setupLightboxKeyboard() {
            if (lightboxKeyboardHandler) return;
            lightboxKeyboardHandler = (e) => {
                if (e.key === 'Escape') {
                    closeLightbox();
                } else if (e.key === 'ArrowLeft') {
                    lightboxNavigate(-1);
                } else if (e.key === 'ArrowRight') {
                    lightboxNavigate(1);
                }
            };
            document.addEventListener('keydown', lightboxKeyboardHandler);
        }

        function removeLightboxKeyboard() {
            if (lightboxKeyboardHandler) {
                document.removeEventListener('keydown', lightboxKeyboardHandler);
                lightboxKeyboardHandler = null;
            }
        }

        function updateLightbox() {
            const lightbox = $('lightbox'), img = $('lightbox-image'), counter = $('lightbox-counter');
            const actions = $('lightbox-actions');
            const addToComparisonBtn = $('add-to-comparison-btn');
            if (!lightbox || lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxItems.length) return;
            const item = lightboxItems[lightboxCurrentIndex];
            const imageUrl = item.result_url || item.image_url || '';
            
            if (lightboxMode === 'preview') {
                img.src = item.image_url || '';
                if (counter) counter.textContent = `${item.label} (${lightboxCurrentIndex + 1} / ${lightboxItems.length})`;
                if (actions) actions.style.display = item.type === 'result' ? 'flex' : 'flex';
            } else {
                img.src = imageUrl;
                if (counter) counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxItems.length}`;
                if (actions) actions.style.display = 'flex';
            }
            
            // Update add to comparison button state
            if (addToComparisonBtn) {
                const isInComparison = comparisonItems.some(ci => ci.image_url === imageUrl);
                if (isInComparison) {
                    addToComparisonBtn.innerHTML = '<span>‚úì</span><span>ƒê√£ Th√™m</span>';
                    addToComparisonBtn.disabled = true;
                    addToComparisonBtn.style.opacity = '0.6';
                } else {
                    addToComparisonBtn.innerHTML = '<span>‚ûï</span><span>Th√™m v√†o So S√°nh</span>';
                    addToComparisonBtn.disabled = false;
                    addToComparisonBtn.style.opacity = '1';
                }
            }
            
            document.querySelector('.lightbox-prev').disabled = lightboxItems.length <= 1;
            document.querySelector('.lightbox-next').disabled = lightboxItems.length <= 1;
            lightbox.style.display = 'flex';
        }
        
        function addToComparison() {
            if (lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxItems.length) return;
            const item = lightboxItems[lightboxCurrentIndex];
            const imageUrl = item.result_url || item.image_url || '';
            if (!imageUrl) {
                showStatusMessage('Kh√¥ng t√¨m th·∫•y URL h√¨nh ·∫£nh', 'error');
                return;
            }
            
            // Check if already in comparison
            if (comparisonItems.some(ci => ci.image_url === imageUrl)) {
                showStatusMessage('H√¨nh ·∫£nh ƒë√£ c√≥ trong danh s√°ch so s√°nh', 'info');
                return;
            }
            
            // Add to comparison (max 3 items)
            if (comparisonItems.length >= 3) {
                showStatusMessage('Ch·ªâ c√≥ th·ªÉ so s√°nh t·ªëi ƒëa 3 h√¨nh ·∫£nh. Vui l√≤ng x√≥a m·ªôt h√¨nh tr∆∞·ªõc.', 'error');
                return;
            }
            
            const comparisonItem = {
                image_url: imageUrl,
                label: item.label || `H√¨nh ${comparisonItems.length + 1}`,
                type: item.type || 'result',
                added_at: Date.now()
            };
            
            comparisonItems.push(comparisonItem);
            saveComparisonToStorage();
            updateLightbox();
            updateComparisonButton();
            showStatusMessage(`ƒê√£ th√™m v√†o so s√°nh (${comparisonItems.length}/3)`, 'success');
        }
        
        function removeFromComparison(index) {
            if (index >= 0 && index < comparisonItems.length) {
                comparisonItems.splice(index, 1);
                saveComparisonToStorage();
                updateComparisonButton();
                renderComparison();
                showStatusMessage('ƒê√£ x√≥a kh·ªèi so s√°nh', 'success');
            }
        }
        
        function clearComparison() {
            if (comparisonItems.length === 0) return;
            comparisonItems = [];
            saveComparisonToStorage();
            updateComparisonButton();
            renderComparison();
            showStatusMessage('ƒê√£ x√≥a t·∫•t c·∫£ h√¨nh ·∫£nh so s√°nh', 'success');
        }
        
        function renderComparison() {
            const comparisonContainer = $('lightbox-comparison');
            const comparisonGrid = $('comparison-grid');
            const singleView = $('lightbox-single');
            
            if (!comparisonContainer || !comparisonGrid) return;
            
            if (comparisonItems.length === 0) {
                comparisonContainer.style.display = 'none';
                if (singleView) singleView.style.display = 'flex';
                comparisonGrid.innerHTML = '';
                return;
            }
            
            // Show comparison view
            comparisonContainer.style.display = 'flex';
            if (singleView) singleView.style.display = 'none';
            
            // Update grid class based on count
            comparisonGrid.className = 'comparison-grid';
            if (comparisonItems.length === 2) {
                comparisonGrid.classList.add('compare-2');
            } else if (comparisonItems.length === 3) {
                comparisonGrid.classList.add('compare-3');
            }
            
            // Render items
            comparisonGrid.innerHTML = comparisonItems.map((item, index) => `
                <div class="comparison-item">
                    <button class="comparison-item-remove" onclick="removeFromComparison(${index})" title="X√≥a">√ó</button>
                    <img src="${item.image_url}" alt="${item.label}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'200\\'%3E%3Crect fill=\\'%23ccc\\' width=\\'200\\' height=\\'200\\'/%3E%3Ctext fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'14\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3EL·ªói t·∫£i h√¨nh%3C/text%3E%3C/svg%3E';">
                    <div class="comparison-item-label">${item.label}</div>
                </div>
            `).join('');
        }
        
        function switchToComparisonView() {
            const comparisonContainer = $('lightbox-comparison');
            const singleView = $('lightbox-single');
            if (comparisonContainer && singleView) {
                singleView.style.display = 'none';
                comparisonContainer.style.display = 'flex';
                renderComparison();
            }
        }
        
        function switchToSingleView() {
            const comparisonContainer = $('lightbox-comparison');
            const singleView = $('lightbox-single');
            if (comparisonContainer && singleView) {
                comparisonContainer.style.display = 'none';
                singleView.style.display = 'flex';
                updateLightbox();
            }
        }
        
        // Add button to show comparison view from lightbox
        function showComparisonView() {
            if (comparisonItems.length === 0) {
                showStatusMessage('Ch∆∞a c√≥ h√¨nh ·∫£nh n√†o trong danh s√°ch so s√°nh. Vui l√≤ng th√™m h√¨nh ·∫£nh t·ª´ lightbox tr∆∞·ªõc.', 'info');
                return;
            }
            $('lightbox').style.display = 'flex';
            switchToComparisonView();
            setupLightboxKeyboard();
        }
        
        window.addToComparison = addToComparison;
        window.removeFromComparison = removeFromComparison;
        window.clearComparison = clearComparison;
        window.switchToSingleView = switchToSingleView;
        window.showComparisonView = showComparisonView;

        window.openPreviewLightbox = openPreviewLightbox;

        async function uploadImageFromUrl(imageUrl, type) {
            if (!window.profileManager.currentProfile) {
                showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫£i l√™n h√¨nh ·∫£nh.', 'error');
                return;
            }

            showLoading(`ƒêang t·∫£i ${type === 'preset' ? 'm·∫´u' : 'selfie'} t·ª´ URL...`);

            const config = galleries[type];
            const dropZone = $(type + '-drop-zone');
            dropZone?.classList.add('loading');

            try {
                const requestBody = {
                    image_url: imageUrl,
                    type: type,
                    profile_id: window.profileManager.currentProfile.id,
                    presetName: type === 'preset' ? `Preset ${Date.now()}` : undefined,
                    enableVertexPrompt: type === 'preset',
                };
                
                if (type === 'selfie') {
                    const actionSelect = document.getElementById('selfie-action-select');
                    const action = actionSelect?.value || 'faceswap';
                    requestBody.action = action;
                }

                const uploadUrl = `${WORKER_URL}/upload-url`;
                const startTime = Date.now();
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify(requestBody)
                });
                const data = await uploadResponse.json();
                const duration = Date.now() - startTime;

                logApiCall({ 
                    label: `T·∫£i L√™n ${config.logName}`, 
                    method: 'POST', 
                    url: '/upload-url',
                    fullUrl: uploadUrl,
                    status: uploadResponse.ok ? 'success' : 'error', 
                    payload: data, 
                    duration,
                    headers: { 'Content-Type': 'application/json' },
                    body: requestBody
                });

                if (!uploadResponse.ok || data.status !== 'success') {
                    const errorMsg = data.message || 'T·∫£i l√™n th·∫•t b·∫°i';
                    const error = new Error(errorMsg);
                    if (data.debug) {
                        error.debug = data.debug;
                    }
                    throw error;
                }

                // Handle new response format with data property
                const result = data.data?.results?.[0];
                if (!result || !result.id || !result.url) {
                    throw new Error('Upload response missing required data');
                }

                const newImage = { 
                    id: result.id, 
                    filename: result.filename, 
                    image_url: result.url, 
                    created_at: new Date().toISOString() 
                };
                config.state.items = [newImage, ...config.state.items.filter(e => e.id !== newImage.id)];
                config.state.page = 1;
                await loadGallery(type);
                setSelectedItem(type, newImage);
                showStatusMessage(`ƒê√£ ch·ªçn l√†m ${type === 'preset' ? 'm·∫´u' : 'selfie'} th√†nh c√¥ng!`, 'success');
                closeLightbox();
            } catch (error) {
                const errorMsg = error instanceof Error ? error.message : 'T·∫£i l√™n th·∫•t b·∫°i';
                const debugInfo = error?.debug;
                if (debugInfo) {
                    console.error('[Upload Error Debug]', debugInfo);
                }
                showStatusMessage(`T·∫£i l√™n th·∫•t b·∫°i: ${errorMsg}`, 'error');
            } finally {
                hideLoading();
                dropZone?.classList.remove('loading');
            }
        }

        async function selectAsPreset() {
            if (lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxItems.length) return;
            const item = lightboxItems[lightboxCurrentIndex];
            const imageUrl = item.result_url || item.image_url || '';
            if (!imageUrl) {
                showStatusMessage('Kh√¥ng t√¨m th·∫•y URL h√¨nh ·∫£nh', 'error');
                return;
            }
            const tempPreset = {
                image_url: imageUrl,
                filename: imageUrl.split('/').pop() || 'result.jpg',
                created_at: new Date().toISOString()
            };
            setSelectedItem('preset', tempPreset, { showMessage: true });
            showStatusMessage('ƒê√£ ch·ªçn l√†m m·∫´u th√†nh c√¥ng!', 'success');
            closeLightbox();
        }

        async function selectAsSelfie() {
            if (lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxItems.length) return;
            const item = lightboxItems[lightboxCurrentIndex];
            const imageUrl = item.result_url || item.image_url || '';
            if (!imageUrl) {
                showStatusMessage('Kh√¥ng t√¨m th·∫•y URL h√¨nh ·∫£nh', 'error');
                return;
            }
            const tempSelfie = {
                image_url: imageUrl,
                filename: imageUrl.split('/').pop() || 'result.jpg',
                created_at: new Date().toISOString()
            };
            setSelectedItem('selfie', tempSelfie, { showMessage: true });
            showStatusMessage('ƒê√£ ch·ªçn l√†m selfie th√†nh c√¥ng!', 'success');
            closeLightbox();
        }

        window.selectAsPreset = selectAsPreset;
        window.selectAsSelfie = selectAsSelfie;

        // Main Tab Switching
        function switchMainTab(tab) {
            // Hide all main tabs
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tab === 'faceswap') {
                $('faceswap-tab-content').classList.add('active');
                $('faceswap-tab-content').style.display = 'block';
                $('main-tab-faceswap').classList.add('active');
            } else if (tab === 'thumbnails') {
                $('thumbnails-tab-content').classList.add('active');
                $('thumbnails-tab-content').style.display = 'block';
                $('main-tab-thumbnails').classList.add('active');
                switchThumbnailSubTab('view');
                loadThumbnails();
            }
        }

        // Thumbnail Sub Tab Switching
        function switchThumbnailSubTab(tab) {
            // Hide all sub tabs
            document.querySelectorAll('.thumbnail-subtab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            document.querySelectorAll('.thumbnail-subtab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected sub tab
            if (tab === 'upload') {
                $('thumbnails-upload-section').classList.add('active');
                $('thumbnails-upload-section').style.display = 'block';
                $('thumbnail-subtab-upload').classList.add('active');
            } else if (tab === 'view') {
                $('thumbnails-view-section').classList.add('active');
                $('thumbnails-view-section').style.display = 'block';
                $('thumbnail-subtab-view').classList.add('active');
                loadThumbnails();
            }
        }

        async function loadThumbnails() {
            const startTime = Date.now();
            const url = `${WORKER_URL}/thumbnails`;
            try {
                const response = await fetch(url, { headers: buildHeaders() });
                const duration = Date.now() - startTime;
                const data = await response.json();
                
                logApiCall({
                    label: 'T·∫£i Danh S√°ch Thumbnails',
                    method: 'GET',
                    url: '/thumbnails',
                    fullUrl: url,
                    status: response.ok && data.status === 'success' ? 'success' : 'error',
                    payload: data,
                    duration
                });
                
                if (data.status === 'success' && data.data?.thumbnails) {
                    renderThumbnails(data.data.thumbnails);
                } else {
                    showStatusMessage('Kh√¥ng th·ªÉ t·∫£i danh s√°ch thumbnails', 'error');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                console.error('Failed to load thumbnails:', error);
                logApiCall({
                    label: 'T·∫£i Danh S√°ch Thumbnails',
                    method: 'GET',
                    url: '/thumbnails',
                    fullUrl: url,
                    status: 'error',
                    duration
                });
                showStatusMessage('Kh√¥ng th·ªÉ t·∫£i danh s√°ch thumbnails', 'error');
            }
        }

        function renderThumbnails(thumbnails) {
            const container = $('thumbnail-list');
            if (!container) return;
            
            if (thumbnails.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">Ch∆∞a c√≥ thumbnail n√†o. H√£y t·∫£i l√™n th∆∞ m·ª•c ch·ª©a thumbnails.</p>';
                return;
            }
            
            // Display raw JSON
            container.innerHTML = `<pre style="background: var(--bg-primary); padding: 16px; border-radius: 8px; border: 1px solid var(--border); overflow-x: auto; font-family: 'Courier New', monospace; font-size: 12px; color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(thumbnails, null, 2)}</pre>`;
        }

        async function selectThumbnail(presetId) {
            if (!presetId) {
                showStatusMessage('Thumbnail ch∆∞a ƒë∆∞·ª£c li√™n k·∫øt v·ªõi preset', 'error');
                return;
            }
            // Load preset and set as selected
            try {
                const response = await fetch(`${WORKER_URL}/presets/${presetId}`, { headers: buildHeaders() });
                const data = await response.json();
                if (data && data.image_url) {
                    const tempPreset = {
                        id: presetId,
                        image_url: data.image_url,
                        filename: data.filename,
                        created_at: new Date().toISOString()
                    };
                    setSelectedItem('preset', tempPreset, { showMessage: true });
                    showStatusMessage('ƒê√£ ch·ªçn preset t·ª´ thumbnail', 'success');
                    switchMainTab('faceswap');
                }
            } catch (error) {
                showStatusMessage('Kh√¥ng th·ªÉ t·∫£i preset', 'error');
            }
        }

        async function getPresetFromThumbnail(thumbnailId) {
            if (!thumbnailId) {
                showStatusMessage('Thumbnail ID kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }
            try {
                const startTime = Date.now();
                const url = `${WORKER_URL}/thumbnails/${thumbnailId}/preset`;
                const response = await fetch(url);
                const duration = Date.now() - startTime;
                const data = await response.json();
                logApiCall({
                    label: 'L·∫•y Preset t·ª´ Thumbnail',
                    method: 'GET',
                    url: `/thumbnails/${thumbnailId}/preset`,
                    fullUrl: url,
                    status: response.ok ? 'success' : 'error',
                    payload: data,
                    duration
                });
                if (!response.ok) throw new Error(data.message || `HTTP ${response.status}`);
                if (data.data?.preset_id) {
                    await selectThumbnail(data.data.preset_id);
                } else {
                    showStatusMessage('Kh√¥ng t√¨m th·∫•y preset t·ª´ thumbnail', 'error');
                }
            } catch (error) {
                showStatusMessage(`L·ªói khi l·∫•y preset t·ª´ thumbnail: ${error.message}`, 'error');
            }
        }

        async function loadConfig() {
            showLoading('ƒêang t·∫£i c·∫•u h√¨nh...');
            try {
                const startTime = Date.now();
                const url = `${WORKER_URL}/config`;
                const response = await fetch(url);
                const duration = Date.now() - startTime;
                const data = await response.json();
                logApiCall({
                    label: 'L·∫•y C·∫•u H√¨nh',
                    method: 'GET',
                    url: '/config',
                    fullUrl: url,
                    status: response.ok ? 'success' : 'error',
                    payload: data,
                    duration
                });
                if (!response.ok) throw new Error(data.message || `HTTP ${response.status}`);
                const configInfo = JSON.stringify(data.data, null, 2);
                alert(`C·∫•u h√¨nh Backend:\n\n${configInfo}\n\nXem chi ti·∫øt trong Nh·∫≠t K√Ω API`);
                showStatusMessage('ƒê√£ t·∫£i c·∫•u h√¨nh th√†nh c√¥ng', 'success');
            } catch (error) {
                showStatusMessage(`L·ªói khi t·∫£i c·∫•u h√¨nh: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function listAllProfiles() {
            showLoading('ƒêang t·∫£i danh s√°ch profiles...');
            try {
                const startTime = Date.now();
                const url = `${WORKER_URL}/profiles`;
                const response = await fetch(url);
                const duration = Date.now() - startTime;
                const data = await response.json();
                logApiCall({
                    label: 'Li·ªát K√™ Profiles',
                    method: 'GET',
                    url: '/profiles',
                    fullUrl: url,
                    status: response.ok ? 'success' : 'error',
                    payload: data,
                    duration
                });
                if (!response.ok) throw new Error(data.message || `HTTP ${response.status}`);
                const profiles = data.data?.profiles || [];
                const profilesInfo = profiles.length > 0
                    ? profiles.map(p => `ID: ${p.id}\nT√™n: ${p.name || 'N/A'}\nEmail: ${p.email || 'N/A'}\nDevice: ${p.device_id || 'N/A'}\n---`).join('\n')
                    : 'Ch∆∞a c√≥ profiles n√†o';
                alert(`T·ªïng s·ªë Profiles: ${profiles.length}\n\n${profilesInfo}\n\nXem chi ti·∫øt trong Nh·∫≠t K√Ω API`);
                showStatusMessage(`ƒê√£ t·∫£i ${profiles.length} profiles`, 'success');
            } catch (error) {
                showStatusMessage(`L·ªói khi t·∫£i danh s√°ch profiles: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function handleThumbnailZipSelect(event) {
            const zipFiles = Array.from(event.target.files || []);
            if (zipFiles.length === 0) return;
            await processThumbnailFiles(zipFiles, []);
            
            // Reset input
            event.target.value = '';
        }

        async function processThumbnailFiles(zipFiles, regularFiles) {
            const progressContainer = $('thumbnail-upload-progress');
            const progressFill = $('thumbnail-progress-fill');
            const statusText = $('thumbnail-upload-status');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            statusText.textContent = 'ƒêang x·ª≠ l√Ω file...';

            const formData = new FormData();
            
            // Send zip files DIRECTLY to backend (backend extracts and preserves folder paths)
            if (zipFiles.length > 0) {
                statusText.textContent = `ƒêang chu·∫©n b·ªã t·∫£i l√™n ${zipFiles.length} file zip...`;
                for (const zipFile of zipFiles) {
                    formData.append('files', zipFile);
                }
            }
            
            // Add regular files with their folder paths if available
            if (regularFiles.length > 0) {
                for (const file of regularFiles) {
                    formData.append('files', file);
                    // If file has webkitRelativePath (from folder upload), include it
                    if (file.webkitRelativePath) {
                        formData.append(`path_${file.name}`, file.webkitRelativePath);
                    }
                }
            }
            
            const totalFiles = zipFiles.length + regularFiles.length;
            if (totalFiles === 0) {
                statusText.textContent = 'Kh√¥ng c√≥ file n√†o ƒë·ªÉ t·∫£i l√™n';
                progressContainer.style.display = 'none';
                return;
            }

            statusText.textContent = zipFiles.length > 0 
                ? `ƒêang t·∫£i l√™n ${zipFiles.length} file zip (backend s·∫Ω gi·∫£i n√©n v√† x·ª≠ l√Ω)...`
                : `ƒêang t·∫£i l√™n ${regularFiles.length} file...`;
            progressFill.style.width = '10%';

            const uploadUrl = `${WORKER_URL}/upload-thumbnails`;
            const startTime = Date.now();
            try {
                progressFill.style.width = '30%';
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: buildHeaders(),
                    body: formData
                });

                const data = await response.json();
                const duration = Date.now() - startTime;
                
                logApiCall({
                    label: `T·∫£i L√™n Thumbnails (${zipFiles.length > 0 ? zipFiles.length + ' zip' : regularFiles.length + ' files'})`,
                    method: 'POST',
                    url: '/upload-thumbnails',
                    fullUrl: uploadUrl,
                    status: response.ok && data.status === 'success' ? 'success' : 'error',
                    payload: data,
                    duration,
                    body: formData
                });
                
                if (data.status === 'success') {
                    progressFill.style.width = '100%';
                    statusText.textContent = `Ho√†n th√†nh: ${data.data.successful}/${data.data.total} file th√†nh c√¥ng`;
                    
                    if (data.data.failed > 0) {
                        const failedFiles = data.data.results.filter(r => !r.success);
                        console.warn('Failed files:', failedFiles);
                        showStatusMessage(`${data.data.failed} file th·∫•t b·∫°i. Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt.`, 'error');
                    } else {
                        showStatusMessage('T·∫£i l√™n th√†nh c√¥ng!', 'success');
                    }
                    
                    // Reset inputs
                    const zipInput = $('thumbnail-zip-input');
                    if (zipInput) zipInput.value = '';
                    
                    // Switch to view sub tab and reload thumbnails
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        switchThumbnailSubTab('view');
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                logApiCall({
                    label: `T·∫£i L√™n Thumbnails (${zipFiles.length > 0 ? zipFiles.length + ' zip' : regularFiles.length + ' files'})`,
                    method: 'POST',
                    url: '/upload-thumbnails',
                    fullUrl: uploadUrl,
                    status: 'error',
                    payload: { error: error.message },
                    duration
                });
                progressFill.style.width = '100%';
                progressFill.style.background = 'var(--danger)';
                statusText.textContent = `L·ªói: ${error.message}`;
                showStatusMessage(`T·∫£i l√™n th·∫•t b·∫°i: ${error.message}`, 'error');
            }
        }

        function setupThumbnailDragDrop() {
            const dropZone = $('thumbnail-drop-zone');
            if (!dropZone) return;

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // Visual feedback
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = 'var(--accent)';
                    dropZone.style.background = 'var(--bg-tertiary)';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = 'var(--bg-primary)';
                }, false);
            });

            // Handle drop
            dropZone.addEventListener('drop', async (e) => {
                const items = Array.from(e.dataTransfer.items || []);
                const zipFiles = [];
                const regularFiles = [];

                for (const item of items) {
                    if (item.kind === 'file') {
                        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                        const file = item.getAsFile();

                        if (file) {
                            if (file.name.toLowerCase().endsWith('.zip')) {
                                zipFiles.push(file);
                            } else if (entry && entry.isDirectory) {
                                // Directory not supported - show message
                                showStatusMessage('Th∆∞ m·ª•c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Vui l√≤ng n√©n th√†nh file zip.', 'info');
                            } else {
                                regularFiles.push(file);
                            }
                        }
                    }
                }

                // Process files
                if (zipFiles.length > 0 || regularFiles.length > 0) {
                    await processThumbnailFiles(zipFiles, regularFiles);
                }
            }, false);
        }

        window.switchMainTab = switchMainTab;
        window.switchThumbnailSubTab = switchThumbnailSubTab;
        window.handleThumbnailZipSelect = handleThumbnailZipSelect;
        window.selectThumbnail = selectThumbnail;

        // UI Helpers
        function showLoading(text = 'ƒêang t·∫£i d·ªØ li·ªáu') {
            const overlay = $('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
                const textEl = overlay.querySelector('.loading-text');
                if (textEl) textEl.textContent = text;
                startLoadingTimer();
            }
        }

        function hideLoading() {
            const overlay = $('loading-overlay');
            if (overlay) overlay.style.display = 'none';
            stopLoadingTimer();
        }

        function showStatusMessage(message, type = 'info') {
            document.querySelectorAll('.status-message').forEach(m => m.remove());
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.innerHTML = `${message}<button class="status-close" onclick="this.parentElement.remove()">√ó</button>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }


        // Initialize
        async function init() {
            showLoading('ƒêang t·∫£i d·ªØ li·ªáu');
            try {
                await loadGallery('preset');
                // Selfie and results are already loaded by initializeProfile(), no need to load again
                updateResultsCount();
                updateGenerateButton();
                updateImageOperationButtons();
            } finally {
                hideLoading();
            }
        }

        // Prevent zoom gestures on mobile and auto-reset zoom
        function preventZoom() {
            let lastTouchEnd = 0;
            let lastTouchStart = 0;
            let touchStartTime = 0;
            let touchCount = 0;
            
            // Monitor and reset zoom level
            function resetZoom() {
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=375, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
                
                // Force reset using document.body.style.zoom (if supported)
                if (document.body.style.zoom !== undefined) {
                    document.body.style.zoom = '1';
                }
                
                // Force reset using transform scale
                const currentScale = window.visualViewport ? window.visualViewport.scale : 1;
                if (currentScale !== 1) {
                    document.documentElement.style.transform = 'scale(1)';
                    document.documentElement.style.transformOrigin = 'top left';
                }
            }
            
            // Continuously monitor and reset zoom
            setInterval(resetZoom, 100);
            
            // Reset on any touch event
            document.addEventListener('touchstart', function(event) {
                touchCount = event.touches.length;
                touchStartTime = Date.now();
                
                if (event.touches.length > 1) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
                
                // Prevent if too quick (double tap)
                const timeSinceLastTouch = Date.now() - lastTouchStart;
                if (timeSinceLastTouch < 300 && timeSinceLastTouch > 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
                lastTouchStart = Date.now();
            }, { passive: false, capture: true });
            
            // Prevent double-tap zoom
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                const timeSinceStart = now - touchStartTime;
                
                if (timeSinceStart < 300 && touchCount === 1) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
                
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
                lastTouchEnd = now;
                touchCount = 0;
            }, { passive: false, capture: true });
            
            // Prevent gesture zoom (iOS Safari)
            document.addEventListener('gesturestart', function(event) {
                event.preventDefault();
                event.stopPropagation();
                resetZoom();
                return false;
            }, { passive: false, capture: true });
            
            document.addEventListener('gesturechange', function(event) {
                event.preventDefault();
                event.stopPropagation();
                resetZoom();
                return false;
            }, { passive: false, capture: true });
            
            document.addEventListener('gestureend', function(event) {
                event.preventDefault();
                event.stopPropagation();
                resetZoom();
                return false;
            }, { passive: false, capture: true });
            
            // Prevent pinch zoom during move
            document.addEventListener('touchmove', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
            }, { passive: false, capture: true });
            
            // Prevent wheel zoom
            document.addEventListener('wheel', function(event) {
                if (event.ctrlKey || event.metaKey) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
            }, { passive: false, capture: true });
            
            // Prevent keyboard zoom (Ctrl/Cmd + Plus/Minus)
            document.addEventListener('keydown', function(event) {
                if ((event.ctrlKey || event.metaKey) && (event.key === '+' || event.key === '-' || event.key === '=' || event.keyCode === 187 || event.keyCode === 189)) {
                    event.preventDefault();
                    event.stopPropagation();
                    resetZoom();
                    return false;
                }
            }, { passive: false, capture: true });
            
            // Reset on orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(resetZoom, 100);
            });
            
            // Reset on resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(resetZoom, 100);
            });
            
            // Initial reset
            resetZoom();
        }
        
        // Call preventZoom immediately, not just on DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', preventZoom);
        } else {
            preventZoom();
        }

        // Startup
        document.addEventListener('DOMContentLoaded', async () => {
            initAccessGate();
            setupDragDrop('preset');
            setupDragDrop('selfie');

            $('profile-id-input')?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); switchProfile(); } });
            
            // Add event listener for additional-prompt input to update button state (used as custom prompt for background)
            const additionalPromptInput = $('additional-prompt');
            if (additionalPromptInput) {
                additionalPromptInput.addEventListener('input', () => {
                    updateGenerateButton();
                });
                additionalPromptInput.addEventListener('keyup', () => {
                    updateGenerateButton();
                });
            }

            // Load saved aspect ratio from localStorage (default to 'original' for non-faceswap endpoints)
            const savedRatio = localStorage.getItem('faceswap:aspectRatio') || 'original';
            const aspectRatioSelect = document.getElementById('aspect-ratio');
            if (aspectRatioSelect) {
                aspectRatioSelect.value = savedRatio;
                console.log('[Init] Set aspect ratio select to:', savedRatio, 'Current value:', aspectRatioSelect.value);
                aspectRatioSelect.addEventListener('change', (e) => {
                    const newValue = e.target.value;
                    localStorage.setItem('faceswap:aspectRatio', newValue);
                    console.log('[Init] Aspect ratio changed to:', newValue);
                });
            } else {
                console.error('[Init] Aspect ratio select element not found during initialization!');
            }

            // Load saved model from localStorage
            let savedModel = localStorage.getItem('faceswap:model') || '2.5';
            // Migrate legacy '3' value to '3p' for backward compatibility
            if (savedModel === '3') {
                savedModel = '3p';
                localStorage.setItem('faceswap:model', savedModel);
            }
            const modelSelect = document.getElementById('gemini-model');
            if (modelSelect) {
                modelSelect.value = savedModel;
                console.log('[Init] Set model select to:', savedModel, 'Current value:', modelSelect.value);
                modelSelect.addEventListener('change', (e) => {
                    const newValue = e.target.value;
                    localStorage.setItem('faceswap:model', newValue);
                    console.log('[Init] Model changed to:', newValue);
                });
            } else {
                console.error('[Init] Model select element not found during initialization!');
            }

            // Initialize profile FIRST, then load galleries
            await window.profileManager.initializeProfile();
            await init();
            
            // Setup thumbnail drag and drop
            setupThumbnailDragDrop();
        });
    </script>
</body>
</html>
