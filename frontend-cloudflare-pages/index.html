<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Swap AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-secondary: #0ea5e9;
            --accent-strong: #7c3aed;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --shadow-soft: 0 4px 20px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 8px 30px rgba(15, 23, 42, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; margin: 0; padding: 0; }

        body {
            font-family: 'Lexend Deca', -apple-system, sans-serif;
            background: radial-gradient(circle at top, #FFE0F0 0%, #F4E5FF 35%, #FDFBFF 70%);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            border-top: 6px solid var(--accent);
        }

        body.locked { overflow: hidden; }
        body.locked .main-container { filter: blur(14px); pointer-events: none; user-select: none; }

        /* Access Gate */
        .access-gate {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at top, rgba(15, 11, 46, 0.85), rgba(10, 7, 30, 0.92));
            backdrop-filter: blur(18px);
            transition: opacity 0.3s, visibility 0.3s;
        }
        .access-gate.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .gate-card {
            width: min(420px, 90vw); padding: 32px; border-radius: 20px;
            background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 25px 60px rgba(18, 0, 56, 0.45);
            backdrop-filter: blur(26px);
            display: flex; flex-direction: column; gap: 18px; text-align: center;
        }
        .gate-title { font-size: 14px; font-weight: 700; letter-spacing: 1.2px; color: #fff; }
        .gate-subtitle { font-size: 14px; color: rgba(255,255,255,0.65); }
        .gate-input {
            width: 100%; padding: 14px 16px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(8, 3, 24, 0.35); color: #fff;
            font-size: 14px; letter-spacing: 4px; text-align: center; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .gate-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(248, 35, 135, 0.25); }
        .gate-button {
            width: 100%; height: 44px; padding: 0 24px; border-radius: 22px;
            background: linear-gradient(120deg, var(--accent), var(--accent-secondary));
            color: #fff; font-size: 14px; font-weight: 600; border: none; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .gate-button:hover { transform: translateY(-1px); box-shadow: 0 12px 25px rgba(248, 35, 135, 0.35); }
        .gate-error { min-height: 18px; font-size: 14px; color: var(--danger); }

        /* Main Layout */
        .main-container {
            width: 100%; padding: 16px 20px 40px;
            background: linear-gradient(135deg, #FFF7FB 0%, #EEF4FF 100%);
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255,255,255,0.4);
        }

        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; margin-bottom: 12px;
            border-bottom: 1px solid rgba(131, 94, 255, 0.2);
        }
        .app-header h1 { font-size: 14px; font-weight: 600; color: var(--text-primary); letter-spacing: 0.3px; }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

        /* Three Column Layout: Left Sidebar | Main Content | Log Panel */
        .app-layout {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 20px;
            min-height: calc(100vh - 120px);
            transition: all 0.3s;
        }
        .app-layout.log-hidden { grid-template-columns: 320px 1fr 0; gap: 20px 0; }
        .app-layout.log-hidden .log-panel { opacity: 0; transform: translateX(20px); pointer-events: none; overflow: hidden; padding: 0; width: 0; }

        /* Left Sidebar - Galleries */
        .sidebar-column {
            display: flex; flex-direction: column; gap: 12px;
            max-height: calc(100vh - 120px); overflow-y: auto;
        }
        .sidebar-column::-webkit-scrollbar { width: 4px; }
        .sidebar-column::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

        .sidebar-section { border: 1px solid #e0e0e0; background: #fff; }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-bottom: 1px solid #e0e0e0;
            font-weight: 600; font-size: 14px; background: #f5f5f5;
        }
        .gallery-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .sidebar-content { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-content.collapsed { display: none; }

        .sidebar-gallery {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .gallery-drop-zone {
            position: relative; border: 1px dashed #ccc; background: #fafafa; padding: 8px;
        }
        .gallery-drop-zone.dragover { border-color: #999; border-style: solid; background: #f0f0f0; }

        /* Main Content Area */
        .main-content-area { display: flex; flex-direction: column; gap: 16px; }

        .preview-panel {
            display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px;
        }
        .preview-left-column { display: flex; flex-direction: column; gap: 12px; }
        .preview-card {
            display: flex; flex-direction: column; gap: 8px;
            background: #fff; border: 1px solid #e0e0e0;
        }
        .preview-card.preset-card, .preview-card.selfie-card { min-height: 320px; }
        .preview-card.result-card { min-height: 660px; grid-row: 1 / -1; }
        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid #e0e0e0; background: #f9f9f9;
        }
        .preview-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .preview-image {
            flex: 1; min-height: 200px; display: flex; align-items: center; justify-content: center;
            background: #fafafa; overflow: hidden; padding: 8px;
        }
        .preview-card.result-card .preview-image { min-height: 600px; }
        .preview-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .preview-empty { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--text-muted); text-align: center; }
        .preview-empty-icon { font-size: 32px; opacity: 0.5; }
        .preview-empty-text { font-size: 14px; }

        /* Action Panel */
        .action-panel {
            border: 1px solid #e0e0e0; padding: 12px 16px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 12px; background: #fafafa;
        }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .action-btn {
            height: 36px; padding: 0 16px; font-size: 13px; font-weight: 600;
            border: none; background: #4a90e2; color: #fff; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
            transition: all 0.2s; border-radius: 18px;
        }
        .action-btn:hover:not(:disabled) { background: #357abd; transform: translateY(-1px); }
        .action-btn.primary { background: var(--accent); }
        .action-btn.primary:hover:not(:disabled) { background: var(--accent-hover); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn.loading::after {
            content: ''; width: 12px; height: 12px; margin-left: 6px;
            border: 2px solid transparent; border-top-color: #fff;
            border-radius: 50%; animation: spin 0.6s linear infinite;
        }

        .action-options { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; width: 100%; }
        .action-prompt {
            flex: 1; min-width: 180px; height: 36px; padding: 0 12px;
            border: 1px solid #ccc; background: #fff; font-size: 14px;
        }
        .action-gender { display: flex; gap: 8px; align-items: center; }
        .action-gender label { font-size: 13px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .action-aging { display: flex; gap: 6px; align-items: center; }
        .action-aging input { width: 50px; height: 36px; padding: 0 8px; border: 1px solid #ccc; text-align: center; font-size: 14px; }

        /* History/Results Panel */
        .results-panel {
            border: 1px solid #e0e0e0; padding: 12px; background: #fff;
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; font-weight: 600; margin-bottom: 12px;
        }
        .results-count { font-weight: 400; color: var(--text-muted); }
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;
            max-height: 300px; overflow-y: auto;
        }

        /* Log Panel - Right Sidebar */
        .log-panel {
            background: rgba(255,255,255,0.9); border: 1px solid #e0e0e0;
            padding: 16px; display: flex; flex-direction: column;
            position: sticky; top: 20px; max-height: calc(100vh - 120px);
            overflow: hidden; transition: opacity 0.3s, transform 0.3s;
        }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 8px; }
        .log-title { font-size: 14px; font-weight: 600; color: var(--accent-strong); flex: 1; }
        .log-toggle-btn, .log-clear-btn {
            padding: 5px 12px; border: none; cursor: pointer;
            font-size: 13px; font-weight: 600; border-radius: 16px; transition: all 0.2s;
        }
        .log-toggle-btn { background: #4a90e2; color: #fff; }
        .log-toggle-btn:hover { background: #357abd; }
        .log-clear-btn { background: #ff6b6b; color: #fff; }
        .log-clear-btn:hover { background: #ee5a5a; }

        .api-log-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .api-log-entry {
            border: 1px solid #eee; padding: 10px; background: #fff; font-size: 13px;
        }
        .api-log-entry.log-error { border-left: 3px solid var(--danger); }
        .api-log-entry.log-success { border-left: 3px solid var(--success); }
        .api-log-entry.log-info { border-left: 3px solid var(--accent); }
        .api-log-entry-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .api-log-action { font-weight: 600; color: var(--text-primary); }
        .api-log-detail { font-size: 12px; color: var(--text-secondary); }
        .api-log-payload { margin-top: 6px; font-size: 11px; background: rgba(0,0,0,0.03); padding: 8px; overflow-x: auto; white-space: pre-wrap; }

        /* Gallery Items */
        .gallery-item {
            aspect-ratio: 1; overflow: hidden; background: #fff;
            border: 1px solid #e0e0e0; cursor: pointer; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gallery-item.selected { border-color: var(--accent); border-width: 2px; box-shadow: 0 4px 12px rgba(248, 35, 135, 0.2); }
        .gallery-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-soft); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-delete-btn {
            position: absolute; top: 4px; right: 4px; width: 22px; height: 22px;
            background: #d32f2f; color: #fff; border: none; border-radius: 11px;
            font-size: 14px; font-weight: 700; cursor: pointer; opacity: 0;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .gallery-item:hover .gallery-delete-btn { opacity: 1; }
        .gallery-delete-btn:hover { background: #b71c1c; }

        .gallery-upload-btn {
            width: 28px; height: 28px; border: none; background: var(--accent);
            color: #fff; cursor: pointer; font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border-radius: 14px; transition: all 0.2s;
        }
        .gallery-upload-btn:hover { background: var(--accent-hover); transform: scale(1.1); }

        .gender-filter-btn {
            height: 26px; padding: 0 10px; border: none; background: #e8e8e8;
            cursor: pointer; font-size: 12px; font-weight: 600; color: #555;
            border-radius: 13px; transition: all 0.2s;
        }
        .gender-filter-btn.active { background: #4a90e2; color: #fff; }
        .gender-filter-btn:hover { background: #d0d0d0; }

        /* Pagination */
        .pagination { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 12px; }
        .pagination-btn {
            width: 30px; height: 30px; padding: 0; background: #4a90e2; border: none;
            color: #fff; font-size: 12px; font-weight: 600; cursor: pointer;
            border-radius: 15px; transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) { background: #357abd; }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination-dots { display: flex; gap: 4px; }
        .pagination-dot { width: 8px; height: 8px; background: #ccc; cursor: pointer; border-radius: 4px; }
        .pagination-dot.active { background: #4a90e2; }

        /* Delete button in preview */
        .delete-btn {
            width: 24px; height: 24px; background: #d32f2f; color: #fff;
            border: none; border-radius: 12px; cursor: pointer;
            font-size: 16px; font-weight: 700;
        }
        .delete-btn:hover { background: #b71c1c; }

        /* Lightbox */
        .lightbox {
            position: fixed; inset: 0; z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        .lightbox-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); cursor: pointer; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; z-index: 10001; display: flex; flex-direction: column; align-items: center; }
        .lightbox-content img { max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; }
        .lightbox-info { margin-top: 16px; color: #fff; font-size: 14px; }
        .lightbox-close, .lightbox-nav {
            position: absolute; width: 40px; height: 40px;
            background: rgba(255,255,255,0.2); border: none; border-radius: 50%;
            color: #fff; font-size: 28px; cursor: pointer; z-index: 10002;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .lightbox-close { top: 20px; right: 20px; }
        .lightbox-close:hover, .lightbox-nav:hover { background: rgba(255,255,255,0.3); }
        .lightbox-nav { top: 50%; transform: translateY(-50%); }
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        .lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(253, 251, 255, 0.92);
            backdrop-filter: blur(10px); display: flex; align-items: center;
            justify-content: center; z-index: 9999;
        }
        .loading-content { background: #fff; border: 1px solid #e0e0e0; padding: 24px; text-align: center; min-width: 200px; border-radius: 8px; }
        .spinner { width: 36px; height: 36px; border: 3px solid rgba(248, 35, 135, 0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin: 0 auto 12px; }
        .loading-text { font-size: 14px; color: var(--accent); font-weight: 600; }
        .loading-subtext { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast {
            pointer-events: auto; min-width: 280px; max-width: 400px;
            padding: 12px 16px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease-out;
        }
        .toast.toast-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; border-left: 4px solid #34d399; }
        .toast.toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; border-left: 4px solid #f87171; }
        .toast.toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-left: 4px solid #60a5fa; }
        .toast-content { flex: 1; font-size: 14px; }
        .toast-close { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; padding: 0; opacity: 0.8; }
        .toast-close:hover { opacity: 1; }

        /* Status Message */
        .status-message {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; font-size: 14px; border-radius: 8px; z-index: 9999;
            display: flex; align-items: center; gap: 8px; animation: slideIn 0.2s ease;
        }
        .status-success { background: rgba(43, 201, 144, 0.95); color: #fff; }
        .status-error { background: rgba(255, 77, 109, 0.95); color: #fff; }
        .status-info { background: rgba(248, 35, 135, 0.95); color: #fff; }
        .status-close { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; margin-left: 8px; }

        /* Float Toggle */
        .log-toggle-float {
            position: fixed; right: 20px; bottom: 20px; width: 50px; height: 50px;
            background: linear-gradient(120deg, var(--accent), var(--accent-secondary));
            border: none; color: #fff; font-size: 20px; cursor: pointer; border-radius: 50%;
            box-shadow: 0 4px 16px rgba(248, 35, 135, 0.4);
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .log-toggle-float:hover { transform: scale(1.1); }
        .app-layout.log-hidden .log-toggle-float { display: flex !important; }

        .file-input { display: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Responsive */
        @media (max-width: 1400px) {
            .app-layout { grid-template-columns: 280px 1fr 350px; }
        }
        @media (max-width: 1200px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar-column { max-height: none; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .preview-panel { grid-template-columns: 1fr 1.5fr; }
            .preview-card.result-card { grid-row: 1 / -1; }
            .log-panel { position: relative; top: 0; max-height: 400px; margin-top: 16px; }
            .log-toggle-float { display: none !important; }
        }
        @media (max-width: 768px) {
            .main-container { padding: 12px; }
            .app-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .sidebar-column { grid-template-columns: 1fr; }
            .preview-panel { grid-template-columns: 1fr; }
            .preview-card.preset-card, .preview-card.selfie-card { min-height: 250px; }
            .preview-card.result-card { min-height: 400px; grid-row: auto; }
            .preview-card.result-card .preview-image { min-height: 350px; }
            .action-panel { flex-direction: column; align-items: stretch; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
            .results-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="access-gate" class="access-gate">
        <div class="gate-card">
            <div class="gate-title">Restricted Workspace</div>
            <div class="gate-subtitle">Nh·∫≠p m√£ truy c·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</div>
            <input type="password" id="access-input" class="gate-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autocapitalize="off" spellcheck="false">
            <button id="access-submit" class="gate-button">Unlock</button>
            <div id="access-error" class="gate-error"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="app-header">
            <h1>ƒê·ªïi M·∫∑t AI (Face Swap AI)</h1>
            <div class="header-controls">
                <div id="profile-section" style="display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 6px 12px; background: rgba(255,255,255,0.6); border: 1px solid rgba(131, 94, 255, 0.2); border-radius: 4px;">
                    <span style="color: var(--text-secondary);">H·ªì S∆° (Profile):</span>
                    <span id="profile-status" style="color: var(--text-muted);">ƒêang t·∫£i...</span>
                    <span id="profile-info" style="display: none;">
                        <span id="profile-id-display" style="font-family: monospace; color: var(--accent); font-size: 12px;"></span>
                    </span>
                    <input type="text" id="profile-id-input" placeholder="ID H·ªì S∆°" style="padding: 4px 8px; border: 1px solid rgba(131, 94, 255, 0.3); border-radius: 4px; background: rgba(255,255,255,0.8); font-size: 12px; font-family: monospace; width: 100px; height: 26px;">
                    <button id="switch-profile-btn" onclick="switchProfile()" style="padding: 4px 12px; background: var(--accent); color: #fff; border: none; cursor: pointer; font-size: 12px; height: 26px; font-weight: 600; border-radius: 13px;">Chuy·ªÉn (Switch)</button>
                </div>
                <select class="action-select" id="api-provider" style="height: 26px; padding: 0 8px; border-radius: 4px; border: 1px solid rgba(131, 94, 255, 0.3); background: #fff; font-size: 12px;">
                    <option value="google-nano-banana" selected>Google</option>
                    <option value="rapidapi">RapidAPI</option>
                </select>
                <button class="log-toggle-btn" onclick="toggleLogPanel()">Nh·∫≠t K√Ω (Log)</button>
            </div>
        </div>

        <div class="app-layout">
            <!-- Left Sidebar - Galleries -->
            <div class="sidebar-column">
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <div class="gallery-title-row">
                            <span>M·∫´u (Presets)</span>
                            <div class="gender-filter">
                                <button class="gender-filter-btn active" data-gender="" data-type="preset">T·∫•t C·∫£</button>
                                <button class="gender-filter-btn" data-gender="male" data-type="preset">Nam</button>
                                <button class="gender-filter-btn" data-gender="female" data-type="preset">N·ªØ</button>
                            </div>
                        </div>
                        <button class="gallery-upload-btn" onclick="document.getElementById('preset-input').click()">+</button>
                        <input type="file" class="file-input" id="preset-input" accept="image/*" multiple>
                    </div>
                    <div class="sidebar-content" id="preset-sidebar-content">
                        <div class="gallery-drop-zone" id="preset-drop-zone">
                            <div id="preset-gallery" class="sidebar-gallery"></div>
                        </div>
                        <div class="pagination" id="preset-pagination" style="display: none;">
                            <button class="pagination-btn" id="preset-prev" onclick="changePage('preset', -1)">‚óÄ</button>
                            <div class="pagination-dots" id="preset-dots"></div>
                            <button class="pagination-btn" id="preset-next" onclick="changePage('preset', 1)">‚ñ∂</button>
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <span>·∫¢nh T·ª± S∆∞·ªõng (Selfies)</span>
                        <button class="gallery-upload-btn" onclick="document.getElementById('selfie-input').click()">+</button>
                        <input type="file" class="file-input" id="selfie-input" accept="image/*">
                    </div>
                    <div class="sidebar-content" id="selfie-sidebar-content">
                        <div class="gallery-drop-zone" id="selfie-drop-zone">
                            <div id="selfie-gallery" class="sidebar-gallery"></div>
                        </div>
                        <div class="pagination" id="selfie-pagination" style="display: none;">
                            <button class="pagination-btn" id="selfie-prev" onclick="changePage('selfie', -1)">‚óÄ</button>
                            <div class="pagination-dots" id="selfie-dots"></div>
                            <button class="pagination-btn" id="selfie-next" onclick="changePage('selfie', 1)">‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content-area">
                <div class="preview-panel">
                    <div class="preview-left-column">
                        <div class="preview-card preset-card" id="preset-card">
                            <div class="preview-header">
                                <div class="preview-label">M·∫´u (Preset)</div>
                                <button class="delete-btn" onclick="clearSelection('preset', event)" style="display: none;" id="preset-clear-btn">√ó</button>
                            </div>
                            <div id="preset-preview" class="preview-image">
                                <div class="preview-empty">
                                    <div class="preview-empty-icon">üì∑</div>
                                    <div class="preview-empty-text">Ch·ªçn t·ª´ m·∫´u (Select from presets)</div>
                                </div>
                            </div>
                        </div>
                        <div class="preview-card selfie-card" id="selfie-card">
                            <div class="preview-header">
                                <div class="preview-label">·∫¢nh T·ª± S∆∞·ªõng (Selfie)</div>
                                <button class="delete-btn" onclick="clearSelection('selfie', event)" style="display: none;" id="selfie-clear-btn">√ó</button>
                            </div>
                            <div id="selfie-preview" class="preview-image">
                                <div class="preview-empty">
                                    <div class="preview-empty-icon">üì∑</div>
                                    <div class="preview-empty-text">Ch·ªçn t·ª´ ·∫£nh t·ª± s∆∞·ªõng (Select from selfies)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="preview-card result-card" id="result-card">
                        <div class="preview-header">
                            <div class="preview-label">K·∫øt Qu·∫£ (Result)</div>
                        </div>
                        <div id="result-preview" class="preview-image">
                            <div class="preview-empty">
                                <div class="preview-empty-icon">‚ú®</div>
                                <div class="preview-empty-text">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y (Result will appear here)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-panel">
                    <div class="action-buttons">
                        <button class="action-btn primary" id="generate-btn" disabled onclick="generateFaceSwap()">
                            <span>‚ú®</span><span>ƒê·ªïi M·∫∑t (Face Swap)</span>
                        </button>
                        <button class="action-btn" onclick="runEnhance()">üîç N√¢ng C·∫•p (Enhance)</button>
                        <button class="action-btn" onclick="runUpscale4k()">üìê N√¢ng C·∫•p 4K (4K Upscale)</button>
                        <button class="action-btn" onclick="runColorize()">üé® T√¥ M√†u (Colorize)</button>
                        <div class="action-aging">
                            <input type="number" id="aging-years" value="20" min="5" max="60" step="5">
                            <button class="action-btn" onclick="runAging()">‚è≥ L√£o H√≥a (Age)</button>
                        </div>
                    </div>
                    <div class="action-options">
                        <input type="text" id="additional-prompt" class="action-prompt" placeholder="G·ª£i √Ω (t√πy ch·ªçn) (Prompt optional)">
                        <div class="action-gender">
                            <label><input type="radio" name="character-gender" value="none" checked> Kh√¥ng</label>
                            <label><input type="radio" name="character-gender" value="male"> Nam</label>
                            <label><input type="radio" name="character-gender" value="female"> N·ªØ</label>
                        </div>
                    </div>
                </div>

                <div class="results-panel">
                    <div class="results-header">
                        <span>L·ªãch S·ª≠ (History)</span>
                        <span class="results-count" id="results-count">(0)</span>
                    </div>
                    <div id="results-gallery" class="results-grid"></div>
                    <div class="pagination" id="results-pagination" style="display: none;">
                        <button class="pagination-btn" id="results-prev" onclick="changePage('results', -1)">‚óÄ</button>
                        <div class="pagination-dots" id="results-dots"></div>
                        <button class="pagination-btn" id="results-next" onclick="changePage('results', 1)">‚ñ∂</button>
                    </div>
                </div>
            </div>

            <!-- Log Panel - Right Sidebar -->
            <div class="log-panel">
                <div class="log-header">
                    <div class="log-title">üìã Nh·∫≠t K√Ω API</div>
                    <button class="log-clear-btn" onclick="clearApiLogs()">X√≥a</button>
                    <button class="log-toggle-btn" onclick="toggleLogPanel()" title="·∫®n">‚óÄ</button>
                </div>
                <div class="api-log-list" id="api-log-list"></div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" style="display: none;">
        <div class="lightbox-overlay" onclick="closeLightbox()"></div>
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <button class="lightbox-nav lightbox-prev" onclick="lightboxNavigate(-1)">‚Äπ</button>
        <button class="lightbox-nav lightbox-next" onclick="lightboxNavigate(1)">‚Ä∫</button>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="">
            <div class="lightbox-info"><span id="lightbox-counter"></span></div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu</div>
            <div class="loading-subtext">Vui l√≤ng ch·ªù...</div>
        </div>
    </div>

    <button class="log-toggle-float" id="log-toggle-float" onclick="toggleLogPanel()" title="Hi·ªán Nh·∫≠t K√Ω">üìã</button>

    <script>
        // Config
        let WORKER_URL = 'https://api.d.shotpix.app';
        const ITEMS_PER_PAGE = 12;
        const ACCESS_CODE = '123456';
        const MAX_LOG_ENTRIES = 30;

        // DOM Elements
        const $ = id => document.getElementById(id);
        const presetInput = $('preset-input'), presetPreview = $('preset-preview'), presetGallery = $('preset-gallery');
        const selfieInput = $('selfie-input'), selfiePreview = $('selfie-preview'), selfieGallery = $('selfie-gallery');
        const resultsGallery = $('results-gallery'), generateBtn = $('generate-btn');
        const apiLogList = $('api-log-list'), additionalPromptInput = $('additional-prompt');
        const accessGate = $('access-gate'), accessInput = $('access-input'), accessSubmit = $('access-submit'), accessError = $('access-error');

        // Gallery Configuration
        const galleries = {
            preset: {
                key: 'preset', responseKey: 'presets', endpoints: { list: '/presets', delete: '/presets' },
                logName: 'Th∆∞ Vi·ªán M·∫´u', labels: { selectSuccess: 'ƒê√£ ch·ªçn m·∫´u th√†nh c√¥ng', deleteSuccess: 'ƒê√£ x√≥a m·∫´u th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·∫´u n√†y kh√¥ng?' },
                elements: { input: presetInput, preview: presetPreview, gallery: presetGallery, pagination: $('preset-pagination'), prevBtn: $('preset-prev'), nextBtn: $('preset-next') },
                state: { items: [], selected: null, page: 1, genderFilter: '' }
            },
            selfie: {
                key: 'selfie', responseKey: 'selfies', endpoints: { list: '/selfies', delete: '/selfies' },
                logName: 'Th∆∞ Vi·ªán Selfie', labels: { selectSuccess: 'ƒê√£ ch·ªçn selfie th√†nh c√¥ng', deleteSuccess: 'ƒê√£ x√≥a selfie th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a selfie n√†y kh√¥ng?' },
                elements: { input: selfieInput, preview: selfiePreview, gallery: selfieGallery, pagination: $('selfie-pagination'), prevBtn: $('selfie-prev'), nextBtn: $('selfie-next') },
                state: { items: [], selected: null, page: 1, genderFilter: '' }
            },
            results: {
                key: 'results', responseKey: 'results', endpoints: { list: '/results', delete: '/results' },
                logName: 'K·∫øt Qu·∫£ ƒê·ªïi M·∫∑t', labels: { deleteSuccess: 'ƒê√£ x√≥a k·∫øt qu·∫£ th√†nh c√¥ng', confirmDelete: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y kh√¥ng?' },
                elements: { gallery: resultsGallery, pagination: $('results-pagination'), prevBtn: $('results-prev'), nextBtn: $('results-next') },
                state: { items: [], selected: null, page: 1 }
            }
        };

        // Profile Manager
        window.profileManager = {
            currentProfile: null,
            async initializeProfile() {
                const statusDiv = $('profile-status');
                statusDiv.textContent = 'ƒêang t·∫£i...';
                try {
                    let profileId = localStorage.getItem('userProfileId');
                    if (profileId) {
                        const response = await fetch(`${WORKER_URL}/profiles/${profileId}`);
                        if (response.ok) {
                            this.currentProfile = await response.json();
                            this.updateProfileDisplay();
                            await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                            return this.currentProfile;
                        }
                        localStorage.removeItem('userProfileId');
                    }
                    const profile = await this.createProfile();
                    localStorage.setItem('userProfileId', profile.id);
                    this.currentProfile = profile;
                    this.updateProfileDisplay();
                    await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                    return profile;
                } catch (error) {
                    console.error('Profile init failed:', error);
                    statusDiv.textContent = '‚úó L·ªói';
                    statusDiv.style.color = 'var(--danger)';
                }
            },
            async createProfile() {
                const response = await fetch(`${WORKER_URL}/profiles`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫°o h·ªì s∆°');
                return response.json();
            },
            updateProfileDisplay() {
                const statusDiv = $('profile-status'), infoDiv = $('profile-info'), idSpan = $('profile-id-display');
                if (!this.currentProfile) { statusDiv.textContent = 'Ch∆∞a c√≥ h·ªì s∆°'; return; }
                statusDiv.textContent = '‚úì S·∫µn s√†ng';
                statusDiv.style.color = 'var(--success)';
                if (idSpan) idSpan.textContent = this.currentProfile.id;
                if (infoDiv) infoDiv.style.display = 'inline';
            },
            async switchToProfile(profileId) {
                if (!profileId?.trim()) { showStatusMessage('Vui l√≤ng nh·∫≠p ID h·ªì s∆°', 'error'); return; }
                const statusDiv = $('profile-status');
                statusDiv.textContent = 'ƒêang chuy·ªÉn...';
                try {
                    const response = await fetch(`${WORKER_URL}/profiles/${profileId.trim()}`);
                    if (!response.ok) throw new Error(response.status === 404 ? 'Kh√¥ng t√¨m th·∫•y h·ªì s∆°' : `HTTP ${response.status}`);
                    this.currentProfile = await response.json();
                    localStorage.setItem('userProfileId', this.currentProfile.id);
                    this.updateProfileDisplay();
                    await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                    updateResultsCount();
                    showStatusMessage('ƒê√£ chuy·ªÉn h·ªì s∆° th√†nh c√¥ng', 'success');
                } catch (error) {
                    statusDiv.textContent = '‚úó L·ªói';
                    statusDiv.style.color = 'var(--danger)';
                    showStatusMessage(`Chuy·ªÉn h·ªì s∆° th·∫•t b·∫°i: ${error.message}`, 'error');
                }
            }
        };

        function switchProfile() {
            const input = $('profile-id-input');
            if (input?.value.trim()) {
                window.profileManager.switchToProfile(input.value.trim());
                input.value = '';
            }
        }

        // Access Gate
        function unlockInterface() {
            document.body.classList.remove('locked');
            accessGate?.classList.add('hidden');
        }

        function handleAccessAttempt() {
            if (accessInput?.value.trim() === ACCESS_CODE) {
                sessionStorage.setItem('faceswap:authorized', 'true');
                if (accessError) accessError.textContent = '';
                unlockInterface();
            } else {
                if (accessError) accessError.textContent = 'M√£ sai, vui l√≤ng th·ª≠ l·∫°i';
                if (accessInput) { accessInput.value = ''; accessInput.focus(); }
            }
        }

        function initAccessGate() {
            if (sessionStorage.getItem('faceswap:authorized') === 'true') { unlockInterface(); return; }
            document.body.classList.add('locked');
            accessGate?.classList.remove('hidden');
            accessSubmit?.addEventListener('click', handleAccessAttempt);
            accessInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAccessAttempt(); } });
            setTimeout(() => accessInput?.focus(), 50);
        }

        // Logging
        function logApiCall({ label, method, url, status = 'info', payload, duration }) {
            if (!apiLogList || !['POST', 'PUT', 'DELETE'].includes((method || '').toUpperCase())) return;
            const entry = document.createElement('div');
            entry.className = `api-log-entry log-${status}`;
            const durationHtml = duration ? ` <span style="color:#666;font-size:11px;">‚è±Ô∏è${duration}ms</span>` : '';
            let payloadHtml = '';
            if (payload) {
                payloadHtml = `<div class="api-log-payload">${escapeHtml(JSON.stringify(payload, null, 2))}</div>`;
            }
            entry.innerHTML = `
                <div class="api-log-entry-header"><span>${new Date().toLocaleTimeString()}</span><span>${status}</span></div>
                <div class="api-log-action">${label}${durationHtml}</div>
                <div class="api-log-detail">${method} ${url}</div>
                ${payloadHtml}
            `;
            apiLogList.prepend(entry);
            while (apiLogList.childElementCount > MAX_LOG_ENTRIES) apiLogList.removeChild(apiLogList.lastElementChild);
        }

        function clearApiLogs() { if (apiLogList) apiLogList.innerHTML = ''; }

        function toggleLogPanel() {
            const appLayout = document.querySelector('.app-layout');
            const logPanel = document.querySelector('.log-panel');
            const isHidden = appLayout?.classList.contains('log-hidden');
            if (isHidden) {
                appLayout.classList.remove('log-hidden');
                if (logPanel) { logPanel.style.display = 'flex'; setTimeout(() => { logPanel.style.opacity = '1'; logPanel.style.transform = 'translateX(0)'; }, 10); }
            } else {
                if (logPanel) { logPanel.style.opacity = '0'; logPanel.style.transform = 'translateX(20px)'; }
                setTimeout(() => appLayout?.classList.add('log-hidden'), 300);
            }
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Gallery Functions
        async function loadGallery(type, genderFilter = '') {
            const config = galleries[type];
            try {
                if ((type === 'selfie' || type === 'results') && !window.profileManager?.currentProfile) {
                    config.state.items = []; config.state.page = 1; renderGallery(type); return;
                }
                let url = `${WORKER_URL}${config.endpoints.list}`;
                const params = new URLSearchParams();
                if ((type === 'selfie' || type === 'results') && window.profileManager.currentProfile) {
                    params.append('profile_id', window.profileManager.currentProfile.id);
                }
                if (type === 'preset' && ['male', 'female'].includes(genderFilter)) {
                    params.append('gender', genderFilter);
                }
                if (params.toString()) url += `?${params.toString()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                config.state.items = data[config.responseKey] || [];
                config.state.page = 1;
                config.state.genderFilter = genderFilter;
                renderGallery(type);
            } catch (error) {
                console.error(`Load ${type} error:`, error);
                config.state.items = []; config.state.page = 1; renderGallery(type);
            }
        }

        function renderGallery(type) {
            const config = galleries[type];
            const { items, page, selected } = config.state;
            const { gallery, pagination, prevBtn, nextBtn } = config.elements;
            if (!gallery) return;

            if (!items.length) {
                gallery.style.display = 'none';
                if (pagination) pagination.style.display = 'none';
                if (type === 'results') {
                    gallery.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o</div>';
                    gallery.style.display = 'block';
                }
                return;
            }

            gallery.style.display = 'grid';
            if (pagination) pagination.style.display = 'flex';

            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            config.state.page = Math.min(page, Math.max(1, totalPages));
            const startIndex = (config.state.page - 1) * ITEMS_PER_PAGE;
            const pageItems = items.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            if (type === 'results') {
                gallery.innerHTML = pageItems.map((item, index) => {
                    const globalIndex = startIndex + index;
                    return `<div class="gallery-item" data-item-id="${item.id}">
                        <img src="${item.result_url}" alt="" loading="lazy" onclick="openLightbox(${globalIndex}); displayResultInPreview('${item.result_url.replace(/'/g, "\\'")}');">
                        <button class="gallery-delete-btn" onclick="deleteItem('${type}', '${item.id}', event)">√ó</button>
                    </div>`;
                }).join('');
            } else {
                gallery.innerHTML = pageItems.map(item => {
                    const genderBadge = type === 'preset' && item.gender ?
                        `<div style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.7);color:#fff;padding:2px 6px;border-radius:10px;font-size:12px;">${item.gender === 'male' ? 'üë®' : 'üë©'}</div>` : '';
                    return `<div class="gallery-item ${selected?.id === item.id ? 'selected' : ''}" onclick="handleSelect('${type}', '${item.id}', event)" data-item-id="${item.id}">
                        <img src="${item.image_url}" alt="" loading="lazy">
                        ${genderBadge}
                        <button class="gallery-delete-btn" onclick="deleteItem('${type}', '${item.id}', event)">√ó</button>
                    </div>`;
                }).join('');
            }

            if (prevBtn) prevBtn.disabled = config.state.page === 1;
            if (nextBtn) nextBtn.disabled = config.state.page === totalPages;

            const dotsContainer = $(type + '-dots');
            if (dotsContainer && totalPages > 1) {
                dotsContainer.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'pagination-dot' + (i === config.state.page ? ' active' : '');
                    dot.onclick = () => { config.state.page = i; renderGallery(type); };
                    dotsContainer.appendChild(dot);
                }
            }

            if (type === 'results') updateResultsCount();
        }

        function changePage(type, delta) {
            const config = galleries[type];
            const totalPages = Math.ceil(config.state.items.length / ITEMS_PER_PAGE) || 1;
            const newPage = config.state.page + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                config.state.page = newPage;
                renderGallery(type);
            }
        }

        function handleSelect(type, itemId, event) {
            event?.stopPropagation();
            const config = galleries[type];
            const item = config.state.items.find(e => e.id === itemId);
            if (item) setSelectedItem(type, item, { showMessage: true });
        }

        function setSelectedItem(type, item, options = {}) {
            const config = galleries[type];
            config.state.selected = item || null;
            updatePreview(type);
            renderGallery(type);
            updateGenerateButton();
            if (options.showMessage && item) showStatusMessage(config.labels.selectSuccess, 'success');
        }

        function updatePreview(type) {
            const config = galleries[type];
            const { selected } = config.state;
            const preview = config.elements.preview;
            if (!preview) return;

            const clearBtn = $(type + '-clear-btn');
            if (!selected) {
                const emptyText = type === 'preset' ? 'Ch·ªçn t·ª´ m·∫´u (Select from presets)' : type === 'selfie' ? 'Ch·ªçn t·ª´ ·∫£nh t·ª± s∆∞·ªõng (Select from selfies)' : 'K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y (Result will appear here)';
                preview.innerHTML = `<div class="preview-empty"><div class="preview-empty-icon">${type === 'result' ? '‚ú®' : 'üì∑'}</div><div class="preview-empty-text">${emptyText}</div></div>`;
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }
            preview.innerHTML = `<img src="${selected.image_url}" alt="">`;
            if (clearBtn) clearBtn.style.display = 'block';
        }

        function updateGenerateButton() {
            if (generateBtn) generateBtn.disabled = !(galleries.preset.state.selected && galleries.selfie.state.selected);
        }

        function updateResultsCount() {
            const countEl = $('results-count');
            if (countEl) countEl.textContent = `(${galleries.results?.state?.items?.length || 0})`;
        }

        function clearSelection(type, event) {
            event?.stopPropagation();
            const config = galleries[type];
            config.state.selected = null;
            updatePreview(type);
            renderGallery(type);
            updateGenerateButton();
        }

        async function deleteItem(type, itemId, event) {
            event?.stopPropagation();
            const config = galleries[type];
            if (!confirm(config.labels.confirmDelete)) return;

            try {
                const response = await fetch(`${WORKER_URL}${config.endpoints.delete}/${itemId}`, { method: 'DELETE' });
                const data = await response.json();
                logApiCall({ label: `X√≥a ${config.logName}`, method: 'DELETE', url: `${config.endpoints.delete}/${itemId}`, status: response.ok ? 'success' : 'error', payload: data });
                if (!response.ok) throw new Error(data.message || 'X√≥a th·∫•t b·∫°i');

                config.state.items = config.state.items.filter(item => item.id !== itemId);
                const totalPages = Math.ceil(config.state.items.length / ITEMS_PER_PAGE) || 1;
                config.state.page = Math.min(config.state.page, totalPages);
                if (config.state.selected?.id === itemId) { config.state.selected = null; updatePreview(type); }
                renderGallery(type);
                updateGenerateButton();
                showStatusMessage(config.labels.deleteSuccess, 'success');
            } catch (error) {
                showStatusMessage('X√≥a th·∫•t b·∫°i', 'error');
            }
        }

        // Upload
        presetInput?.addEventListener('change', async e => {
            for (const file of Array.from(e.target.files || [])) await handleImageUpload(file, 'preset');
            e.target.value = '';
        });

        selfieInput?.addEventListener('change', async e => {
            if (e.target.files[0]) await handleImageUpload(e.target.files[0], 'selfie');
            e.target.value = '';
        });

        function setupDragDrop(type) {
            const dropZone = $(type + '-drop-zone');
            if (!dropZone) return;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
            dropZone.addEventListener('drop', async e => {
                const files = type === 'preset' ? Array.from(e.dataTransfer.files) : [e.dataTransfer.files[0]];
                for (const file of files.filter(f => f?.type.match('image/(jpeg|jpg|png|webp)'))) await handleImageUpload(file, type);
            }, false);
        }

        async function handleImageUpload(file, type) {
            const config = galleries[type];
            if (!window.profileManager.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫£i l√™n h√¨nh ·∫£nh.', 'error'); return; }
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) { showStatusMessage('Lo·∫°i t·ªáp kh√¥ng h·ª£p l·ªá. Vui l√≤ng t·∫£i l√™n JPG, PNG ho·∫∑c WebP.', 'error'); return; }
            if (file.size > 10 * 1024 * 1024) { showStatusMessage('T·ªáp v∆∞·ª£t qu√° gi·ªõi h·∫°n 10MB. Vui l√≤ng ch·ªçn t·ªáp nh·ªè h∆°n.', 'error'); return; }

            const dropZone = $(type + '-drop-zone');
            dropZone?.classList.add('loading');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', type);
                formData.append('profile_id', window.profileManager.currentProfile.id);

                const response = await fetch(`${WORKER_URL}/upload-url`, { method: 'POST', body: formData });
                const data = await response.json();

                logApiCall({ label: `T·∫£i L√™n ${config.logName}`, method: 'POST', url: '/upload-url', status: response.ok ? 'success' : 'error', payload: data });
                if (!response.ok) throw new Error(data.message || 'T·∫£i l√™n th·∫•t b·∫°i');

                const newImage = { id: data.id, filename: data.filename, image_url: data.url, created_at: new Date().toISOString() };
                config.state.items = [newImage, ...config.state.items.filter(e => e.id !== newImage.id)];
                config.state.page = 1;
                await loadGallery(type, config.state.genderFilter);
                setSelectedItem(type, newImage);
                showStatusMessage('T·∫£i l√™n h√¨nh ·∫£nh th√†nh c√¥ng', 'success');
            } catch (error) {
                showStatusMessage(`T·∫£i l√™n th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                dropZone?.classList.remove('loading');
            }
        }

        // Face Swap & Operations
        async function generateFaceSwap() {
            const presetSelected = galleries.preset.state.selected;
            const selfieSelected = galleries.selfie.state.selected;
            if (!presetSelected || !selfieSelected) { showStatusMessage('Vui l√≤ng ch·ªçn c·∫£ m·∫´u v√† selfie tr∆∞·ªõc khi t·∫°o ƒë·ªïi m·∫∑t.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('Vui l√≤ng ch·ªçn h·ªì s∆° tr∆∞·ªõc khi t·∫°o ƒë·ªïi m·∫∑t.', 'error'); return; }

            generateBtn.disabled = true;
            generateBtn.classList.add('loading');

            try {
                const genderRadio = document.querySelector('input[name="character-gender"]:checked');
                const requestBody = {
                    preset_image_id: presetSelected.id,
                    selfie_ids: [selfieSelected.id],
                    profile_id: window.profileManager.currentProfile.id,
                    additional_prompt: additionalPromptInput?.value.trim() || '',
                    character_gender: genderRadio?.value === 'none' ? '' : (genderRadio?.value || '')
                };

                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/faceswap`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label: 'T·∫°o ƒê·ªïi M·∫∑t', method: 'POST', url: '/faceswap', status: response.ok ? 'success' : 'error', payload: data, duration });
                if (!response.ok || !data.data?.resultImageUrl) throw new Error(data.message || 'ƒê·ªïi m·∫∑t th·∫•t b·∫°i');

                const newResult = { id: data.data.id || `result-${Date.now()}`, result_url: data.data.resultImageUrl, image_url: data.data.resultImageUrl, created_at: new Date().toISOString() };
                galleries.results.state.items = [newResult, ...galleries.results.state.items];
                await loadGallery('results');
                displayResultInPreview(newResult.image_url);
                showStatusMessage('T·∫°o ƒë·ªïi m·∫∑t th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatusMessage(`T·∫°o ƒë·ªïi m·∫∑t th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('loading');
                updateGenerateButton();
            }
        }

        async function runImageOperation(label, endpoint, extra = {}) {
            const selfieSelected = galleries.selfie.state.selected;
            if (!selfieSelected) { showStatusMessage('Ch·ªçn selfie ƒë·ªÉ ch·∫°y API.', 'error'); return; }
            if (!window.profileManager?.currentProfile) { showStatusMessage('H·ªì s∆° ch∆∞a s·∫µn s√†ng.', 'error'); return; }

            showLoading(label);
            try {
                const payload = { image_url: selfieSelected.image_url, profile_id: window.profileManager.currentProfile.id, ...extra };
                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                const duration = Date.now() - startTime;

                logApiCall({ label, method: 'POST', url: `/${endpoint}`, status: response.ok ? 'success' : 'error', payload: data, duration });
                if (!response.ok || !data?.data?.resultImageUrl) throw new Error(data.message || `${label} th·∫•t b·∫°i`);

                const newResult = { id: data.data.id, result_url: data.data.resultImageUrl, image_url: data.data.resultImageUrl, created_at: new Date().toISOString() };
                galleries.results.state.items = [newResult, ...galleries.results.state.items];
                renderGallery('results');
                displayResultInPreview(newResult.image_url);
                showStatusMessage(`${label} th√†nh c√¥ng`, 'success');
                await loadGallery('results');
            } catch (error) {
                showStatusMessage(`${label} th·∫•t b·∫°i: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function runEnhance() { runImageOperation('N√¢ng C·∫•p (Enhance)', 'enhance'); }
        function runUpscale4k() { runImageOperation('N√¢ng C·∫•p 4K (4K Upscale)', 'upscaler4k'); }
        function runColorize() { runImageOperation('T√¥ M√†u (Colorize)', 'colorize'); }
        function runAging() { runImageOperation('L√£o H√≥a (Aging)', 'aging', { age_years: parseInt($('aging-years')?.value || '20', 10) }); }

        function displayResultInPreview(imageUrl) {
            const resultPreview = $('result-preview');
            if (resultPreview && imageUrl) {
                resultPreview.innerHTML = `<img src="${imageUrl}" alt="Result">`;
            }
        }

        // Lightbox
        let lightboxCurrentIndex = -1, lightboxItems = [];

        function openLightbox(index) {
            lightboxItems = galleries.results.state.items;
            if (index >= 0 && index < lightboxItems.length) {
                lightboxCurrentIndex = index;
                updateLightbox();
            }
        }

        function closeLightbox() {
            $('lightbox').style.display = 'none';
            lightboxCurrentIndex = -1;
            lightboxItems = [];
        }

        function lightboxNavigate(delta) {
            if (lightboxItems.length) {
                lightboxCurrentIndex = (lightboxCurrentIndex + delta + lightboxItems.length) % lightboxItems.length;
                updateLightbox();
            }
        }

        function updateLightbox() {
            const lightbox = $('lightbox'), img = $('lightbox-image'), counter = $('lightbox-counter');
            if (!lightbox || lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxItems.length) return;
            const item = lightboxItems[lightboxCurrentIndex];
            img.src = item.result_url || item.image_url || '';
            if (counter) counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxItems.length}`;
            document.querySelector('.lightbox-prev').disabled = lightboxItems.length <= 1;
            document.querySelector('.lightbox-next').disabled = lightboxItems.length <= 1;
            lightbox.style.display = 'flex';
        }

        // UI Helpers
        function showLoading(text = 'ƒêang t·∫£i d·ªØ li·ªáu') {
            const overlay = $('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
                const textEl = overlay.querySelector('.loading-text');
                if (textEl) textEl.textContent = text;
            }
        }

        function hideLoading() {
            const overlay = $('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        function showStatusMessage(message, type = 'info') {
            document.querySelectorAll('.status-message').forEach(m => m.remove());
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.innerHTML = `${message}<button class="status-close" onclick="this.parentElement.remove()">√ó</button>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // Gender Filter
        function setupGenderFilterListeners() {
            document.querySelectorAll('.gender-filter-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const gender = e.target.dataset.gender || '';
                    const type = e.target.dataset.type;
                    if (!type) return;
                    const container = e.target.closest('.gender-filter');
                    container?.querySelectorAll('.gender-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadGallery(type, gender);
                });
            });
        }

        // Initialize
        async function init() {
            showLoading('ƒêang t·∫£i d·ªØ li·ªáu');
            try {
                await loadGallery('preset');
                if (window.profileManager?.currentProfile) {
                    await Promise.all([loadGallery('selfie'), loadGallery('results')]);
                }
                updateResultsCount();
            } finally {
                hideLoading();
            }
        }

        // Startup
        document.addEventListener('DOMContentLoaded', async () => {
            initAccessGate();
            setupGenderFilterListeners();
            setupDragDrop('preset');
            setupDragDrop('selfie');

            $('profile-id-input')?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); switchProfile(); } });

            window.profileManager.initializeProfile();
            await init();
        });
    </script>
</body>
</html>
